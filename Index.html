<!doctype html>
<html lang="ht">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Echanj Plus ‚Äî S√®vis Rapid</title>
  <link rel="icon" href="https://i.postimg.cc/0QrPXhKk/image1.png" />
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estil Custom: Pou yon konsepsyon pi pwofesyon√®l */
    body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    /* Konte style pou background f√≤, nwa, ak j√≤n */
    .auth-card { 
        background: #1e293b; /* Slate-800 f√®nwa */
        border: 1px solid #334155; /* Slate-700 */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2); 
    }
    /* Estil pou chwa Operator */
    .operator-select:checked + label {
        background-color: #f59e0b !important; /* Jon pi f√≤ (amber-500) */
        color: #111827 !important; /* Griy pi f√®nwa */
        border-color: #f59e0b !important;
    }
    .auth-input {
      /* Tailwinds CSS aplike nan chak input/select */
      @apply w-full p-3 rounded-lg bg-slate-700 border border-slate-600 placeholder-slate-400 text-white shadow-inner focus:ring-amber-500 focus:border-amber-500 transition duration-300;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-900 to-slate-800 text-slate-100 min-h-screen flex items-center justify-center">

<div id="root" class="w-full max-w-sm mx-auto flex flex-col p-4">

  <header class="flex flex-col items-center gap-2 mb-6">
    <img src="https://i.postimg.cc/0QrPXhKk/image1.png" class="w-16 h-16 rounded-full border-4 border-amber-500 shadow-xl" alt="Echanj Plus Logo">
    <div class="text-center">
      <div class="text-2xl font-extrabold text-white">ECHANJ PLUS</div>
      <div class="text-sm text-slate-400">Platf√≤m Echanj Minit ak Lajan an Ayiti</div>
    </div>
  </header>
  
  <div class="bg-amber-500 text-slate-900 text-sm py-2 px-4 mb-6 rounded shadow-lg font-bold">
    Anons: Sist√®m Vann Minit la pi otomatik!
  </div>

  <main class="flex-1">
    <section id="authCard" class="auth-card rounded-xl p-6">
        <div class="flex items-center gap-3 mb-5">
            <img src="https://i.postimg.cc/0QrPXhKk/image1.png" class="w-8 h-8 rounded-full" alt="logo">
            <div>
                <div id="authTitle" class="text-xl font-bold text-amber-300">Kreye Kont</div>
                <div class="text-sm text-slate-400">Ranpli tout enf√≤masyon yo pou w antre.</div>
            </div>
        </div>
        
        <div id="signUpForm" class="space-y-4">
            <form id="formSignUp" class="space-y-4">
                <input id="authNom" type="text" placeholder="Non & Prenon" class="auth-input" required />
                
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-xs text-slate-400 block mb-1">Operat√® (Lajan)</label>
                        <div class="flex gap-2">
                            <input type="radio" id="opDigi" name="op_type" value="Digicel" class="hidden operator-select" required>
                            <label for="opDigi" class="flex-1 text-center py-2 rounded-lg border border-slate-600 cursor-pointer text-red-400 font-semibold transition duration-200">Digicel</label>
                            <input type="radio" id="opNatcom" name="op_type" value="Natcom" class="hidden operator-select">
                            <label for="opNatcom" class="flex-1 text-center py-2 rounded-lg border border-slate-600 cursor-pointer text-blue-400 font-semibold transition duration-200">Natcom</label>
                        </div>
                    </div>
                    <input id="authPhone" type="tel" placeholder="Nimewo MonCash/NatCash (509...)" class="auth-input w-1/2 mt-3" required />
                </div>

                <div class="flex gap-2">
                    <select id="authNasyonalite" class="auth-input flex-1" required>
                        <option value="Haiti" selected>üá≠üáπ Ayiti</option>
                    </select>
                    <select id="authDepatman" class="auth-input flex-1" required>
                        <option value="">Depatman</option>
                    </select>
                </div>
                <select id="authKomin" class="auth-input" required>
                    <option value="">Komin</option>
                </select>

                <input id="authReferralCode" type="text" placeholder="K√≤d Referral (Si ou genyen)" class="auth-input" />
                <input id="authEmail" type="email" placeholder="Im√®l (Gmail)" class="auth-input" required />
                <input id="authPass" type="password" placeholder="Modpas (min 6 chif)" class="auth-input" required />
                
                <button id="btnSignUp" type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-extrabold py-3 rounded-lg shadow-xl shadow-amber-900/50 transition duration-300 transform hover:scale-[1.01]">
                    Kreye Kont
                </button>
            </form>

            <button id="btnGotoSignIn" type="button" class="w-full text-sm border border-slate-600 rounded-lg py-2 text-amber-300 hover:bg-slate-700 transition duration-200">
                Mwen gen yon Kont. Konekte >
            </button>

            <div class="flex items-center gap-3 my-2">
                <div class="flex-1 h-px bg-slate-700"></div>
                <div class="text-sm text-slate-400">OSWA</div>
                <div class="flex-1 h-px bg-slate-700"></div>
            </div>

            <button id="btnGoogleSignUp" class="w-full py-2 rounded-lg bg-white hover:bg-gray-100 text-slate-900 flex items-center justify-center gap-2 font-semibold shadow-md transition duration-200">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> Enskri ak Google
            </button>
        </div>

        <div id="signInForm" class="hidden space-y-4">
            <form id="formSignIn" class="space-y-4">
                <input id="signInEmail" type="email" placeholder="Im√®l (Gmail)" class="auth-input" required />
                <input id="signInPass" type="password" placeholder="Modpas" class="auth-input" required />
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="acceptTerms" class="form-checkbox h-4 w-4 text-amber-500 bg-slate-700 border-slate-600 rounded transition duration-200" required>
                    <label for="acceptTerms" class="text-sm text-slate-400">Mwen <a href="#" class="text-amber-400 underline hover:text-amber-300">aksepte kondisyon yo</a></label>
                </div>

                <button id="btnSignIn" type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-extrabold py-3 rounded-lg shadow-xl shadow-amber-900/50 transition duration-300 transform hover:scale-[1.01]">
                    Konekte
                </button>
            </form>

            <button id="btnGotoSignUp" type="button" class="w-full text-sm border border-slate-600 rounded-lg py-2 text-amber-300 hover:bg-slate-700 transition duration-200">
                Ou pa gen Kont? Kreye youn >
            </button>

            <div class="flex items-center gap-3 my-2">
                <div class="flex-1 h-px bg-slate-700"></div>
                <div class="text-sm text-slate-400">OSWA</div>
                <div class="flex-1 h-px bg-slate-700"></div>
            </div>

            <button id="btnGoogleSignIn" class="w-full py-2 rounded-lg bg-white hover:bg-gray-100 text-slate-900 flex items-center justify-center gap-2 font-semibold shadow-md transition duration-200">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"/> Konekte ak Google
            </button>
        </div>
    </section>
  </main>

</div>

<script type="module">
  // ===========================================
  // üöÄ K√íD JAVASCRIPT AK KOREKSYON LOJIK YO
  // ===========================================
  
  // --- KONFIGURASYON DE BAZ ---
  const API_URL = "https://script.google.com/macros/s/AKfycbxohg_Km0hTiNLkqHaBUCHqsqvbIGWtMVqaK2eCZh1zJokmwbxnbpjFOD15NcuzwXLMZQ/exec";
  
  // --- DONE JENERAL AYITI ---
  const DEPARTMENTS = {
    'Nord-Ouest': ['Port-de-Paix', 'Saint-Louis-du-Nord', 'Borgne'],
    'Nord': ['Cap-Ha√Øtien', 'Limb√©', 'Grande-Rivi√®re-du-Nord', 'Acul-du-Nord'],
    'Nord-Est': ['Fort-Libert√©', 'Ouanaminthe', 'Trou-du-Nord', 'Valli√®res'],
    'Artibonite': ['Gona√Øves', 'Saint-Marc', 'Dessalines', 'Verrettes'],
    'Centre': ['Mirebalais', 'Hinche', 'Lascahobas', 'Saut-d‚ÄôEau'],
    'Ouest': ['Port-au-Prince', 'Carrefour', 'P√©tion-Ville', 'L√©og√¢ne', 'Croix-des-Bouquets', 'Delmas', 'Tabarre'],
    'Sud-Est': ['Jacmel', 'Bainet', 'Marigot', 'Cayes-Jacmel'],
    'Sud': ['Les Cayes', 'Aquin', 'Port-Salut', 'Cavaillon'],
    'Grande-Anse': ['J√©r√©mie', 'Corail', 'Dame-Marie', 'Anse-d\'Hainault'],
    'Nippes': ['Mirago√¢ne', 'Anse-√†-Veau', 'Barad√®res', 'Petit-Trou-de-Nippes']
  };

  // --- FIREBASE IMPORT AK INIT ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    GoogleAuthProvider, signInWithPopup
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Konfigirasyon Firebase (K√≤d ou a)
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.firebasestorage.app",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app); 
  const gProvider = new GoogleAuthProvider();
  setPersistence(auth, browserLocalPersistence).catch(e => console.warn('persistence:', e.message));


  // --- REFERANS ELEMAN UI ---
  const openAuthBtn = document.getElementById('openAuthBtn');
  const authTitle = document.getElementById('authTitle');
  const signUpForm = document.getElementById('signUpForm');
  const signInForm = document.getElementById('signInForm');
  const btnGotoSignIn = document.getElementById('btnGotoSignIn');
  const btnGotoSignUp = document.getElementById('btnGotoSignUp');
  const formSignUp = document.getElementById('formSignUp');
  const formSignIn = document.getElementById('formSignIn');
  const btnGoogleSignUp = document.getElementById('btnGoogleSignUp');
  const btnGoogleSignIn = document.getElementById('btnGoogleSignIn');
  const authDepatman = document.getElementById('authDepatman');
  const authKomin = document.getElementById('authKomin');
  // ... (r√®s input yo nan formSignUp/formSignIn)

  // --- FUNKSYON API POST ---
  async function apiPost(body){
    // ... (lojik apiPost)
    try{
      const r = await fetch(API_URL, { 
        method:'POST', 
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(body) 
      });
      if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
      const text = await r.text();
      try { return JSON.parse(text); } 
      catch (e) { return { status: 'error', message: 'Repons API a pa k√≤r√®k.', raw: text }; }
    }catch(e){ 
      return { status:'error', message: 'Koneksyon echwe. Tanpri eseye ank√≤.' }; 
    }
  }

  // --- LOGIK NAVIGASYON (KOREKSYON) ---

  function showSignIn() {
      authTitle.innerText = 'Konekte sou Kont ou';
      signUpForm.classList.add('hidden');
      signInForm.classList.remove('hidden');
  }

  function showSignUp() {
      authTitle.innerText = 'Kreye Kont';
      signInForm.classList.add('hidden');
      signUpForm.classList.remove('hidden');
  }

  // KOREKSYON: Bouton yo dwe rele fonksyon yo san pwobl√®m
  btnGotoSignIn.addEventListener('click', showSignIn); 
  btnGotoSignUp.addEventListener('click', showSignUp);

  // Bouton Konekte nan Header la
  openAuthBtn.addEventListener('click', showSignIn);

  // --- POPULATE DEPARTMENTS/COMMUNES ---
  function populateDepartments() {
      Object.keys(DEPARTMENTS).forEach(dep => {
          const option = document.createElement('option');
          option.value = dep;
          option.textContent = dep;
          authDepatman.appendChild(option);
      });
  }

  function populateCommunes(department) {
      authKomin.innerHTML = '<option value="">Komin</option>';
      if (department && DEPARTMENTS[department]) {
          DEPARTMENTS[department].forEach(com => {
              const option = document.createElement('option');
              option.value = com;
              option.textContent = com;
              authKomin.appendChild(option);
          });
      }
  }

  authDepatman.addEventListener('change', (e) => {
      populateCommunes(e.target.value);
  });
  
  populateDepartments(); 
  showSignUp(); 

  // --- HANDLERS FIREBASE (TESTE AK KOREJI) ---
  
  // 1. LOGIN (Sign In) Handler
  formSignIn.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signInEmail').value.trim();
    const pass = document.getElementById('signInPass').value;
    if(!email || !pass) return alert('Antre im√®l epi modpas.');
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      alert('Koneksyon Reyisi! Redireksyon sou Ak√®y...'); 
    }catch(err){ 
      alert('Login echwe: '+err.message); 
    }
  });
  
  // 2. SIGN UP (Create Account) Handler
  formSignUp.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('authEmail').value.trim();
    const pass = document.getElementById('authPass').value;
    const nom = document.getElementById('authNom').value.trim();
    const numero = document.getElementById('authPhone').value.trim();
    const referral_code = document.getElementById('authReferralCode').value.trim();
    const depatman = authDepatman.value; 
    const komin = authKomin.value; 
    const type_compte = document.querySelector('input[name="op_type"]:checked')?.value;

    if(!email || !pass || !numero || !type_compte || !depatman || !komin || !nom) {
      return alert('Tanpri ranpli tout enf√≤masyon ki obligatwa yo.');
    }

    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      const res = await apiPost({ 
        action:'register_user', nom, email, numero, type_compte, referral_code, depatman, komin 
      });

      if (res && res.status === 'success') {
          alert('Kont kreye av√®k siks√®! Konekte kounye a.');
          showSignIn(); 
      } else {
           alert('Kont kreye nan Firebase, men er√® sove nan sist√®m nan: ' + res.message);
      }

    }catch(err){ alert('Signup echwe: '+err.message); }
  });

  // 3. Google Sign In & Sign Up Handlers
  const handleGoogleAuth = async () => {
      try{ await signInWithPopup(auth, gProvider); }
      catch(err){ alert('Google Auth echwe: '+err.message); }
  };
  
  btnGoogleSignIn.addEventListener('click', handleGoogleAuth);
  btnGoogleSignUp.addEventListener('click', handleGoogleAuth);

</script>
</body>
</html>
