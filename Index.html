<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ECHANJ PLUS</title>

<!-- Google font "Italiana" (free serif-like) as "Italie" -->
<link href="https://fonts.googleapis.com/css2?family=Italiana&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-dark:#0D1B2A; --bg-light:#F6F8FB;
    --card: rgba(255,255,255,0.04);
    --accent:#FFD700; --muted:#9fb8d9; --line: rgba(255,255,255,0.18);
    --text-dark:#061022; --text-light:#fff;
  }
  /* Basic reset */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg-dark);
    color:var(--text-light);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ---------- SPLASH ---------- */
  #splash{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:var(--bg-dark); z-index:9999; transition:opacity .4s ease;
  }
  #splash h1{
    font-family:'Italiana', serif;
    font-size:56px; color:var(--accent); letter-spacing:1px; margin-bottom:18px;
    text-shadow:0 3px 18px rgba(0,0,0,0.6);
  }
  #splash img{width:140px; max-width:38vw; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.6)}

  /* ---------- APP LAYOUT ---------- */
  #app{display:none; min-height:100vh; padding:18px; position:relative;}
  .center{max-width:980px;margin:0 auto}
  .card{background:var(--card); border-radius:14px; padding:16px; border:1px solid rgba(255,255,255,0.05); backdrop-filter: blur(6px); margin-bottom:12px;}
  .muted{color:var(--muted); font-size:13px;}
  input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit}
  button.btn{padding:10px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
  button.primary{background:var(--accent);color:#000}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12);color:inherit}

  .row{display:flex;gap:8px}
  .small{width:33%}

  /* ---------- SIDEBAR ---------- */
  #drawer{
    position:fixed; top:0; left:-320px; width:300px; height:100vh; padding:16px;
    background: rgba(6,10,20,0.97); z-index:1400; transition:left .28s ease; overflow:auto;
  }
  #drawer.open{left:0}
  #drawer .title{font-family:'Italiana', serif; font-size:24px; color:var(--accent); margin-bottom:10px}
  #drawer .item{padding:10px;border-radius:8px;margin-bottom:6px;cursor:pointer}
  #drawer .item:hover{background:rgba(255,255,255,0.03)}
  #drawer .lang select{width:100%; padding:8px; border-radius:8px}

  /* ---------- FLOAT MENU ---------- */
  #dots{position:fixed; top:16px; right:16px; z-index:1500}
  #dots button{padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08); color:inherit}

  /* ---------- PANELS ---------- */
  .panel{display:none}
  .panel.active{display:block}

  /* ---------- BOTTOM NAV ---------- */
  .bottom-nav{
    position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:space-around; align-items:center;
    padding:10px 6px; background: rgba(6,10,20,0.72); backdrop-filter: blur(10px); border-top:1px solid rgba(255,255,255,0.04);
    z-index:1200;
  }
  .bn-item{flex:1; text-align:center; color:#cfe6ff; font-weight:700}
  .bn-item.active{color:#000}
  .bn-pill{background:var(--accent); color:#000; padding:10px 20px; border-radius:999px}

  /* ---------- TOAST ---------- */
  #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:82px; padding:10px 14px; background:var(--accent); color:#000; border-radius:8px; display:none; z-index:2000}

  /* ---------- LIGHT THEME (luminosit√©) ---------- */
  body[data-theme="light"]{
    background:var(--bg-light); color:var(--text-dark);
  }
  body[data-theme="light"] .card{ background:rgba(10,14,20,0.03); color:var(--text-dark) }
  body[data-theme="light"] input,select,textarea{ background:#fff; color:var(--text-dark); border:1px solid rgba(0,0,0,0.08) }

  /* Responsive */
  @media (max-width:820px){
    #splash h1{font-size:40px}
    #drawer{width:85vw}
  }
</style>
</head>
<body>

<!-- SPLASH (1.5s) - shows ECHANJ PLUS big + Haiti flag -->
<div id="splash" aria-hidden="false">
  <h1>ECHANJ PLUS</h1>
  <!-- public SVG flag URL -->
  <img alt="Drapo Ayiti" src="https://upload.wikimedia.org/wikipedia/commons/5/56/Flag_of_Haiti.svg" />
</div>

<!-- loader overlay for async ops -->
<div id="loader" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index:2000">
  <div style="background:#fff;padding:12px 18px;border-radius:10px;color:#000;font-weight:800">Ap prepare aplikasyon an...</div>
</div>

<!-- floating dots (open sidebar) -->
<div id="dots" style="display:none"><button id="btnDots">‚ò∞</button></div>

<!-- sidebar drawer -->
<aside id="drawer" aria-label="Sidebar">
  <div class="title">ECHANJ PLUS</div>
  <div class="item" data-goto="Home">üè† Akey</div>
  <div class="item" data-goto="Send">üì§ Voye Minit</div>
  <div class="item" data-goto="Pay">üí≥ Peman</div>
  <div class="item" data-goto="Profile">üë§ Profil</div>
  <div class="item" data-goto="Parrainage">üéÅ Parrainaj</div>
  <div class="item" data-goto="About">‚ÑπÔ∏è About</div>
  <div class="sep" style="height:1px;background:rgba(255,255,255,0.06);margin:10px 0"></div>

  <div class="lang">
    <div class="muted">Chwazi Lang</div>
    <select id="langSel">
      <option value="ht" selected>Krey√≤l</option>
      <option value="fr">Fran√ßais</option>
      <option value="en">English</option>
      <option value="es">Espa√±ol</option>
      <option value="pt">Portugu√™s</option>
    </select>
  </div>

  <div style="margin-top:12px">
    <div class="muted">Luminosit√©</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="themeBlue" class="btn ghost">üîÖ Ble</button>
      <button id="themeLight" class="btn ghost">üîÜ Blan</button>
    </div>
  </div>

  <div style="margin-top:14px">
    <div id="appVer" class="muted">V√®syon: 1.0.0</div>
  </div>
</aside>

<!-- MAIN APP -->
<div id="app" class="center" style="max-width:980px;margin:16px auto">

  <!-- AUTH area (login + signup) -->
  <div id="auth" style="display:flex;gap:20px;flex-wrap:wrap;justify-content:center">
    <!-- Sign Up -->
    <div class="card" style="width:380px" id="signupCard">
      <h2 style="color:var(--accent);font-family:'Italiana',serif;margin-bottom:8px">Kreye Kont</h2>
      <input id="su_name" placeholder="Non konpl√®" />
      <input id="su_email" placeholder="Im√®l" />
      <input id="su_phone" placeholder="Telef√≤n (+509XXXXXXXX)" />
      <input id="su_referral" placeholder="Kod parennaj (opsyon√®l)" />
      <div class="row">
        <input id="su_day" class="small" placeholder="JJ" />
        <input id="su_month" class="small" placeholder="MM" />
        <input id="su_year" class="small" placeholder="AAAA" />
      </div>
      <input id="su_pass" type="password" placeholder="Modpas" />
      <label class="muted"><input id="su_terms" type="checkbox" /> Mwen aksepte <span id="openTerms" style="text-decoration:underline;cursor:pointer">Kondisyon Sist√®m</span></label>
      <button class="btn primary" id="btnSignup" disabled>Kreye kont</button>
      <div style="height:10px"></div>
      <div style="display:flex;gap:8px">
        <button id="btnGoogle" class="btn ghost" style="flex:1">Google</button>
        <button id="btnPhone" class="btn ghost" style="flex:1">Phone</button>
      </div>
      <div style="text-align:center;margin-top:8px" class="muted">Ou deja gen kont? <span id="toLogin" style="text-decoration:underline;cursor:pointer">Konekte</span></div>
    </div>

    <!-- Login -->
    <div class="card" style="width:380px;display:none" id="loginCard">
      <h2 style="color:var(--accent);font-family:'Italiana',serif;margin-bottom:8px">Konekte</h2>
      <input id="li_email" placeholder="Im√®l oswa +509XXXXXXXX" />
      <input id="li_pass" type="password" placeholder="Modpas" />
      <label class="muted"><input id="li_accept" type="checkbox" /> Mwen aksepte Kondisyon Sist√®m</label>
      <button class="btn primary" id="btnLogin">Konekte</button>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="btnGoogleIn" class="btn ghost" style="flex:1">Google</button>
        <button id="btnPhoneIn" class="btn ghost" style="flex:1">Phone</button>
      </div>
      <div style="text-align:center;margin-top:8px">
        <button id="btnResetPwd" class="btn ghost">Reset Modpas</button>
      </div>
      <div style="text-align:center;margin-top:8px" class="muted">Pa gen kont? <span id="toSignup" style="text-decoration:underline;cursor:pointer">Enskri</span></div>
    </div>
  </div>

  <!-- TERMS modal -->
  <div id="termsModal" class="card" style="display:none;max-width:820px;margin:20px auto">
    <h3 style="color:var(--accent);font-family:'Italiana',serif">Kondisyon Sist√®m - ECHANJ PLUS</h3>
    <div style="line-height:1.5;color:#dbe9ff">
      <p><strong>Disponibilite:</strong> S√®vis la disponib s√®lman pou itilizat√® ki rete an Ayiti.</p>
      <p><strong>Laj minim√≤m:</strong> 18+.</p>
      <p><strong>Konv√®syon Minit:</strong> 1 minit = 0.85 Gdes. Fr√® sist√®m: 17.5%.</p>
      <p><strong>Retre:</strong> MonCash, NatCash, Paryaj Lakay, Paryaj Pam.</p>
      <p><strong>Tranzaksyon:</strong> Tout tranzaksyon anrejistre sou Firebase epi verifye pa Cloud Functions (si itilizat√® admin mete yo).</p>
      <p><strong>Sekirite:</strong> Activity fwod ap mennen nan blokaj kont.</p>
      <p><strong>Kontak:</strong> WhatsApp: +509 4711 1123 | Email: echanjplus@gmail.com</p>
    </div>
    <div style="text-align:right;margin-top:12px">
      <button id="closeTerms" class="btn ghost">F√®men / Aksepte</button>
    </div>
  </div>

  <!-- DASHBOARD (hidden until login) -->
  <div id="dashboard" style="display:none">
    <div class="header" style="margin-bottom:12px">
      <div class="brand" style="font-family:'Italiana',serif;font-size:28px">ECHANJ <span style="color:var(--accent)">PLUS</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userMini" class="muted"></div>
        <button id="openDrawer" class="btn ghost">‚ò∞</button>
        <button id="btnLogout" class="btn ghost">Dekonekte</button>
      </div>
    </div>

    <!-- Panels -->
    <div id="panelHome" class="panel active">
      <div class="card">
        <h3>Akey</h3>
        <div class="wallet" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <div class="card mini" style="min-width:160px">
            <div class="muted">Sale Balance (minit)</div>
            <div id="saleVal" style="font-weight:900;font-size:20px;margin-top:6px">0</div>
          </div>
          <div class="card mini" style="min-width:160px">
            <div class="muted">Withdraw Balance (Gdes)</div>
            <div id="withdrawVal" style="font-weight:900;font-size:20px;margin-top:6px">0.00</div>
          </div>
          <div class="card mini" style="min-width:160px">
            <div class="muted">Nimewo Kont</div>
            <div id="acctNum" style="font-weight:900;font-size:20px;margin-top:6px">-</div>
          </div>
        </div>
      </div>
    </div>

    <div id="panelSend" class="panel">
      <div class="card">
        <h3>Voye Minit</h3>
        <label class="muted">Operat√®</label>
        <select id="operator">
          <option value="digicel">Digicel</option>
          <option value="natcom">Natcom</option>
        </select>
        <label class="muted">Kantite minit</label>
        <input id="mins" type="number" min="1" placeholder="Eg. 50" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="composeBtn" class="btn primary">Konpoze USSD</button>
          <button id="sendBtn" class="btn ghost">Voye epi Mete nan Wallet</button>
        </div>
        <div id="digicelConfirm" class="muted" style="margin-top:8px;display:none">Pou konfime Digicel, peze *128*1# epi retounen.</div>
      </div>
    </div>

    <div id="panelPay" class="panel">
      <div class="card">
        <h3>Peman / Retre</h3>
        <div class="muted">Wallet</div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1">
            <div class="muted">Sale (minit)</div>
            <div id="saleVal2" style="font-weight:900">0</div>
          </div>
          <div style="flex:1">
            <div class="muted">Withdraw (Gdes)</div>
            <div id="withdrawVal2" style="font-weight:900">0.00</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <label class="muted">Met√≤d</label>
          <select id="payMethod">
            <option value="moncash">MonCash</option>
            <option value="natcash">NatCash</option>
            <option value="paryajLakay">Paryaj Lakay</option>
            <option value="paryajPam">Paryaj Pam</option>
          </select>
          <input id="payName" placeholder="Non kont / itilizat√®" />
          <input id="payNumber" placeholder="Nimewo kont / telef√≤n" />
          <input id="payAmount" type="number" placeholder="Montan (Gdes)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="paySave" class="btn primary">Sove / Peye</button>
            <button id="payWithdrawAll" class="btn ghost">Retre Tout</button>
          </div>
        </div>
      </div>
    </div>

    <div id="panelProfile" class="panel">
      <div class="card">
        <h3>Profil</h3>
        <div id="profileEdit">
          <input id="pf_name" placeholder="Non" />
          <input id="pf_phone" placeholder="Telef√≤n" />
          <label class="muted">Dat nesans</label>
          <input id="pf_dob" type="date" />
          <label class="muted">Depatman</label>
          <select id="pf_dept">
            <option value="">Chwazi</option>
            <option value="Ouest">Ouest</option>
            <option value="Nord">Nord</option>
            <option value="Sud">Sud</option>
          </select>
          <label class="muted">Komin</label>
          <select id="pf_city">
            <option value="">Chwazi Komin</option>
          </select>
          <input id="pf_photo" placeholder="URL Foto (opsyon√®l)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="pf_save" class="btn primary">Sove Profil</button>
            <button id="pf_view" class="btn ghost">W√® Profil</button>
          </div>
        </div>

        <div id="profileView" style="display:none;margin-top:12px">
          <div class="profile-read">
            <div class="row"><div>Non</div><div id="pv_name"></div></div>
            <div class="row"><div>Telef√≤n</div><div id="pv_phone"></div></div>
            <div class="row"><div>Dat nesans</div><div id="pv_dob"></div></div>
            <div class="row"><div>Depatman</div><div id="pv_dept"></div></div>
            <div class="row"><div>Komin</div><div id="pv_city"></div></div>
          </div>
          <div style="margin-top:8px"><button id="pf_edit_btn" class="btn ghost">Modifye</button></div>
        </div>

      </div>
    </div>

    <div id="panelParrainage" class="panel">
      <div class="card">
        <h3>Parrainaj</h3>
        <div>
          <div class="muted">Nimewo Kont inik</div>
          <div id="myAcct" style="font-weight:900;margin-top:6px">-</div>
          <div class="muted" style="margin-top:8px">Kod Parrainaj</div>
          <div id="myRef" style="font-weight:900;margin-top:6px">-</div>
          <div style="margin-top:8px">
            <button id="shareRef" class="btn primary">Kopi & Pataje Lien</button>
          </div>
          <div style="margin-top:10px">
            <div class="muted">Moun refere</div>
            <div id="refCount" style="font-weight:900">0</div>
          </div>
          <div style="margin-top:10px">
            <div class="muted">Total bonis resevwa</div>
            <div id="refBonus" style="font-weight:900">0.00 Gdes</div>
          </div>
        </div>
      </div>
    </div>

    <div id="panelAbout" class="panel">
      <div class="card">
        <h3>About</h3>
        <p class="muted">Echanj Plus ‚Äî s√®vis echanj minit pou Ayiti.</p>
        <p class="muted">Kontak: WhatsApp +509 4711 1123 | Email echanjplus@gmail.com</p>
      </div>
    </div>

  </div> <!-- end dashboard -->

</div> <!-- end app -->

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="bottomNav" style="display:none">
  <div class="bn-item" data-tab="Send"><button>üì§</button><div class="muted">Voye</div></div>
  <div class="bn-item" data-tab="Pay"><button>üí≥</button><div class="muted">Peman</div></div>
  <div class="bn-item" data-tab="Home"><button class="bn-pill">üè†</button></div>
  <div class="bn-item" data-tab="Profile"><button>üë§</button><div class="muted">Profil</div></div>
  <div class="bn-item" data-tab="Parrainage"><button>üéÅ</button><div class="muted">Parrainaj</div></div>
  <div class="bn-item" data-tab="About"><button>‚ÑπÔ∏è</button><div class="muted">About</div></div>
</nav>

<!-- Toast -->
<div id="toast"></div>

<!-- Firebase Modular SDK -->
<script type="module">
  // --- Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber,
    onAuthStateChanged, sendPasswordResetEmail, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, set, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // --------- Firebase config (use the one you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.appspot.com",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ---------- helper UI fns ----------
  const $ = id => document.getElementById(id);
  function showToast(msg, ms=2500){
    const t = $('toast');
    t.innerText = msg;
    t.style.display='block';
    setTimeout(()=>t.style.display='none', ms);
  }
  function showLoader(show=true){ $('loader').style.display = show? 'flex':'none'; }

  // ---------- Splash (1.5s) ----------
  setTimeout(()=>{
    document.getElementById('splash').style.opacity = '0';
    setTimeout(()=>{ document.getElementById('splash').style.display='none'; document.getElementById('app').style.display='block'; }, 400);
  }, 1500);

  // ---------- small UI wiring ----------
  // enable signup button when terms checked
  $('su_terms').addEventListener('change', e => { $('btnSignup').disabled = !e.target.checked; });

  // open/close terms modal
  $('openTerms').addEventListener('click', ()=> { $('termsModal').style.display='block'; });
  $('closeTerms').addEventListener('click', ()=> { $('termsModal').style.display='none'; });

  // toggle auth panels
  $('toLogin').addEventListener('click', ()=>{ $('signupCard').style.display='none'; $('loginCard').style.display='block'; });
  $('toSignup').addEventListener('click', ()=>{ $('loginCard').style.display='none'; $('signupCard').style.display='block'; });

  // open drawer
  $('btnDots').addEventListener('click', ()=> {
    document.getElementById('drawer').classList.toggle('open');
  });
  $('openDrawer').addEventListener('click', ()=> document.getElementById('drawer').classList.add('open'));

  // sidebar nav items
  document.querySelectorAll('#drawer .item[data-goto]').forEach(el=>{
    el.addEventListener('click', ()=> {
      const g = el.getAttribute('data-goto');
      openPanel(g);
      document.getElementById('drawer').classList.remove('open');
    });
  });

  // bottom nav wiring
  document.querySelectorAll('.bottom-nav .bn-item').forEach(item=>{
    item.addEventListener('click', ()=> {
      const tab = item.getAttribute('data-tab');
      openPanel(tab);
    });
  });

  function openPanel(name){
    // hide all panels
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    // map names to IDs
    const map = { Home:'panelHome', Send:'panelSend', Pay:'panelPay', Profile:'panelProfile', Parrainage:'panelParrainage', About:'panelAbout' };
    const id = map[name] || 'panelHome';
    document.getElementById(id).classList.add('active');
    // show bottom nav if logged in
  }

  // theme buttons
  $('themeBlue').addEventListener('click', ()=> { document.body.removeAttribute('data-theme'); showToast('T√®m ble aktive') });
  $('themeLight').addEventListener('click', ()=> { document.body.setAttribute('data-theme','light'); showToast('T√®m kl√® aktive') });

  // language switching (simple example translations)
  const translations = {
    ht: {
      signup: "Kreye Kont",
      login: "Konekte",
      send: "Voye Minit",
      pay: "Peman",
      profile: "Profil",
      parrainage: "Parrainaj",
      about: "About",
      terms: "Kondisyon Sist√®m"
    },
    en: {
      signup: "Sign Up",
      login: "Login",
      send: "Send Minutes",
      pay: "Payment",
      profile: "Profile",
      parrainage: "Referral",
      about: "About",
      terms: "Terms"
    },
    fr: {
      signup: "S'inscrire",
      login: "Connexion",
      send: "Envoyer Minutes",
      pay: "Paiement",
      profile: "Profil",
      parrainage: "Parrainage",
      about: "√Ä propos",
      terms: "Conditions"
    },
    es: {
      signup: "Registrarse",
      login: "Iniciar sesi√≥n",
      send: "Enviar Minutos",
      pay: "Pago",
      profile: "Perfil",
      parrainage: "Referidos",
      about: "Acerca",
      terms: "T√©rminos"
    },
    pt: {
      signup: "Registrar",
      login: "Entrar",
      send: "Enviar Minutos",
      pay: "Pagamento",
      profile: "Perfil",
      parrainage: "Apadrinhamento",
      about: "Sobre",
      terms: "Termos"
    }
  };
  $('langSel').addEventListener('change', e=>{
    const t = translations[e.target.value] || translations.ht;
    // small labels update (as example)
    document.querySelector('#signupCard h2').innerText = t.signup;
    document.querySelector('#loginCard h2').innerText = t.login;
    document.querySelector('#panelSend h3').innerText = t.send;
    document.querySelector('#panelPay h3').innerText = t.pay;
    document.querySelector('#panelProfile h3').innerText = t.profile;
    document.querySelector('#panelParrainage h3').innerText = t.parrainage;
    document.querySelector('#panelAbout h3').innerText = t.about;
    // terms modal title
    document.querySelector('#termsModal h3').innerText = t.terms + " - ECHANJ PLUS";
    showToast('Lang chanje');
  });

  // ---------- referral utils ----------
  function genAcctNum(){ return 'AC' + Math.floor(100000 + Math.random()*900000); }
  function genRefCode(){ return 'REF' + Math.random().toString(36).slice(2,8).toUpperCase(); }

  // ---------- Signup flow ----------
  $('btnSignup').addEventListener('click', async ()=>{
    const name = $('su_name').value.trim();
    const email = $('su_email').value.trim();
    const phone = $('su_phone').value.trim();
    const pass = $('su_pass').value;
    const refIn = $('su_referral').value.trim();
    if(!name || !email || !phone || !pass){ showToast('Ranpli tout chan obligatwa'); return; }
    showLoader(true);
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;
      // create acct/ref
      const acctNum = genAcctNum();
      let refCode = genRefCode();
      // ensure uniqueness (light check)
      const refKeySnap = await get(ref(db, 'referralCodes/' + refCode));
      if(refKeySnap.exists()){
        refCode = refCode + Math.floor(Math.random()*90);
      }
      // initial balances
      let withdrawBalance = 7.0; // default
      if(refIn){
        // find referrer uid via referralCodes mapping
        const refSnap = await get(ref(db, 'referralCodes/' + refIn));
        if(refSnap.exists()){
          withdrawBalance = 10.0; // bonus for using a referral
          const referrerUid = refSnap.val();
          // give parenn 3 Gdes
          const rUserSnap = await get(ref(db, 'users/' + referrerUid));
          if(rUserSnap.exists()){
            const prev = rUserSnap.val().withdrawBalance || 0;
            await update(ref(db, 'users/' + referrerUid), { withdrawBalance: Number((prev + 3).toFixed(2)) });
          }
        } else {
          // ref code invalid - ignore
        }
      }
      // user object
      const userObj = {
        name, email, phone,
        acctNum, refCode,
        parrain: refIn || null,
        createdAt: Date.now(),
        saleBalance: 0, // minutes
        withdrawBalance: Number(withdrawBalance.toFixed(2))
      };
      await set(ref(db, 'users/' + uid), userObj);
      // set referral mapping
      await set(ref(db, 'referralCodes/' + refCode), uid);
      showToast('Kont kreye. Bonis: ' + withdrawBalance + ' Gdes');
    }catch(err){
      showToast('Er√®: ' + err.message);
    } finally { showLoader(false); }
  });

  // ---------- Login flow ----------
  $('btnLogin').addEventListener('click', async ()=>{
    const email = $('li_email').value.trim();
    const pass = $('li_pass').value;
    if(!email || !pass){ showToast('Ranpli tout chan'); return; }
    showLoader(true);
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      showToast('Konekte');
    }catch(err){ showToast('Er√® konekte: ' + err.message); }
    finally { showLoader(false); }
  });

  // ---------- Reset password ----------
  $('btnResetPwd').addEventListener('click', async ()=>{
    const email = prompt('Antre im√®l ou pou reset modpas');
    if(!email) return;
    try{
      await sendPasswordResetEmail(auth, email);
      showToast('Im√®l reset voye');
    }catch(err){ showToast('Er√®: ' + err.message); }
  });

  // ---------- Google Sign-in (signup & login share same button) ----------
  const gProvider = new GoogleAuthProvider();
  $('btnGoogle').addEventListener('click', async ()=> {
    try{ await signInWithPopup(auth, gProvider); showToast('Google sign-in siks√®'); } catch(e){ showToast('Er√®: ' + e.message); }
  });
  $('btnGoogleIn').addEventListener('click', async ()=> {
    try{ await signInWithPopup(auth, gProvider); showToast('Google sign-in siks√®'); } catch(e){ showToast('Er√®: ' + e.message); }
  });

  // ---------- Phone Auth (Recaptcha) ----------
  // We'll render invisible recaptcha container dynamically when phone flow used
  let recaptchaVerifier = null;
  $('btnPhone').addEventListener('click', ()=> {
    const phone = $('su_phone').value.trim();
    if(!phone){ showToast('Mete nimewo telef√≤n la avan'); return; }
    if(!recaptchaVerifier){
      recaptchaVerifier = new RecaptchaVerifier('btnPhone', { 'size':'invisible' }, auth);
      recaptchaVerifier.render();
    }
    signInWithPhoneNumber(auth, phone, recaptchaVerifier)
      .then(confirmResult => {
        const code = prompt('Antre k√≤d OTP la ou resevwa pa SMS:');
        if(!code) { showToast('OTP oblije'); return; }
        return confirmResult.confirm(code);
      })
      .then(result => { showToast('Phone auth siks√®'); })
      .catch(e => showToast('Er√® phone auth: ' + e.message));
  });
  $('btnPhoneIn').addEventListener('click', ()=> {
    const phone = $('li_email').value.trim(); // allow phone in login field
    if(!phone){ showToast('Mete nimewo telef√≤n pou login'); return; }
    if(!recaptchaVerifier){
      recaptchaVerifier = new RecaptchaVerifier('btnPhoneIn', { 'size':'invisible' }, auth);
      recaptchaVerifier.render();
    }
    signInWithPhoneNumber(auth, phone, recaptchaVerifier)
      .then(confirmResult => {
        const code = prompt('Antre k√≤d OTP la ou resevwa pa SMS:');
        if(!code) { showToast('OTP oblije'); return; }
        return confirmResult.confirm(code);
      })
      .then(result => { showToast('Phone login siks√®'); })
      .catch(e => showToast('Er√® phone login: ' + e.message));
  });

  // ---------- Auth listener: load profile & show dashboard ----------
  let currentUserData = null;
  onAuthStateChanged(auth, async user => {
    if(user){
      // show interface
      document.getElementById('auth').style.display='none';
      document.getElementById('dashboard').style.display='block';
      document.getElementById('bottomNav').style.display='flex';
      document.getElementById('dots').style.display='block';
      // load user data
      const uid = user.uid;
      const uSnap = await get(ref(db, 'users/' + uid));
      if(uSnap.exists()){
        currentUserData = uSnap.val();
        updateUIWithUser(uid, currentUserData);
        // listen for updates
        onValue(ref(db, 'users/' + uid), snap=> {
          if(snap.exists()){ currentUserData = snap.val(); updateUIWithUser(uid, currentUserData); }
        });
      } else {
        // user document missing (e.g. google sign-in). create minimal
        const acctNum = genAcctNum();
        const refCode = genRefCode();
        const userObj = { name: user.displayName || 'User', email:user.email || '', phone:user.phoneNumber || '', acctNum, refCode, createdAt:Date.now(), saleBalance:0, withdrawBalance:0 };
        await set(ref(db,'users/' + uid), userObj);
        await set(ref(db,'referralCodes/' + refCode), uid);
        currentUserData = userObj;
        updateUIWithUser(uid, currentUserData);
      }
    } else {
      // logged out
      document.getElementById('auth').style.display='flex';
      document.getElementById('dashboard').style.display='none';
      document.getElementById('bottomNav').style.display='none';
      document.getElementById('dots').style.display='none';
    }
  });

  async function updateUIWithUser(uid, data){
    $('userMini').innerText = data.name || data.email || '';
    $('saleVal').innerText = data.saleBalance || 0;
    $('withdrawVal').innerText = (data.withdrawBalance || 0).toFixed(2);
    $('saleVal2').innerText = data.saleBalance || 0;
    $('withdrawVal2').innerText = (data.withdrawBalance || 0).toFixed(2);
    $('acctNum').innerText = data.acctNum || '-';
    $('myAcct').innerText = data.acctNum || '-';
    $('myRef').innerText = data.refCode || '-';
    // parrainage stats: count number of users with parrain == myRef
    const refCode = data.refCode;
    const refSnap = await get(ref(db, 'referralCodes/' + refCode));
    // count referrers by scanning users (small DB ok; for production use Cloud Function)
    const allUsersSnap = await get(ref(db, 'users'));
    let count = 0;
    let totalBonus = 0;
    if(allUsersSnap.exists()){
      allUsersSnap.forEach(u => {
        const v = u.val();
        if(v.parrain === refCode) { count++; totalBonus += (v.referrerBonus || 0); }
        // alternatively compute from withdraw changes
      });
    }
    $('refCount').innerText = count;
    $('refBonus').innerText = (data.withdrawBalance || 0).toFixed(2) + ' Gdes';
    // fill profile fields
    $('pf_name').value = data.name || '';
    $('pf_phone').value = data.phone || '';
    if(data.dob) $('pf_dob').value = data.dob;
    if(data.dept) $('pf_dept').value = data.dept;
    // load cities list based on dept
    populateCities(data.dept || '');
  }

  // ---------- Send Minit: compose USSD (dialer) & send to wallet ----------
  $('composeBtn').addEventListener('click', ()=>{
    const operator = $('operator').value;
    // Example USSD templates - adjust based on operator specifics
    let ussd = '';
    if(operator === 'digicel') ussd = '*152#'; // sample
    if(operator === 'natcom') ussd = '*123#'; // sample
    // open tel: link (works on mobile)
    window.location.href = 'tel:' + encodeURIComponent(ussd);
  });

  $('sendBtn').addEventListener('click', async ()=>{
    const mins = Number($('mins').value);
    if(!mins || mins <= 0){ showToast('Antre kantite minit valab'); return; }
    const user = auth.currentUser;
    if(!user){ showToast('Ou dwe konekte'); return; }
    showLoader(true);
    try{
      const uid = user.uid;
      const userSnap = await get(ref(db, 'users/' + uid));
      if(!userSnap.exists()){ showToast('Pa jwenn kont itilizat√®'); showLoader(false); return; }
      const userData = userSnap.val();
      // add sale minutes
      const prevSale = Number(userData.saleBalance || 0);
      const newSale = prevSale + mins;
      // convert to Gdes and add to withdraw balance
      const conv = Number((mins * 0.85).toFixed(2));
      const prevWithdraw = Number(userData.withdrawBalance || 0);
      const newWithdraw = Number((prevWithdraw + conv).toFixed(2));
      await update(ref(db, 'users/' + uid), { saleBalance: newSale, withdrawBalance: newWithdraw });
      // record transaction
      const tx = { type:'add_mins', mins, converted:conv, createdAt:Date.now() };
      await push(ref(db, 'transactions/' + uid), tx);
      showToast('Minit ajoute ak konv√®ti: ' + conv + ' Gdes');
      $('mins').value = '';
    }catch(err){ showToast('Er√®: ' + err.message); }
    finally{ showLoader(false); }
  });

  // ---------- Pay / Withdraw ----------
  $('paySave').addEventListener('click', async ()=>{
    const method = $('payMethod').value;
    const name = $('payName').value.trim();
    const number = $('payNumber').value.trim();
    const amount = Number($('payAmount').value);
    if(!amount || amount <= 0){ showToast('Antre montan valab'); return; }
    const user = auth.currentUser;
    if(!user){ showToast('Ou dwe konekte'); return; }
    showLoader(true);
    try{
      const uid = user.uid;
      const uSnap = await get(ref(db, 'users/' + uid));
      if(!uSnap.exists()) throw new Error('Pa jwenn itilizat√®');
      const curr = Number(uSnap.val().withdrawBalance || 0);
      if(amount > curr){ showToast('Montan depase withdraw balance'); showLoader(false); return; }
      // deduct
      const newBal = Number((curr - amount).toFixed(2));
      await update(ref(db, 'users/' + uid), { withdrawBalance: newBal });
      // save transaction
      const tx = { type:'withdraw', method, name, number, amount, createdAt: Date.now() };
      await push(ref(db, 'transactions/' + uid), tx);
      showToast('Retre demann anrejistre');
      // clear form
      $('payAmount').value=''; $('payName').value=''; $('payNumber').value='';
    }catch(err){ showToast('Er√®: ' + err.message); }
    finally{ showLoader(false); }
  });

  $('payWithdrawAll').addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user){ showToast('Ou dwe konekte'); return; }
    showLoader(true);
    try{
      const uid = user.uid;
      const uSnap = await get(ref(db, 'users/' + uid));
      const curr = Number(uSnap.val().withdrawBalance || 0);
      if(curr <= 0){ showToast('Pa gen sa pou retre'); showLoader(false); return; }
      await update(ref(db, 'users/' + uid), { withdrawBalance: 0 });
      await push(ref(db, 'transactions/' + uid), { type:'withdraw_all', amount: curr, createdAt: Date.now() });
      showToast('Tout withdraw mande');
    }catch(err){ showToast('Er√®: '+err.message) }
    finally{ showLoader(false); }
  });

  // ---------- Profile save/view ----------
  $('pf_save').addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user){ showToast('Ou dwe konekte'); return; }
    showLoader(true);
    try{
      const uid = user.uid;
      const payload = {
        name: $('pf_name').value.trim(),
        phone: $('pf_phone').value.trim(),
        dob: $('pf_dob').value,
        dept: $('pf_dept').value,
        city: $('pf_city').value,
        photo: $('pf_photo').value
      };
      await update(ref(db, 'users/' + uid), payload);
      showToast('Profil sove');
    }catch(e){ showToast('Er√®: ' + e.message); }
    finally{ showLoader(false); }
  });

  $('pf_view').addEventListener('click', ()=> {
    // toggle view
    $('profileEdit').style.display = 'none';
    $('profileView').style.display = 'block';
    // fill view
    $('pv_name').innerText = $('pf_name').value;
    $('pv_phone').innerText = $('pf_phone').value;
    $('pv_dob').innerText = $('pf_dob').value;
    $('pv_dept').innerText = $('pf_dept').value;
    $('pv_city').innerText = $('pf_city').value;
  });
  $('pf_edit_btn').addEventListener('click', ()=> { $('profileView').style.display='none'; $('profileEdit').style.display='block'; });

  // ---------- Parrainage: copy & share ----------
  $('shareRef').addEventListener('click', ()=> {
    const refc = $('myRef').innerText;
    const link = window.location.origin + window.location.pathname + '?ref=' + encodeURIComponent(refc);
    navigator.clipboard?.writeText(link).then(()=> showToast('Lien kopiye: ' + link)).catch(()=> showToast('Kopi echwe'));
  });

  // ---------- Logout ----------
  $('btnLogout').addEventListener('click', async ()=> {
    await signOut(auth);
    showToast('Dekonekte');
  });

  // ---------- Utility: populate cities by dept ----------
  const citiesByDept = {
    'Ouest': ['Port-au-Prince','P√©tion-Ville','Delmas'],
    'Nord': ['Cap-Ha√Øtien','Limb√©','Gros-Morne'],
    'Sud': ['Les Cayes','Aquin','Port-Salut']
  };
  function populateCities(dept){
    const sel = $('pf_city');
    sel.innerHTML = '<option value="">Chwazi Komin</option>';
    if(!dept || !citiesByDept[dept]) return;
    for(const c of citiesByDept[dept]) sel.innerHTML += `<option value="${c}">${c}</option>`;
  }
  $('pf_dept').addEventListener('change', ()=> populateCities($('pf_dept').value));

  // ---------- navigation initial defaults ----------
  openPanel('Home');

  // show/hide bottom nav depending on auth
  const bottomNav = document.getElementById('bottomNav');
  function setBottomVisible(visible){
    document.getElementById('bottomNav').style.display = visible ? 'flex':'none';
  }

  // show bottom nav initially hidden (will show when logged)
  setBottomVisible(false);

  // expose some globals for debugging (optional)
  window.ECHANJ = { auth, db };

  // ensure bottom nav buttons actually switch panels
  document.querySelectorAll('.bottom-nav .bn-item').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const tab = btn.getAttribute('data-tab');
      openPanel(tab);
    });
  });

  // utility: if page loaded with ?ref=CODE prefill referral in signup
  const params = new URLSearchParams(location.search);
  if(params.get('ref')) $('su_referral').value = params.get('ref');

  // Hide terms modal on outside click (simple)
  document.addEventListener('click', (e)=> {
    const tm = $('termsModal');
    if(tm.style.display === 'block' && !tm.contains(e.target) && !e.target.matches('#openTerms')) {
      tm.style.display = 'none';
    }
  });

  // Show loader when doing heavy auth state changes
  onAuthStateChanged(auth, user => {
    if(user){
      // show dashboard and nav
      document.getElementById('auth').style.display='none';
      document.getElementById('dashboard').style.display='block';
      setBottomVisible(true);
      document.getElementById('dots').style.display
