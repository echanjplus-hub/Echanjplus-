<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Echanj Plus</title>
<style>
  :root{
    --bg:#0D1B2A; --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.08); --accent:#FFD700; --muted:#9fb8d9;
  }
  *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
  a{color:var(--accent)}
  /* SPLASH */
  #splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:9999}
  .logo-fixed{z-index:20;text-align:center;pointer-events:none}
  .logo-fixed h1{font-size:44px;margin:0;font-weight:900;color:var(--accent);text-shadow:0 2px 12px rgba(0,0,0,0.6);font-family:Arial}
  .square-wrap{position:relative;margin-top:18px}
  .square{width:200px;height:200px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 40px rgba(0,0,0,0.6);animation:rotateSmooth 2.2s ease-in-out infinite alternate;}
  @keyframes rotateSmooth {0%{transform:rotate(-18deg)}50%{transform:rotate(18deg)}100%{transform:rotate(-18deg)}}
  .drip{position:absolute;width:8px;height:18px;background:#000;border-radius:6px;opacity:0.9;animation:drip 1.6s linear infinite}
  @keyframes drip{0%{transform:translateY(-50vh) scaleY(0.6);opacity:0.7}70%{transform:translateY(60vh) scaleY(1.2);opacity:0.9}100%{transform:translateY(100vh) scaleY(1.4);opacity:0}}
  /* LOADER (overlay) */
  #loader{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;z-index:1200}
  #loader .box{background:#fff;padding:12px 18px;border-radius:10px;color:#000;font-weight:800;display:flex;gap:10px;align-items:center}
  /* APP */
  #app{display:none;min-height:100vh;padding:28px;position:relative;z-index:10}
  .center{max-width:980px;margin:0 auto}
  /* AUTH */
  .auth-wrap{display:flex;gap:20px;justify-content:center;align-items:flex-start;flex-wrap:wrap}
  .card{background:var(--card);border-radius:18px;padding:18px;border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(6px)}
  .auth-card{width:380px}
  .auth-card h2{text-align:center;color:var(--accent);margin:0 0 12px 0}
  input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:#fff}
  button.btn{width:100%;padding:12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
  button.primary{background:var(--accent);color:#000}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
  .muted{color:var(--muted);font-size:13px}
  .link{color:var(--accent);cursor:pointer}
  .row{display:flex;gap:8px}
  .small{width:33%}
  /* DASHBOARD */
  #dashboard{display:none;flex-direction:column}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{font-size:28px;font-weight:900;color:var(--accent);text-shadow:0 2px 8px rgba(0,0,0,0.6)}
  .user-mini{font-size:13px;color:#fff;opacity:0.9}
  .welcome{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
  .ok-btn{padding:8px 12px;border-radius:8px;border:none;background:#28a745;color:#fff;cursor:pointer}
  .options{display:flex;gap:12px;justify-content:center;margin-bottom:12px}
  .opt{flex:1;padding:12px;border-radius:12px;text-align:center;background:rgba(255,255,255,0.03);cursor:pointer;font-weight:800}
  .opt.active{background:var(--accent);color:#000}
  .panel{display:none}
  .panel.active{display:block}
  .wallet{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .mini{flex:1;min-width:160px;padding:12px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center}
  .mini .title{font-size:13px;color:#bcd6f2}
  .mini .value{font-weight:900;font-size:20px;margin-top:6px}
  form{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .inline{display:flex;gap:8px}
  .inline input{flex:1}
  .profile-read .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .acc{margin-top:8px}
  .acc .head{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;cursor:pointer;font-weight:800}
  .acc .body{display:none;padding:10px;color:#cfe6ff;background:rgba(255,255,255,0.01);border-radius:8px;margin-top:6px}
  #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 18px;border-radius:10px;display:none;z-index:2000}
  @media (max-width:820px){ .auth-card{width:100%} .square{width:140px;height:140px} .logo-fixed h1{font-size:34px} }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="logo-fixed"><h1>ECHANJ PLUS</h1></div>
  <div class="square-wrap">
    <div class="square" aria-hidden="true"></div>
    <!-- drips -->
    <div class="drip" style="left:8%;animation-duration:1.6s;animation-delay:0s"></div>
    <div class="drip" style="left:34%;animation-duration:1.8s;animation-delay:0.3s"></div>
    <div class="drip" style="left:62%;animation-duration:1.4s;animation-delay:0.6s"></div>
    <div class="drip" style="left:80%;animation-duration:1.9s;animation-delay:0.2s"></div>
  </div>
</div>

<!-- Loader overlay -->
<div id="loader" style="display:none;align-items:center;justify-content:center">
  <div class="box">Ap prepare aplikasyon an...</div>
</div>

<!-- App -->
<div id="app" class="center" aria-hidden="true">

  <!-- AUTH -->
  <div id="auth" class="auth-wrap" style="margin-top:20px;display:flex;justify-content:center">
    <!-- Signup -->
    <div class="card auth-card" id="signupCard" role="region" aria-label="signup">
      <h2>Kreye Kont</h2>
      <input id="su_name" placeholder="Non konpl√®" />
      <input id="su_email" placeholder="Im√®l" />
      <input id="su_phone" placeholder="Telef√≤n (+509...)" />
      <div class="row">
        <input id="su_day" class="small" placeholder="JJ" />
        <input id="su_month" class="small" placeholder="MM" />
        <input id="su_year" class="small" placeholder="AAAA" />
      </div>
      <input id="su_pass" type="password" placeholder="Modpas" />
      <label class="muted"><input id="su_terms" type="checkbox" /> Mwen li epi mwen aksepte <a id="openTerms" class="link">Kondisyon Sist√®m</a></label>
      <button class="btn primary" id="btnSignup" disabled>Kreye kont</button>
      <div style="text-align:center;margin-top:8px" class="muted">Ou deja gen kont? <span class="link" id="toLogin">Konekte</span></div>
    </div>

    <!-- Login -->
    <div class="card auth-card" id="loginCard" role="region" aria-label="login" style="display:none">
      <h2>Konekte</h2>
      <input id="li_email" placeholder="Im√®l" />
      <input id="li_pass" type="password" placeholder="Modpas" />
      <label class="muted"><input id="li_accept" type="checkbox" /> Mwen aksepte Kondisyon Sist√®m</label>
      <button class="btn primary" id="btnLogin">Konekte</button>
      <div style="text-align:center;margin-top:8px" class="muted">Pa gen kont? <span class="link" id="toSignup">Enskri</span></div>
    </div>
  </div>

  <!-- TERMS modal -->
  <div id="termsModal" class="card" style="display:none;max-width:820px;margin:20px auto;padding:18px">
    <h3 style="color:var(--accent)">Kondisyon Sist√®m - ECHANJ PLUS</h3>
    <div style="line-height:1.5;color:#dbe9ff">
      <p><strong>Disponibilite:</strong> S√®vis la disponib s√®lman pou itilizat√® ki rete an Ayiti.</p>
      <p><strong>Laj minim√≤m:</strong> Itilizat√® dwe gen 18 ane oswa plis pou enskri ak itilize s√®vis la.</p>
      <p><strong>Enf√≤masyon:</strong> Tout enf√≤masyon bay la dwe veritab. Yon s√®l kont pou chak itilizat√®.</p>
      <p><strong>Konv√®syon Minit:</strong> 1 minit = 0.82 Gdes. Sist√®m pran 15% fr√®; WithdrawBalance kalkile otomatikman.</p>
      <p><strong>Retre:</strong> Itilizat√® ka retire lajan atrav√® MonCash, NatCash, Paryaj Lakay oswa Paryaj Pam. Montan pa ka depase Withdraw Balance.</p>
      <p><strong>Tranzaksyon:</strong> Tout tranzaksyon anrejistre sou Firebase (Realtime DB & Firestore) epi verifye pa sist√®m admin. Pa gen ranv√®sman otomatik.</p>
      <p><strong>Sekirite:</strong> Cloud Functions + Security Rules an plas pou pwoteje done. Aktivite fwod oswa ilegal ap mennen nan blokaj kont.</p>
      <p><strong>Kontak:</strong> WhatsApp: +509 4711 1123 | Email: echanjplus@gmail.com</p>
      <p><em>Pa s√®vi ak kont oswa s√®vis sa a pou aktivite ilegal. Aksepte kondisyon sa yo obligatwa pou kreye kont ak itilize s√®vis Echanj Plus.</em></p>
    </div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn ghost" id="closeTerms">F√®men</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="header">
      <div class="brand">ECHANJ <span style="color:var(--accent)">PLUS</span></div>
      <div class="user-mini" id="userMini"></div>
    </div>

    <div class="welcome" id="welcomeBox">
      <div>Byenveni sou Echanj Plus! S√®vis la se pou f√® premye tranzaksyon ou an.</div>
      <div><button class="ok-btn" id="dismissWelcome">Ok</button></div>
    </div>

    <div class="options" role="tablist" aria-label="main options">
      <div class="opt active" id="optHome">üè† Akey</div>
      <div class="opt" id="optSend">üì§ Voye Minit</div>
      <div class="opt" id="optPay">üí≥ Peman</div>
      <div class="opt" id="optProfile">üë§ Profil</div>
      <div class="opt" id="optAbout">‚ÑπÔ∏è About</div>
    </div>

    <!-- Panels -->
    <div id="panelHome" class="panel active">
      <div class="wallet">
        <div class="mini card"><div class="title">Sale Balance (minit)</div><div class="value" id="saleVal">0</div></div>
        <div class="mini card"><div class="title">Withdraw Balance (Gdes)</div><div class="value" id="withdrawVal">0.00</div></div>
        <div class="mini card"><div class="title">Nimewo Kont</div><div class="value" id="acctNum">-</div></div>
      </div>
      <div class="card">
        <h3>Aktivite D√®nye</h3>
        <div id="activityList" class="muted" style="min-height:40px">Pa gen aktivite ank√≤.</div>
      </div>
    </div>

    <div id="panelSend" class="panel">
      <div class="card">
        <h3>Voye Minit</h3>
        <label class="muted">Operat√®</label>
        <select id="operator">
          <option value="digicel">Digicel</option>
          <option value="natcom">Natcom</option>
        </select>
        <label class="muted">Kantite minit</label>
        <input id="mins" type="number" min="1" placeholder="Eg. 50" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn primary" id="composeBtn">Konpoze USSD</button>
          <button class="btn ghost" id="sendBtn">Voye epi Mete nan Wallet</button>
        </div>
        <div id="digicelConfirm" class="muted" style="margin-top:8px;display:none">Pou konfime Digicel, peze *128*1# epi retounen.</div>
      </div>
    </div>

    <div id="panelPay" class="panel">
      <div class="card">
        <h3>Peman / Retre</h3>
        <div class="muted">Wallet</div>
        <div class="wallet" style="margin-top:10px">
          <div class="mini card"><div class="title">Sale</div><div class="value" id="saleVal2">0</div></div>
          <div class="mini card"><div class="title">Withdraw</div><div class="value" id="withdrawVal2">0.00</div></div>
        </div>

        <div style="margin-top:10px">
          <label class="muted">Met√≤d</label>
          <select id="payMethod"><option value="moncash">MonCash</option><option value="natcash">NatCash</option><option value="paryajLakay">Paryaj Lakay</option><option value="paryajPam">Paryaj Pam</option></select>
          <input id="payName" placeholder="Non kont (oswa itilizat√®)" />
          <input id="payNumber" placeholder="Nimewo kont / telef√≤n" />
          <input id="payAmount" type="number" placeholder="Montan (Gdes)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" id="paySave">Sove / Peye</button>
            <button class="btn ghost" id="payWithdrawAll">Retre Tout</button>
          </div>
        </div>
      </div>
    </div>

    <div id="panelProfile" class="panel">
      <div class="card" id="profileCard">
        <h3>Profil</h3>
        <div id="profileModeEdit">
          <input id="pf_name" placeholder="Non" />
          <input id="pf_phone" placeholder="Telef√≤n" />
          <label class="muted">Dat nesans</label>
          <input id="pf_dob" type="date" />
          <select id="pf_sex"><option value="">Chwazi</option><option value="Gason">Gason</option><option value="Fi">Fi</option></select>
          <input id="pf_city" placeholder="Vil" />
          <input id="pf_photo" placeholder="URL Foto (opsyon√®l)" />
          <button class="btn primary" id="pf_save">Sove Profil (f√®men pou modifye)</button>
        </div>
        <div id="profileView" style="display:none" class="profile-read">
          <div class="row"><div>Non</div><div id="pv_name"></div></div>
          <div class="row"><div>Telef√≤n</div><div id="pv_phone"></div></div>
          <div class="row"><div>Dat nesans</div><div id="pv_dob"></div></div>
          <div class="row"><div>Laj</div><div id="pv_age"></div></div>
          <div class="row"><div>Vil</div><div id="pv_city"></div></div>
          <div class="row"><div>S√®ks</div><div id="pv_sex"></div></div>
          <div style="margin-top:8px"><button class="btn ghost" id="pf_edit" style="display:none">Modifier</button></div>
        </div>
      </div>
    </div>

    <div id="panelAbout" class="panel">
      <div class="card">
        <h3>About</h3>
        <div class="acc">
          <div class="head">üîº Kontak & √àd</div>
          <div class="body">WhatsApp: +50947111123<br>Email: echanjplus@gmail.com<br>Adr√®s: Boulva Gaya, Rue #72</div>
        </div>
        <div class="acc">
          <div class="head">üîº Kondisyon Sist√®m lan</div>
          <div class="body">S√®vis la disponib s√®lman pou Ayiti. Laj minim√≤m 18 ane. Fr√® sist√®m 15%. Pa gen ranv√®sman.</div>
        </div>
        <div class="acc">
          <div class="head">üîº Kondisyon Jeneral</div>
          <div class="body">Tout fonksyonalite sist√®m, pwoteksyon done itilizat√®, validasyon tranzaksyon, WhatsApp verification...</div>
        </div>
        <div class="acc">
          <div class="head">üîº SEO & Rezo</div>
          <div class="body">SEO: ARS<br><a href='https://www.facebook.com/share/19pCBnyujR/' target='_blank'>Facebook</a> ¬∑ <a href='https://youtube.com/@echanjplus?si=KtZiO5TmpXDbjynG' target='_blank'>YouTube</a></div>
        </div>
      </div>
    </div>

    <div style="margin-top:18px;text-align:center"><button class="btn ghost" id="btnLogout">Dekonekte</button></div>
  </div>

</div>

<div id="toast"></div>

<!-- Firebase modular SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, set, get, runTransaction, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /* ---------- Firebase config (you provided) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.firebasestorage.app",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const rdb = getDatabase(app);
  const fs = getFirestore(app);

  /* ---------- Helpers ---------- */
  const $ = id => document.getElementById(id);
  function toast(msg, t=3000){ const el=$('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', t); }
  function loader(on=true){ $('loader').style.display = on ? 'flex' : 'none'; }
  function maskEmail(e){ if(!e) return ''; const [u,d]=e.split('@'); return (u? (u.slice(0,3)+'******@'+d):e); }

  /* ---------- Splash lifecycle ---------- */
  setTimeout(()=>{ document.getElementById('splash').style.display='none'; document.getElementById('app').style.display='block'; }, 3500);

  /* ---------- UI wiring ---------- */
  $('su_terms').addEventListener('change', ()=> $('btnSignup').disabled = !$('su_terms').checked);
  $('toLogin').addEventListener('click', ()=>{ $('signupCard').style.display='none'; $('loginCard').style.display='block'; });
  $('toSignup').addEventListener('click', ()=>{ $('loginCard').style.display='none'; $('signupCard').style.display='block'; });
  $('openTerms').addEventListener('click', ()=>{ $('termsModal').style.display='block'; });
  $('closeTerms').addEventListener('click', ()=>{ $('termsModal').style.display='none'; });

  /* ---------- Utility ---------- */
  function computeAgeFromDMY(day,month,year){
    const d = new Date(year,month-1,day); const now=new Date();
    let age=now.getFullYear()-d.getFullYear(); const m=now.getMonth()-d.getMonth();
    if(m<0 || (m===0 && now.getDate()<d.getDate())) age--;
    return age;
  }
  function computeGdes(mins){ return Number(mins) * 0.82 * 0.85; } // 15% fee

  /* ---------- Auth state listener ---------- */
  onAuthStateChanged(auth, async user=>{
    if(user){
      // show dashboard
      $('auth').style.display='none'; $('dashboard').style.display='block';
      $('userMini').textContent = maskEmail(user.email || user.phoneNumber || user.uid);

      // load or create profile
      try{
        const pRef = ref(rdb, `users/${user.uid}/profile`);
        const snap = await get(pRef);
        if(!snap.exists()){
          // if signed in but profile missing (e.g., google), create minimal profile but mark not accepted -> force accept
          const acct = await nextAccountNumber();
          const obj = { name: user.displayName || '(non)', email: user.email||'', phone: user.phoneNumber||'', dob:'', city:'', sex:'', accountNumber:acct, profileLocked:false, acceptedTerms:false, wallet:{ saleBalance:0, withdrawBalance:0 }, dateCreated:Date.now() };
          await set(pRef, obj);
        }
        const profileSnap = await get(pRef);
        const p = profileSnap.val();
        if(!p.acceptedTerms){
          // force accept before use
          toast('Ou dwe aksepte kondisyon sist√®m lan avan w kontinye.');
          // show terms modal and block functionality until accepted
          $('termsModal').style.display='block';
          // provide a simple accept button (we reuse closeTerms but also set accepted true)
          // add ephemeral handler:
          const acceptHandler = async ()=>{
            try{
              await update(ref(rdb, `users/${user.uid}/profile`), { acceptedTerms: true });
              $('termsModal').style.display='none';
              toast('Kondisyon yo aksepte. Bon travay!');
              // remove listener
              $('closeTerms').removeEventListener('click', acceptHandler);
              loadProfile(user.uid);
            }catch(e){ console.error(e); toast('Er√® l√® w te aksepte kondisyon'); }
          };
          $('closeTerms').addEventListener('click', acceptHandler);
          return;
        }
        // load profile normally
