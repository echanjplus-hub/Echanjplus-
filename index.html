<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECHANJ PLUS</title>
<style>
  :root{
    --bg:#06243a; /* ble fonse */
    --card: rgba(255,255,255,0.04);
    --muted: #9fb8d9;
    --accent: #FFD700; /* j√≤n */
    --accent-dark: #e6c200;
    --danger: #ef4444;
    --glass-border: rgba(255,255,255,0.08);
    --text-dark: #041219;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:#fff}
  /* ===== Splash ===== */
  #splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;background:var(--bg);overflow:hidden}
  /* graffiti / paint drips (subtle black paint) */
  #splash::before{
    content:"";position:absolute;inset:0;
    background:
      radial-gradient(circle at 12% 15%, rgba(0,0,0,0.26) 0 5%, transparent 6%),
      radial-gradient(circle at 30% 30%, rgba(0,0,0,0.20) 0 7%, transparent 8%),
      radial-gradient(circle at 75% 18%, rgba(0,0,0,0.22) 0 6%, transparent 7%),
      linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02));
    mix-blend-mode:multiply; pointer-events:none;
    animation: drip 3.6s ease-in-out infinite;
    opacity:0.95;
  }
  @keyframes drip{0%{transform:translateY(0)}50%{transform:translateY(6px)}100%{transform:translateY(0)}}

  /* glass square (rotating) */
  .glass {
    width:240px; height:240px; border-radius:20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    border:1px solid var(--glass-border);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    box-shadow: 0 18px 50px rgba(2,6,23,0.55);
    display:flex;align-items:center;justify-content:center;position:relative;
    transform-origin:center;
    animation: rotateBackForth 4.4s ease-in-out infinite; /* smooth rotation */
  }
  @keyframes rotateBackForth{
    0%{transform: rotate(-18deg)}
    25%{transform: rotate(18deg)}
    50%{transform: rotate(-18deg)}
    75%{transform: rotate(18deg)}
    100%{transform: rotate(-18deg)}
  }

  /* ECHANJ PLUS text stays fixed over rotating square */
  .brand {
    position:absolute; z-index:5; text-align:center; pointer-events:none;
    font-weight:900; font-family: Arial, Helvetica, sans-serif;
    font-size:36px; line-height:0.95;
    background: linear-gradient(90deg, var(--accent) 0%, #000 60%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    color:transparent;
  }
  /* slight reflection element (purely decorative) */
  .glass::after{
    content:""; position:absolute; top:10px; left:6%; width:78%; height:28%;
    background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.0));
    transform: rotate(-12deg); border-radius:12px; filter: blur(4px); opacity:0.6;
  }

  .splash-note { margin-top:18px; color:var(--muted); font-size:13px }

  /* ===== App container (hidden until splash ends) ===== */
  #app { display:none; min-height:100vh; padding-bottom:86px; } /* leave space for bottom nav */
  .container { max-width:980px; margin:26px auto; padding:16px; }

  /* AUTH CARD (centered) */
  .auth-card { max-width:420px; margin:40px auto; background: rgba(255,255,255,0.03); padding:22px; border-radius:14px; border:1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(0,0,0,0.45); }
  .auth-card h2 { text-align:center; margin-bottom:14px; font-size:20px; color: #fff; font-weight:900; }
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:6px}
  .btn { display:inline-block;padding:12px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer }
  .btn-primary { background:var(--accent); color:#000 }
  .btn-accent { background:transparent;border:1px solid rgba(255,255,255,0.06); color:#fff }

  .row { display:flex; gap:8px }
  .link { color:#ffd54a; cursor:pointer; text-decoration:underline; font-size:13px }

  /* loader overlay */
  #loader { display:none; position:fixed; inset:0; background:rgba(2,6,23,0.6); align-items:center; justify-content:center; z-index:120; }
  #loader .box { background:#fff;padding:14px 18px;border-radius:12px;color:#000;font-weight:800 }

  /* bottom horizontal nav (app options) */
  nav.bottom-nav {
    position:fixed; left:0; right:0; bottom:12px; height:62px; display:flex;align-items:center;justify-content:center; z-index:115;
  }
  .nav-inner { width:100%; max-width:980px; display:flex; gap:12px; padding:8px; justify-content:space-around; background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:14px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .nav-btn { flex:1; text-align:center; padding:10px 8px; cursor:pointer; color:#001; font-weight:800; border-radius:10px; background:var(--accent); }
  .nav-btn.inactive { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06) }

  /* content cards */
  .card { background: rgba(255,255,255,0.03); border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 8px 30px rgba(0,0,0,0.45); color:#fff }
  .hidden { display:none }

  /* small utilities */
  .muted { color:var(--muted); font-size:13px }
  .small { font-size:13px }
  .center { text-align:center }

  /* responsiveness */
  @media (max-width:700px){
    .brand{ font-size:30px }
    .glass{ width:180px; height:180px }
    .auth-card { margin:20px; }
  }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" aria-hidden="false">
  <div class="glass" aria-hidden="true"></div>
  <div class="brand" aria-hidden="true">ECHANJ<br>PLUS</div>
  <div class="splash-note">Ap prepare aplikasyon an‚Ä¶</div>
</div>

<!-- LOADER -->
<div id="loader"><div class="box">Ap tann... </div></div>

<!-- APP -->
<div id="app" aria-hidden="true">
  <div class="container">
    <!-- AUTH CARD -->
    <div id="authCard" class="auth-card card">
      <h2 id="authTitle">Konekte</h2>

      <div id="authForms">
        <div id="loginForm">
          <label>Im√®l</label>
          <input id="loginEmail" type="email" placeholder="ou@exemple.com" autocomplete="username">
          <label>Modpas</label>
          <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <div style="margin-top:12px" class="row">
            <button id="btnLogin" class="btn btn-primary">Konekte</button>
            <button id="showSignup" class="btn btn-accent">Kreye Kont</button>
          </div>
          <div style="margin-top:8px" class="muted">Pa gen kont? <span id="openSignup" class="link">Kreye kont</span></div>
          <div style="margin-top:6px" class="muted"><span id="openTermsLink" class="link">Kondisyon Itilizasyon</span></div>
        </div>

        <div id="signupForm" class="hidden">
          <label>Non konpl√®</label><input id="signupName" placeholder="Jean Paul">
          <label>Telef√≤n (+509...)</label><input id="signupPhone" placeholder="+50937xxxxxx">
          <label>Im√®l</label><input id="signupEmail" type="email" placeholder="ou@exemple.com">
          <label>Modpas</label><input id="signupPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <div class="row">
            <button id="btnSignup" class="btn btn-primary">Kreye Kont</button>
            <button id="backToLogin" class="btn btn-accent">Tounen</button>
          </div>
          <div style="margin-top:8px" class="muted"><span id="openTermsFromSignup" class="link">Kondisyon Itilizasyon</span></div>
        </div>
      </div>

      <div id="termsBox" class="hidden" style="margin-top:12px;">
        <h3>Kondisyon Itilizasyon</h3>
        <div style="max-height:240px;overflow:auto;color:var(--muted);font-size:13px">
          <p>1. S√®vis disponib s√®lman pou moun ki rete an Ayiti.</p>
          <p>2. Laj minim√≤m: 18 ane oswa plis.</p>
          <p>3. Chak itilizat√® gen yon s√®l kont.</p>
          <p>4. Enf√≤masyon bay la dwe veritab.</p>
          <p>5. Tranzaksyon final, pa gen ranv√®sman.</p>
          <p>6. Aktivite ilegal oswa fwod ent√®di.</p>
          <p>7. Sist√®m ka mete limit sou tranzaksyon.</p>
          <p>8. Kont ka bloke si gen vyolasyon.</p>
          <p>9. Done itilizat√® yo pwoteje epi itilize s√®lman pou s√®vis la.</p>
          <p>10. Nenp√≤t reklamasyon dwe f√®t atrav√® WhatsApp oswa Im√®l ofisy√®l.</p>
        </div>
        <div style="margin-top:8px" class="row">
          <button id="acceptTerms" class="btn btn-primary">Mwen dak√≤</button>
          <button id="cancelTerms" class="btn btn-accent">Retounen</button>
        </div>
      </div>
    </div>

    <!-- DASHBOARD + PAGES -->
    <div id="mainPages" class="hidden">
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900;font-size:20px">ECHANJ PLUS</div>
          <div>
            <div id="userEmail" class="muted small"></div>
            <button id="btnLogout" class="btn btn-accent" style="margin-top:6px">Dekonekte</button>
          </div>
        </div>
      </div>

      <!-- Welcome -->
      <div id="welcomeCard" class="card" style="margin-bottom:12px">
        <div id="welcomeText" class="center" style="font-size:18px;font-weight:700">Byenveni ‚Äî f√® premye tranzaksyon ou</div>
        <div class="muted center small" style="margin-top:8px">Ou ka f√® Voye Minit, Peman, Modifye Profil, gade About.</div>
        <div style="display:flex;justify-content:center;margin-top:10px"><button id="dismissWelcome" class="btn btn-accent">OK</button></div>
      </div>

      <!-- Pages container -->
      <div id="pages">
        <!-- Send minutes -->
        <div id="page-send" class="card hidden">
          <h3>Voye Minit</h3>
          <label>Operat√®</label>
          <select id="sendOperator"><option value="digicel">Digicel</option><option value="natcom">Natcom</option></select>
          <label>Kantite Minit</label><input id="sendMinutes" type="number" placeholder="eg. 50">
          <div class="row">
            <button id="btnComposeUSSD" class="btn btn-primary">Konpoze USSD</button>
            <button id="btnSaveSell" class="btn btn-accent">Sove k√≤m Vann</button>
          </div>
          <div class="muted small" style="margin-top:8px">Nimewo sist√®m: Digicel <b>+50947111123</b> ¬∑ Natcom <b>+50932160708</b></div>
        </div>

        <!-- Payment -->
        <div id="page-pay" class="card hidden">
          <h3>Peman & Wallet</h3>
          <div class="muted small">Sale Balance (minit): <span id="saleBalance">0</span> ‚Ä¢ Withdraw Balance (Gdes): <b id="withdrawBalance">0.00</b></div>
          <label>Met√≤d Peman</label>
          <select id="payMethod">
            <option value="moncash">MonCash</option>
            <option value="natcash">NatCash</option>
            <option value="paryajLakay">Paryaj Lakay</option>
            <option value="paryajPam">Paryaj Pam</option>
          </select>
          <label>Non Kont / Nimewo</label><input id="payAccount" placeholder="Non oswa Nimewo kont">
          <label>Montan (Gdes)</label><input id="payAmount" type="number" min="1" placeholder="eg. 500">
          <div class="row">
            <button id="btnSavePay" class="btn btn-primary">Sove / Peye</button>
            <button id="backFromPay" class="btn btn-accent">Tounen</button>
          </div>
        </div>

        <!-- Profile -->
        <div id="page-profile" class="card hidden">
          <h3>Pwofil</h3>
          <label>Non</label><input id="profileName">
          <label>Telef√≤n</label><input id="profilePhone">
          <label>Im√®l (readonly)</label><input id="profileEmail" readonly>
          <div class="row">
            <button id="btnSaveProfile" class="btn btn-primary">Sove</button>
            <button id="backFromProfile" class="btn btn-accent">Tounen</button>
          </div>
        </div>

        <!-- About -->
        <div id="page-about" class="card hidden">
          <h3>About</h3>
          <p class="muted small">Digicel: +50947111123 ¬∑ Natcom: +50932160708</p>
          <p class="muted small">Kontak: echanjplus@gmail.com</p>
          <p class="muted small">S√®vis sa a f√®t pou Ayiti. L√® gen kesyon kontakte nou sou WhatsApp.</p>
          <div class="row">
            <button id="openTermsFromAbout" class="btn btn-accent">Kondisyon</button>
            <button id="backFromAbout" class="btn btn-accent">Tounen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="bottom-nav" role="navigation" aria-label="Opsyon">
    <div class="nav-inner">
      <div id="nav-send" class="nav-btn inactive">üì§ Voye Minit</div>
      <div id="nav-pay" class="nav-btn inactive">üí≥ Peman</div>
      <div id="nav-profile" class="nav-btn inactive">üë§ Profil</div>
      <div id="nav-about" class="nav-btn inactive">‚ÑπÔ∏è About</div>
    </div>
  </nav>
</div>

<!-- Firebase v10 modular -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  /*************** Firebase config (youn ou te bay) ***************/
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.firebasestorage.app",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const fs = getFirestore(app);
  const rdb = getDatabase(app);

  /* --------- UI helpers --------- */
  const $ = id => document.getElementById(id);
  function show(el){ if(el) el.classList.remove('hidden'); el && (el.style.display='block'); }
  function hide(el){ if(el) el.classList.add('hidden'); el && (el.style.display='none'); }
  function toast(msg, t=3000){ const box = document.createElement('div'); box.textContent = msg; box.style.position='fixed'; box.style.left='50%'; box.style.transform='translateX(-50%)'; box.style.bottom='24px'; box.style.background='#FFD700'; box.style.color='#000'; box.style.padding='10px 14px'; box.style.borderRadius='10px'; box.style.fontWeight='800'; box.style.zIndex=99999; document.body.appendChild(box); setTimeout(()=>box.remove(), t); }
  function loader(on=true){ const l=$('loader'); if(on) l.style.display='flex'; else l.style.display='none'; }

  /* --------- Splash control: short (3.5s) --------- */
  setTimeout(()=> {
    $('splash').style.display='none';
    $('app').style.display='block';
    // show auth by default
    $('authCard').style.display='block';
  }, 3500); // 3.5 seconds

  /* --------- Auth UI wiring --------- */
  $('showSignup').addEventListener('click', ()=>{ $('loginForm').style.display='none'; $('signupForm').style.display='block'; });
  $('openSignup').addEventListener('click', ()=>{ $('loginForm').style.display='none'; $('signupForm').style.display='block'; });
  $('backToLogin').addEventListener('click', ()=>{ $('signupForm').style.display='none'; $('loginForm').style.display='block'; });
  $('openTermsLink').addEventListener('click', ()=>{ $('termsBox').style.display='block'; $('authForms').style.display='none'; });
  $('openTermsFromSignup').addEventListener('click', ()=>{ $('termsBox').style.display='block'; $('authForms').style.display='none'; });
  $('cancelTerms').addEventListener('click', ()=>{ $('termsBox').style.display='none'; $('authForms').style.display='block'; });
  $('acceptTerms').addEventListener('click', ()=>{ $('termsBox').style.display='none'; $('signupForm').style.display='block'; });

  /* --------- Signup & Login (Email/Password) --------- */
  $('btnSignup').addEventListener('click', async ()=>{
    const name = $('signupName').value.trim();
    const phone = $('signupPhone').value.trim();
    const email = $('signupEmail').value.trim();
    const pass = $('signupPassword').value;
    if(!name||!phone||!email||!pass){ toast('Ranpli tout chan yo'); return; }
    loader(true);
    try{
      const res = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = res.user.uid;
      // create user doc in Firestore
      await setDoc(doc(fs, 'users', uid), { name, email, phone, saleBalance:0, withdrawBalance:0, dateCreated: new Date().toISOString() });
      loader(false);
      toast('Kont kreye av√®k siks√®');
    }catch(err){
      loader(false); toast(err.message || 'Er√® signup');
      console.error(err);
    }
  });

  $('btnLogin').addEventListener('click', async ()=>{
    const email = $('loginEmail').value.trim();
    const pass = $('loginPassword').value;
    if(!email||!pass){ toast('Antre im√®l ak modpas'); return; }
    loader(true);
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      loader(false);
      toast('Konekte!');
    }catch(err){ loader(false); toast(err.message || 'Er√® login'); console.error(err); }
  });

  /* --------- Auth state --------- */
  onAuthStateChanged(auth, async user=>{
    if(user){
      // show main pages
      $('authCard').style.display='none';
      $('mainPages').classList.remove('hidden');
      // populate header
      $('userEmail').textContent = user.email || user.uid;
      // show welcome
      $('welcomeText').textContent = `Byenveni ${user.email || 'Itilizat√®'} ‚Äî se pou f√® premye tranzaksyon ou an.`;
      // load profile & balances
      try{
        const docRef = doc(fs, 'users', user.uid);
        const snap = await getDoc(docRef);
        if(snap.exists()){
          const d = snap.data();
          $('profileName').value = d.name || '';
          $('profilePhone').value = d.phone || '';
          $('profileEmail').value = d.email || user.email || '';
          $('saleBalance').textContent = d.saleBalance || 0;
          $('withdrawBalance').textContent = (Number(d.withdrawBalance || 0)).toFixed(2);
        } else {
          // create default doc
          await setDoc(docRef, { name: user.email || 'Itilizat√®', email: user.email || '', phone:'', saleBalance:0, withdrawBalance:0, dateCreated: new Date().toISOString() });
          $('profileEmail').value = user.email || '';
        }
      }catch(e){ console.error('load profile', e) }
    } else {
      // logged out
      $('mainPages').classList.add('hidden');
      $('authCard').style.display='block';
      $('authForms').style.display='block';
      $('termsBox').style.display='none';
      $('signupForm').style.display='none';
      $('loginForm').style.display='block';
    }
  });

  /* --------- Nav (bottom) & page switching --------- */
  function clearSections(){ ['page-send','page-pay','page-profile','page-about'].forEach(id=>$(id).classList.add('hidden')) }
  function setNavActive(key){
    ['nav-send','nav-pay','nav-profile','nav-about'].forEach(n=>$(n).classList.add('inactive'));
    if(key==='send') $('nav-send').classList.remove('inactive'); else $('nav-send').classList.add('inactive');
    if(key==='pay') $('nav-pay').classList.remove('inactive'); else $('nav-pay').classList.add('inactive');
    if(key==='profile') $('nav-profile').classList.remove('inactive'); else $('nav-profile').classList.add('inactive');
    if(key==='about') $('nav-about').classList.remove('inactive'); else $('nav-about').classList.add('inactive');
  }
  $('nav-send').addEventListener('click', ()=>{ clearSections(); $('page-send').classList.remove('hidden'); setNavActive('send'); });
  $('nav-pay').addEventListener('click', ()=>{ clearSections(); $('page-pay').classList.remove('hidden'); setNavActive('pay'); });
  $('nav-profile').addEventListener('click', ()=>{ clearSections(); $('page-profile').classList.remove('hidden'); setNavActive('profile'); });
  $('nav-about').addEventListener('click', ()=>{ clearSections(); $('page-about').classList.remove('hidden'); setNavActive('about'); });

  // dismiss welcome
  $('dismissWelcome').addEventListener('click', ()=>{ $('welcomeCard').style.display='none' });

  // quick back buttons
  $('backFromPay').addEventListener('click', ()=>{ clearSections(); setNavActive(null) });
  $('backFromProfile').addEventListener('click', ()=>{ clearSections(); setNavActive(null) });
  $('backFromAbout').addEventListener('click', ()=>{ clearSections(); setNavActive(null) });

  /* --------- Send minutes logic (sell) --------- */
  function computeGdesFromMinutes(mins){
    // 1 minute = 0.82 Gdes, system fee 17.5% -> user gets 82.5% of that
    const x = Number(mins) * 0.82 * 0.825;
    return Number(isFinite(x) ? x : 0);
  }

  $('btnComposeUSSD').addEventListener('click', ()=>{
    const op = $('sendOperator').value;
    const mins = Number($('sendMinutes').value);
    if(!mins || mins<=0){ toast('Antre kantite minit valab'); return; }
    const ussd = op==='digicel' ? `*128*50947111123*${mins}#` : `*123*88888888*32160708*${mins}#`;
    // open dialer (mobile), here we just attempt to open tel:
    window.location.href = `tel:${encodeURIComponent(ussd)}`;
  });

  $('btnSaveSell').addEventListener('click', async ()=>{
    const op = $('sendOperator').value;
    const mins = Number($('sendMinutes').value);
    if(!mins || mins<=0){ toast('Antre kantite minit valab'); return; }
    const us = auth.currentUser; if(!us){ toast('Pa konekte'); return; }
    loader(true);
    try{
      const gdes = computeGdesFromMinutes(mins);
      const userRef = doc(fs, 'users', us.uid);
      // increment saleBalance and withdrawBalance atomically (updateDoc)
      await updateDoc(userRef, { saleBalance: increment(mins), withdrawBalance: increment(gdes) });
      // log transaction in Realtime DB
      const txRef = push(ref(rdb, 'transactions')).key;
      await set(ref(rdb, `transactions/${txRef}`), { userId: us.uid, type:'sale', operator:op, minutes:mins, gdes, status:'pending', createdAt: Date.now() });
      loader(false);
      toast('Vann anrejistre; balans ajou.');
      // refresh profile values
      const snap = await getDoc(userRef);
      if(snap.exists()){
        const d = snap.data();
        $('saleBalance').textContent = d.saleBalance || 0;
        $('withdrawBalance').textContent = (Number(d.withdrawBalance || 0)).toFixed(2);
      }
    }catch(err){ loader(false); toast(err.message || 'Er√® sove'); console.error(err); }
  });

  /* --------- Payment / withdraw --------- */
  $('btnSavePay').addEventListener('click', async ()=>{
    const method = $('payMethod').value;
    const acc = $('payAccount').value.trim();
    const amount = Number($('payAmount').value);
    if(!amount || amount <= 0){ toast('Antre montan valid'); return; }
    const us = auth.currentUser; if(!us){ toast('Pa konekte'); return; }
    loader(true);
    try{
      const userRef = doc(fs, 'users', us.uid);
      const snap = await getDoc(userRef);
      const data = snap.exists() ? snap.data() : { withdrawBalance:0 };
      const current = Number(data.withdrawBalance || 0);
      if(current < amount){ loader(false); toast('Balans retire pa ase'); return; }
      // decrement withdrawBalance
      await updateDoc(userRef, { withdrawBalance: increment(-amount) });
      // write transaction in Realtime DB
      const txKey = push(ref(rdb, 'transactions')).key;
      await set(ref(rdb, `transactions/${txKey}`), { userId: us.uid, type:'withdraw', method, account:acc, amount, status:'pending', createdAt: Date.now() });
      loader(false);
      toast('Demann retr√® anrejistre. WhatsApp ap louvri.');
      // open WhatsApp for admin confirmation
      const msg = `Demann retr√®:\nUser: ${us.uid}\nMontan: ${amount} Gdes\nMet√≤d: ${method}\nKont: ${acc}\nTxID: ${txKey}`;
      window.open(`https://wa.me/50947111123?text=${encodeURIComponent(msg)}`, '_blank');
      // update UI
      const newSnap = await getDoc(userRef);
      const newData = newSnap.exists() ? newSnap.data() : {};
      $('withdrawBalance').textContent = (Number(newData.withdrawBalance || 0)).toFixed(2);
    }catch(err){ loader(false); toast(err.message || 'Er√® peman'); console.error(err); }
  });

  /* --------- Profile save --------- */
  $('btnSaveProfile').addEventListener('click', async ()=>{
    const name = $('profileName').value.trim();
    const phone = $('profilePhone').value.trim();
    const us = auth.currentUser; if(!us){ toast('Pa konekte'); return; }
    if(!name){ toast('Antre non'); return; }
    loader(true);
    try{
      const userRef = doc(fs, 'users', us.uid);
      await updateDoc(userRef, { name, phone });
      loader(false); toast('Profil mete ajou');
    }catch(err){ loader(false); toast(err.message || 'Er√®'); console.error(err); }
  });

  /* --------- Logout --------- */
  $('btnLogout').addEventListener('click', async ()=>{ try{ await auth.signOut(); toast('Ou dekonkte'); }catch(e){ console.error(e) } });

  /* --------- small UI helpers on load --------- */
  // show auth initially (app shown after splash)
  document.addEventListener('DOMContentLoaded', ()=> {
    // set initial nav inactive style
    ['nav-send','nav-pay','nav-profile','nav-about'].forEach(n=>$(n).classList.add('inactive'));
  });
</script>
</body>
  </html>
