<!DOCTYPE html>
<html lang="ht">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echanj Plus</title>
<style>
  /* ======= CSS GLOBAL ======= */
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
  .full-screen { width:100%; height:100vh; display:flex; justify-content:center; align-items:center; background:#eef2f3; }
  .card { background:white; padding:20px; border-radius:15px; box-shadow:0 0 15px rgba(0,0,0,0.2); width:90%; max-width:400px; }
  h2 { text-align:center; margin-bottom:20px; }
  input, select, textarea { width:100%; padding:10px; margin:5px 0 15px 0; border-radius:5px; border:1px solid #ccc; }
  button { padding:10px 15px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; margin-top:10px; width:100%; }
  button:hover { background:#0056b3; }
  .hidden { display:none; }
  .stars { display:flex; gap:5px; justify-content:center; margin-bottom:10px; cursor:pointer; }
  .star { font-size:24px; color:gray; }
  .star.selected { color:gold; }
</style>
</head>
<body>

<div id="signupScreen" class="full-screen">
  <div class="card">
    <h2>Enskri nan Echanj Plus</h2>
    <input type="text" id="fullName" placeholder="Non konplè">
    <input type="tel" id="phone" placeholder="Nimewo telefòn">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Modpas (Gwo lèt kòmanse)">
    <select id="gender">
      <option value="">Chwazi sèks</option>
      <option value="fi">Fi</option>
      <option value="gason">Gason</option>
    </select>
    <button onclick="signup()">Enskri</button>
    <p style="text-align:center;">Gen kont? <a href="#" onclick="showLogin()">Konekte</a></p>
  </div>
</div>

<div id="loginScreen" class="full-screen hidden">
  <div class="card">
    <h2>Konekte</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Modpas">
    <button onclick="login()">Konekte</button>
    <p style="text-align:center;">Pa gen kont? <a href="#" onclick="showSignup()">Enskri</a></p>
    <p style="text-align:center;"><a href="#" onclick="resetPassword()">Reinitialiser Modpas</a></p>
  </div>
</div>

<div id="profileScreen" class="full-screen hidden">
  <div class="card">
    <h2>Profile Ou</h2>
    <input type="text" id="profileName" placeholder="Non konplè">
    <input type="tel" id="profilePhone" placeholder="Nimewo telefòn">
    <select id="profileGender">
      <option value="">Chwazi sèks</option>
      <option value="fi">Fi</option>
      <option value="gason">Gason</option>
    </select>
    <button onclick="saveProfile()">Anrejistre Profile</button>
  </div>
</div>

<div id="dialerScreen" class="full-screen hidden">
  <div class="card">
    <h2>Voye Minit</h2>
    <input type="number" id="minutes" placeholder="Antre kantite minit">
    <select id="operator">
      <option value="">Chwazi operatè</option>
      <option value="digicel">Digicel</option>
      <option value="natcom">Natcom</option>
    </select>
    <p>Kantite w ap resevwa: <span id="amountReceived">0</span> gdes</p>
    <button onclick="sendUSSD()">Voye sou Dialer</button>
  </div>
</div>

<div id="commentScreen" class="full-screen hidden">
  <div class="card">
    <h2>Evalye Konfyans Sistèm nan</h2>
    <div class="stars" id="stars">
      <span class="star" onclick="selectStar(1)">⭐</span>
      <span class="star" onclick="selectStar(2)">⭐</span>
      <span class="star" onclick="selectStar(3)">⭐</span>
      <span class="star" onclick="selectStar(4)">⭐</span>
      <span class="star" onclick="selectStar(5)">⭐</span>
    </div>
    <textarea id="comment" placeholder="Kite komantè ou"></textarea>
    <button onclick="submitComment()">Soumèt</button>
  </div>
</div>

<div id="paymentScreen" class="full-screen hidden">
  <div class="card">
    <h2>Peman</h2>
    <select id="paymentMethod">
      <option value="">Chwazi metòd</option>
      <option value="moncash">Mon Cash</option>
      <option value="natcash">Nat Cash</option>
      <option value="paryaj_lakay">Paryaj Lakay</option>
      <option value="paryaj_pam">Paryaj Pam</option>
    </select>
    <input type="text" id="accountName" placeholder="Non kont lan">
    <input type="tel" id="accountNumber" placeholder="Nimewo kont lan">
    <input type="number" id="paymentMinutes" placeholder="Kantite minit" readonly>
    <button onclick="sendPayment()">Voye Peman</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ====== Firebase Config ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);

  let currentUser = null;
  let selectedStars = 0;
  const systemFees = 0.175; // 17.5%
  const systemNumbers = { digicel: '+50947111123', natcom: '32160708' };

  // ====== UI Functions ======
  function showLogin(){ document.getElementById('signupScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }
  function showSignup(){ document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('signupScreen').classList.remove('hidden'); }
  function showProfile(){ document.getElementById('profileScreen').classList.remove('hidden'); }
  function showDialer(){ document.getElementById('dialerScreen').classList.remove('hidden'); document.getElementById('profileScreen').classList.add('hidden'); }
  function showComment(){ document.getElementById('commentScreen').classList.remove('hidden'); document.getElementById('dialerScreen').classList.add('hidden'); }
  function showPayment(){ document.getElementById('paymentScreen').classList.remove('hidden'); document.getElementById('commentScreen').classList.add('hidden'); }

  // ====== Auth Functions ======
  function signup(){
    const name = document.getElementById('fullName').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const gender = document.getElementById('gender').value;
    if(!name || !phone || !email || !password || !gender){ alert("Ranpli tout chan yo"); return; }
    if(!password.match(/^[A-Z]/)){ alert("Modpas dwe kòmanse ak yon gwo lèt"); return; }

    firebase.auth().createUserWithEmailAndPassword(email, password)
    .then((userCredential)=>{
      currentUser = userCredential.user;
      // Save profile
      firebase.database().ref('users/' + currentUser.uid).set({ name, phone, email, gender });
      showProfile();
    }).catch(err=>alert(err.message));
  }

  function login(){
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    firebase.auth().signInWithEmailAndPassword(email, password)
    .then((userCredential)=>{ currentUser = userCredential.user; showProfile(); })
    .catch(err=>alert(err.message));
  }

  function resetPassword(){
    const email = prompt("Antre imel ou pou reinitialiser modpas:");
    if(email) firebase.auth().sendPasswordResetEmail(email).then(()=>alert("Imel voye")).catch(err=>alert(err.message));
  }

  // ====== Profile ======
  function saveProfile(){
    const name = document.getElementById('profileName').value;
    const phone = document.getElementById('profilePhone').value;
    const gender = document.getElementById('profileGender').value;
    if(!name || !phone || !gender){ alert("Ranpli tout chan yo"); return; }
    firebase.database().ref('users/' + currentUser.uid).update({ name, phone, gender });
    showDialer();
  }

  // ====== Dialer ======
  document.getElementById('minutes').addEventListener('input', ()=>{
    const mins = parseFloat(document.getElementById('minutes').value) || 0;
    const afterFee = mins * (1 - systemFees);
    document.getElementById('amountReceived').innerText = afterFee.toFixed(2);
    document.getElementById('paymentMinutes').value = afterFee.toFixed(2);
  });

  function sendUSSD(){
    const operator = document.getElementById('operator').value;
    const mins = parseFloat(document.getElementById('minutes').value) || 0;
    if(!operator || mins<=0){ alert("Chwazi operatè ak kantite minit"); return; }
    const number = systemNumbers[operator];
    let code = '';
    if(operator=='natcom'){ code=`*123*${number}*${mins}#`; }
    else if(operator=='digicel'){ code=`*128*50947111123*${mins}#`; }
    alert("Ou pral voye kòd: " + code);
    // Save to Firebase for verification
    firebase.database().ref('transactions/' + currentUser.uid).push({ operator, mins, amountReceived: mins*(1-systemFees), status:'sent' });
    showComment();
  }

  // ====== Comment ======
  function selectStar(n){ selectedStars=n; document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('selected', i<n)); }
  function submitComment(){
    const comment = document.getElementById('comment').value;
    if(selectedStars==0){ alert("Chwazi nivo konfyans"); return; }
    firebase.database().ref('comments/' + currentUser.uid).push({ stars:selectedStars, comment });
    showPayment();
  }

  // ====== Payment ======
  function sendPayment(){
    const method = document.getElementById('paymentMethod').value;
    const name = document.getElementById('accountName').value;
    const number = document.getElementById('accountNumber').value;
    const mins = parseFloat(document.getElementById('paymentMinutes').value);
    if(!method || !name || !number || !mins){ alert("Ranpli tout chan yo"); return; }
    firebase.database().ref('payments/' + currentUser.uid).push({ method, name, number, amount:mins });
    alert("Peman anrejistre epi voye sou WhatsApp!");
  }

  // ====== Auth Check ======
  firebase.auth().onAuthStateChanged(user=>{
    if(user){ currentUser=user; showProfile(); }
  });
</script>

</body>
    </html>
