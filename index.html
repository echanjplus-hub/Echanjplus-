<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Echanj Plus — Tout nan yon sèl</title>
<style>
:root{--bg:#071226;--card:#0f1720;--accent:#ffc107;--muted:rgba(255,255,255,0.7)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#071226,#0b1220);color:#fff;min-height:100vh}
.app{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.brand{color:var(--accent);font-weight:800;font-size:1.4rem}
.small{font-size:0.95rem;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.45)}
h2{margin:0;color:var(--accent)}
input,select,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:15px}
input::placeholder{color:rgba(255,255,255,0.45)}
button{background:var(--accent);color:#000;border:none;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.note{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;margin-top:8px;color:var(--muted)}
.small-note{font-size:0.9rem;color:var(--muted)}
.tx-list{max-height:260px;overflow:auto}
.hidden{display:none}
.footer{margin-top:16px;text-align:center;color:rgba(255,255,255,0.35)}
.row{display:flex;gap:8px}
.row button{flex:1}
.link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
.badge{background:rgba(255,193,7,0.12);padding:6px 12px;border-radius:999px;color:var(--accent);display:inline-block}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="brand">Echanj Plus</div>
      <div class="small">Vit • Senp • Serye</div>
    </div>
    <div id="topRight" style="text-align:right">
      <div id="userEmail" class="small hidden"></div>
      <button id="btnLogout" class="btn-ghost hidden" onclick="logout()" style="margin-top:6px">Dekonekte</button>
    </div>
  </div>

  <div class="grid">
    <main>
      <!-- REGISTER (default view) -->
      <section id="register" class="card">
        <h2>Enskripsyon (obligatwa)</h2>
        <div class="note">Ranpli tout chan sa yo pou kreye kont. Apre sa ou dwe konekte pou kontinye.</div>
        <input id="r_first" placeholder="Non" />
        <input id="r_last" placeholder="Prenon" />
        <input id="r_phone" placeholder="Nimewo telefòn (eg: 37123456 san +509)" />
        <input id="r_email" placeholder="Imèl" />
        <input id="r_pass" type="password" placeholder="Modpas (min 6 karaktè)" />
        <button id="btnRegister">Enskri</button>
        <div class="small-note" style="margin-top:8px">Si w gen yon kont deja, <span class="link-like" id="linkToLogin">konekte</span>.</div>
        <div id="regMsg" class="note hidden"></div>
      </section>

      <!-- LOGIN -->
      <section id="login" class="card hidden">
        <h2>Konekte</h2>
        <input id="l_email" placeholder="Imèl" />
        <input id="l_pass" type="password" placeholder="Modpas" />
        <button id="btnLogin">Konekte</button>
        <div class="small-note" style="margin-top:8px">Ou poko gen kont? <span class="link-like" id="linkToRegister">Enskri</span></div>
        <div id="loginMsg" class="note hidden"></div>
      </section>

      <!-- MINIT -->
      <section id="minit" class="card hidden">
        <h2>Voye Minit</h2>
        <div class="note">
          Enstriksyon: Chwazi operatè, antre montan, peze "Konpoze USSD" pou ouvri aplikasyon apèl la ak kòd la deja ekri. Apre ou fin fè transfè a sou rezo a, retounen sou sit la epi peze "Mwen voye minit" pou sistèm lan voye yon kòd sekirite sou WhatsApp/SMS.
        </div>

        <label class="small-note">Operatè</label>
        <select id="minit_operator">
          <option value="">-- Chwazi --</option>
          <option value="digicel">Digicel (100 - 1000 G)</option>
          <option value="natcom">Natcom (100 - 500 G)</option>
        </select>

        <input id="minit_amount" type="number" placeholder="Montan (G)" />

        <div class="row">
          <button id="btnCompose">Konpoze USSD</button>
          <button id="btnConfirmUSSD" class="btn-ghost">Konfime (Digicel)</button>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="btnIHaveSent" class="btn-ghost">Mwen voye minit</button>
          <button id="btnGoPayment" class="btn-ghost" disabled>Ale nan Peman</button>
        </div>

        <div id="minitMsg" class="note hidden"></div>

        <div style="margin-top:10px" class="note">
          <strong>USSD egzak:</strong><br/>
          Digicel: <code>*128*50947111123*100#</code> — Konfime: <code>*128*1#</code><br/>
          Natcom: <code>*123*88888888*32160708*100#</code>
        </div>
      </section>

      <!-- VERIFY CODE -->
      <section id="verify" class="card hidden">
        <h2>Antre Kòd Sistèm</h2>
        <div class="note">Apre ou fin voye minit la sistèm lan ap voye yon kòd sou WhatsApp/SMS pou ou. Mete kòd la pou jwenn aksè nan peman.</div>
        <input id="verify_code" placeholder="Antre kòd sistèm lan" />
        <button id="btnVerify">Verifye Kòd</button>
        <div id="verifyMsg" class="note hidden"></div>
      </section>

      <!-- PAYMENT -->
      <section id="payment" class="card hidden">
        <h2>Peman</h2>
        <div id="payWarn" class="note">Ou dwe voye minit epi verifye kòd sistèm lan avan pou antre enfòmasyon peman.</div>

        <label class="small-note">Chwazi mòd</label>
        <select id="pay_method" onchange="renderPayForm()">
          <option value="">-- Chwazi --</option>
          <option value="moncash">MonCash</option>
          <option value="natcash">NatCash</option>
          <option value="paryaj">Paryaj Lakay</option>
        </select>

        <div id="payForm"></div>
        <div id="payRes" class="note hidden"></div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="card hidden">
        <h2>Profil</h2>
        <div><strong>Non:</strong> <span id="pf_first"></span></div>
        <div><strong>Prenon:</strong> <span id="pf_last"></span></div>
        <div><strong>Nimewo:</strong> <span id="pf_phone"></span></div>
        <div><strong>Imel:</strong> <span id="pf_email"></span></div>
        <div style="margin-top:10px"><button id="btnRefreshProfile" class="btn-ghost">Refresh</button></div>
      </section>
    </main>

    <aside>
      <section class="card">
        <h3>Kontwòl</h3>
        <div id="statusBox" class="note">Non konekte</div>
        <div style="margin-top:8px" class="row">
          <button id="openProfile" class="btn-ghost">Profile</button>
          <button id="openTx" class="btn-ghost">Transactions</button>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <h3>Dashboard tranzaksyon</h3>
        <div id="txList" class="tx-list note">Pa gen tranzaksyon</div>
      </section>
    </aside>
  </div>

  <div class="footer">© Echanj Plus</div>
</div>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database-compat.js"></script>

<script>
/* ====== KONFIGIRE: Mete BACKEND_URL si diferan ====== */
const BACKEND_URL = "http://192.168.43.118:3000"; // ranplase ak IP/URL backend ou
const SYSTEM_WHATSAPP = "50947111123"; // san +

// FIREBASE CONFIG (ou te bay li)
const firebaseConfig = {
  apiKey: "AIzaSyAjK6EPlokkARHnakMaDRjqRzN-yQqlayU",
  authDomain: "echanj-plus.firebaseapp.com",
  projectId: "echanj-plus",
  storageBucket: "echanj-plus.firebasestorage.app",
  messagingSenderId: "117332306453",
  appId: "1:117332306453:web:41d04226aa15ca5c3fbc1c",
  measurementId: "G-LPGLMCR7HP"
};
/* ================================================== */

/* Initialize Firebase (IMPORTANT: do this BEFORE using auth/db) */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* UI refs */
const sectionRegister = document.getElementById('register');
const sectionLogin = document.getElementById('login');
const sectionMinit = document.getElementById('minit');
const sectionVerify = document.getElementById('verify');
const sectionPayment = document.getElementById('payment');
const sectionProfile = document.getElementById('profile');

const regMsg = document.getElementById('regMsg');
const loginMsg = document.getElementById('loginMsg');
const minitMsg = document.getElementById('minitMsg');
const verifyMsg = document.getElementById('verifyMsg');

const txList = document.getElementById('txList');
const statusBox = document.getElementById('statusBox');
const userEmailEl = document.getElementById('userEmail');
const btnLogoutEl = document.getElementById('btnLogout');

/* show only helper */
function showOnly(el){
  [sectionRegister, sectionLogin, sectionMinit, sectionVerify, sectionPayment, sectionProfile].forEach(s => s.classList.add('hidden'));
  el.classList.remove('hidden');
}

/* default: show register when no user */
showOnly(sectionRegister);

/* NAV handlers */
document.getElementById('linkToLogin').addEventListener('click', ()=> showOnly(sectionLogin));
document.getElementById('linkToRegister').addEventListener('click', ()=> showOnly(sectionRegister));
document.getElementById('openProfile').addEventListener('click', ()=> showOnly(sectionProfile));
document.getElementById('openTx').addEventListener('click', ()=> { showOnly(sectionMinit); loadTransactions(); });

/* REGISTER: create user, save profile, sign out immediately */
document.getElementById('btnRegister').addEventListener('click', async () => {
  regMsg.classList.add('hidden');
  const first = document.getElementById('r_first').value.trim();
  const last = document.getElementById('r_last').value.trim();
  let phone = document.getElementById('r_phone').value.trim();
  const email = document.getElementById('r_email').value.trim();
  const pass = document.getElementById('r_pass').value;

  if(!first || !last || !phone || !email || !pass){ regMsg.textContent='Ranpli tout chan yo.'; regMsg.classList.remove('hidden'); return; }
  if(pass.length < 6){ regMsg.textContent='Modpas dwe gen omwen 6 karaktè.'; regMsg.classList.remove('hidden'); return; }
  phone = phone.replace(/\D/g,'');

  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    await db.ref('users/' + uid + '/profile').set({ first, last, phone, email, createdAt: Date.now() });
    await auth.signOut(); // require login after register
    regMsg.textContent = 'Kont kreye avèk siksè. Tanpri konekte.';
    regMsg.classList.remove('hidden');
    setTimeout(()=> showOnly(sectionLogin), 1200);
  } catch(e){
    regMsg.textContent = 'Erè: ' + e.message;
    regMsg.classList.remove('hidden');
  }
});

/* LOGIN */
document.getElementById('btnLogin').addEventListener('click', async () => {
  loginMsg.classList.add('hidden');
  const email = document.getElementById('l_email').value.trim();
  const pass = document.getElementById('l_pass').value;
  if(!email || !pass){ loginMsg.textContent='Ranpli imèl ak modpas.'; loginMsg.classList.remove('hidden'); return; }
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged will handle view
  } catch(e){
    loginMsg.textContent = 'Erè: ' + e.message; loginMsg.classList.remove('hidden');
  }
});

/* AUTH STATE */
auth.onAuthStateChanged(async user => {
  if(user){
    userEmailEl.textContent = user.email; userEmailEl.classList.remove('hidden');
    btnLogoutEl.classList.remove('hidden');
    await loadProfile();
    await loadTransactions();
    showOnly(sectionMinit);
  } else {
    userEmailEl.classList.add('hidden');
    btnLogoutEl.classList.add('hidden');
    statusBox.textContent = 'Non konekte';
    txList.innerHTML = 'Pa gen tranzaksyon';
    showOnly(sectionRegister);
  }
});

/* LOGOUT */
function logout(){ auth.signOut(); }

/* USSD compose */
document.getElementById('btnCompose').addEventListener('click', () => {
  minitMsg.classList.add('hidden');
  const op = document.getElementById('minit_operator').value;
  const amt = parseInt(document.getElementById('minit_amount').value);
  if(!op){ minitMsg.textContent='Chwazi operatè a.'; minitMsg.classList.remove('hidden'); return; }
  if(!amt || amt < 100){ minitMsg.textContent='Antre montan valab (min 100 G).'; minitMsg.classList.remove('hidden'); return; }
  if(op === 'digicel' && (amt < 100 || amt > 1000)){ minitMsg.textContent='Digicel: limit 100 - 1000 G'; minitMsg.classList.remove('hidden'); return; }
  if(op === 'natcom' && (amt < 100 || amt > 500)){ minitMsg.textContent='Natcom: limit 100 - 500 G'; minitMsg.classList.remove('hidden'); return; }
  let code = '';
  if(op === 'digicel') code = `*128*50947111123*${amt}#`;
  else code = `*123*88888888*32160708*${amt}#`;
  window.location.href = 'tel:' + encodeURIComponent(code);
});

/* Digicel confirm quick dial */
document.getElementById('btnConfirmUSSD').addEventListener('click', () => {
  window.location.href = 'tel:' + encodeURIComponent('*128*1#');
});

/* After user pressed 'Mwen voye minit' */
document.getElementById('btnIHaveSent').addEventListener('click', async () => {
  minitMsg.classList.add('hidden');
  const user = auth.currentUser; if(!user){ alert('Ou dwe konekte.'); return; }
  const op = document.getElementById('minit_operator').value;
  const amt = parseInt(document.getElementById('minit_amount').value);
  if(!op || !amt){ minitMsg.textContent='Ranpli operatè ak montan.'; minitMsg.classList.remove('hidden'); return; }

  // save transaction and flag
  const txRef = db.ref('transactions').push();
  const txObj = { uid:user.uid, type:'minit', service:op, montan:amt, date:Date.now(), statut:'sent' };
  await txRef.set(txObj);
  await db.ref('users/' + user.uid + '/minitSent').set(true);

  // call backend to generate code and send to user (backend must implement)
  try {
    const pSnap = await db.ref('users/' + user.uid + '/profile').once('value');
    const p = pSnap.val() || {};
    const to = p.phone ? (p.phone.startsWith('509') ? '+'+p.phone : '+509'+p.phone) : null;
    const res = await fetch(BACKEND_URL + '/generate-code', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ uid:user.uid, to })
    });
    const j = await res.json();
    if(j && j.ok){
      minitMsg.textContent = 'Kòd sistèm lan voye sou WhatsApp/SMS. Antre li pou verifye epi jwenn aksè peman.';
      minitMsg.classList.remove('hidden');
      document.getElementById('btnGoPayment').disabled = false;
      setTimeout(()=> showOnly(sectionVerify), 900);
    } else {
      minitMsg.textContent = 'Pa rive voye kòd la: ' + (j && j.error ? j.error : 'erè sèvè');
      minitMsg.classList.remove('hidden');
    }
  } catch(e){
    minitMsg.textContent = 'Erè kontakte backend: ' + e.message; minitMsg.classList.remove('hidden');
  }
});

/* Navigate to payment - user must have minitSent & codeVerified */
document.getElementById('btnGoPayment').addEventListener('click', async () => {
  const user = auth.currentUser; if(!user){ alert('Ou dwe konekte.'); return; }
  const minit = (await db.ref('users/' + user.uid + '/minitSent').once('value')).val();
  if(!minit) return alert('Al voye minit lan avan ou antre nan paj peman.');
  showOnly(sectionVerify);
});

/* Verify code button */
document.getElementById('btnVerify').addEventListener('click', async () => {
  verifyMsg.classList.add('hidden');
  const code = document.getElementById('verify_code').value.trim();
  if(!code){ verifyMsg.textContent='Antre kòd la.'; verifyMsg.classList.remove('hidden'); return; }
  const user = auth.currentUser; if(!user){ alert('Ou dwe konekte.'); return; }

  try {
    const res = await fetch(BACKEND_URL + '/verify-code', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ uid:user.uid, code })
    });
    const j = await res.json();
    if(j && j.ok){
      await db.ref('users/' + user.uid + '/codeVerified').set(true);
      verifyMsg.textContent = 'Kòd verifye — kounye a ou gen aksè peman.';
      verifyMsg.classList.remove('hidden');
      setTimeout(()=> showOnly(sectionPayment), 900);
    } else {
      verifyMsg.textContent = 'Kòd pa kòrèk oswa ekspire.'; verifyMsg.classList.remove('hidden');
    }
  } catch(e){
    verifyMsg.textContent = 'Erè verifye kòd: ' + e.message; verifyMsg.classList.remove('hidden');
  }
});

/* Render payment form depending on method */
function renderPayForm(){
  const method = document.getElementById('pay_method').value;
  const holder = document.getElementById('payForm');
  holder.innerHTML = '';
  if(method === 'moncash' || method === 'natcash'){
    holder.innerHTML = `
      <input id="pay_name" placeholder="Non kont" />
      <input id="pay_num" placeholder="Nimewo kont" />
      <input id="pay_amount" type="number" placeholder="Montan (G)" />
      <button onclick="submitPayment('${method}')">Soumèt ${method}</button>
    `;
  } else if(method === 'paryaj'){
    holder.innerHTML = `
      <input id="pay_num" placeholder="Nimewo kont" />
      <input id="pay_amount" type="number" placeholder="Montan (G)" />
      <button onclick="submitPayment('paryaj')">Soumèt Pari Lakay</button>
    `;
  }
}

/* Submit payment */
async function submitPayment(method){
  const user = auth.currentUser; if(!user){ alert('Ou dwe konekte.'); return; }
  const minit = (await db.ref('users/' + user.uid + '/minitSent').once('value')).val();
  if(!minit) return alert('Ou dwe voye minit avan peman.');
  const verified = (await db.ref('users/' + user.uid + '/codeVerified').once('value')).val();
  if(!verified) return alert('Ou dwe verifye kòd sistèm lan avan peman.');

  let payload = { uid:user.uid, method, date:Date.now(), statut:'pending' };
  if(method === 'moncash' || method === 'natcash'){
    payload.name = document.getElementById('pay_name').value.trim();
    payload.num  = document.getElementById('pay_num').value.trim();
    payload.amount = parseInt(document.getElementById('pay_amount').value);
    if(!payload.name || !payload.num || !payload.amount) return alert('Ranpli tout chan yo.');
  } else {
    payload.num  = document.getElementById('pay_num').value.trim();
    payload.amount = parseInt(document.getElementById('pay_amount').value);
    if(!payload.num || !payload.amount) return alert('Ranpli tout chan yo.');
  }

  const txRef = db.ref('transactions').push();
  await txRef.set(payload);

  // open WhatsApp to system for confirmation
  const msg = `EchanjPlus\nUid:${user.uid}\nMetòd:${method}\nKont:${payload.num}\nMontan:${payload.amount} G\nTx:${txRef.key}`;
  window.open(`https://wa.me/${SYSTEM_WHATSAPP}?text=${encodeURIComponent(msg)}`, '_blank');

  document.getElementById('payRes').classList.remove('hidden');
  document.getElementById('payRes').textContent = 'Peman soumèt. Nou voye detay sou WhatsApp sistèm pou konfime.';
  loadTransactions();
}

/* Load profile & transactions */
async function loadProfile(){
  const user = auth.currentUser; if(!user) return;
  const pSnap = await db.ref('users/' + user.uid + '/profile').once('value');
  const p = pSnap.val() || {};
  document.getElementById('pf_first').textContent = p.first || '';
  document.getElementById('pf_last').textContent = p.last || '';
  document.getElementById('pf_phone').textContent = p.phone || '';
  document.getElementById('pf_email').textContent = p.email || user.email;
  statusBox.textContent = (p.first ? `${p.first} ${p.last || ''}` : user.email);
  userEmailEl.textContent = user.email; userEmailEl.classList.remove('hidden');
}

async function loadTransactions(){
  const user = auth.currentUser; if(!user) return;
  const snap = await db.ref('transactions').orderByChild('uid').equalTo(user.uid).once('value');
  const data = snap.val() || {};
  txList.innerHTML = '';
  const keys = Object.keys(data || {});
  if(keys.length === 0) txList.innerHTML = 'Pa gen tranzaksyon';
  keys.reverse().forEach(k=>{
    const t = data[k];
    const el = document.createElement('div');
    el.style.marginBottom = '8px';
    const date = t.date ? new Date(t.date).toLocaleString() : '';
    el.innerHTML = `<strong>${t.type || t.method || t.service || 'Tx'}</strong><div class="small-note">${date}</div><div>Montan: ${t.amount||t.montan||''} G</div>`;
    txList.appendChild(el);
  });
}

/* refresh profile */
document.getElementById('btnRefreshProfile').addEventListener('click', ()=> loadProfile());

/* initial: show register */
showOnly(sectionRegister);
</script>
</body>
  </html>
