<!doctype html>
<html lang="ht">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Echanj Plus — Dashboard</title>
  <style>
    :root{
      --bg:#071226; --card:#0f1720; --accent:#ffc107; --muted:#cfcfcf;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#071226,#06121a);color:#fff;min-height:100vh}
    .app{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .brand{color:var(--accent);font-weight:800;font-size:1.4rem}
    .small{font-size:0.95rem;color:var(--muted)}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:16px}
    @media(max-width:900px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
    nav button{display:block;width:100%;text-align:left;margin-bottom:8px;padding:10px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
    nav button.active{background:rgba(255,193,7,0.12);color:var(--accent);font-weight:700}
    .hidden{display:none}
    h2{margin:0;color:var(--accent)}
    input,select,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:15px}
    input::placeholder{color:rgba(255,255,255,0.45)}
    .btn{background:var(--accent);color:#000;border:none;cursor:pointer;font-weight:700;padding:10px;border-radius:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .note{background:var(--glass);padding:10px;border-radius:8px;margin-top:8px;color:var(--muted)}
    .row{display:flex;gap:8px}
    .row button{flex:1}
    code{background:rgba(255,255,255,0.04);padding:2px 6px;border-radius:6px}
    .msg{padding:8px;border-radius:6px;margin-top:8px}
    .err{background:#4a0000;color:#ffd1d1}
    .ok{background:#063;color:#c9ffd6}
    .tx-list{max-height:260px;overflow:auto;margin-top:8px}
    .profile-field{display:flex;gap:8px;align-items:center;margin-top:8px}
    .profile-field strong{width:110px;color:var(--muted)}
    footer{margin-top:16px;text-align:center;color:rgba(255,255,255,0.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    @media(max-width:540px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="brand">Echanj Plus</div>
        <div class="small">Vit • Senp • Serye</div>
      </div>
      <div class="top-actions">
        <div id="userEmail" class="small hidden"></div>
        <button id="btnLogout" class="btn-ghost hidden">Dekonekte</button>
      </div>
    </header>

    <div class="layout">
      <!-- NAV -->
      <aside class="panel">
        <nav>
          <button id="nav_send" class="active">Voye Minit (USSD)</button>
          <button id="nav_payment">Peman</button>
          <button id="nav_profile">Profil</button>
          <button id="nav_transactions">Tranzaksyon</button>
        </nav>
        <div class="note">
          Ou dwe konekte anvan w itilize sit la. Si ou pa konekte, paj login / enskripsyon ap parèt otomatikman.
        </div>
      </aside>

      <!-- MAIN -->
      <main>
        <!-- AUTH (login/signup) -->
        <section id="authPanel" class="panel">
          <h2>Konekte oswa Enskri (Obligatwa)</h2>
          <div id="authForms">
            <!-- Signup -->
            <div id="signupView">
              <div class="note">Kreye kont ak imel & modpas oswa konekte ak Google.</div>
              <input id="su_email" type="email" placeholder="Imel" />
              <input id="su_pass" type="password" placeholder="Modpas (min 6)" />
              <div class="row">
                <button id="btnSignup" class="btn">Enskri</button>
                <button id="btnGoogle" class="btn-ghost">Konekte ak Google</button>
              </div>
              <div class="small" style="margin-top:8px">Ou gen kont? <span id="showLogin" class="link-like" style="color:var(--accent);cursor:pointer">Konekte</span></div>
              <div id="authMsg" class="msg hidden"></div>
            </div>

            <!-- Login -->
            <div id="loginView" class="hidden">
              <div class="note">Konekte ak imel & modpas</div>
              <input id="li_email" type="email" placeholder="Imel" />
              <input id="li_pass" type="password" placeholder="Modpas" />
              <div class="row">
                <button id="btnLogin" class="btn">Konekte</button>
                <button id="showSignup" class="btn-ghost">Tounen Enskri</button>
              </div>
              <div class="small" style="margin-top:8px">Oublie modpas? <span id="btnReset" class="link-like" style="color:var(--accent);cursor:pointer">Reinitialiser</span></div>
              <div id="loginMsg" class="msg hidden"></div>
            </div>
          </div>
        </section>

        <!-- Send Minit -->
        <section id="sendPanel" class="panel hidden">
          <h2>Voye Minit</h2>
          <div class="note">Chwazi operatè, antre montan, epi peze “Konpoze USSD” pou louvri app apèl la. Apre w fin voye minit sou rezo a, retounen epi klike "Mwen voye minit".</div>

          <label class="small">Operatè</label>
          <select id="operator">
            <option value="">-- Chwazi --</option>
            <option value="digicel">Digicel (100 - 1000 G)</option>
            <option value="natcom">Natcom (100 - 500 G)</option>
          </select>

          <label class="small">Montan (G)</label>
          <input id="amount" type="number" placeholder="Eg: 100" min="100" />

          <div class="row">
            <button id="btnCompose" class="btn">Konpoze USSD</button>
            <button id="btnConfirmUSSD" class="btn-ghost">Konfime Digicel</button>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="btnIHaveSent" class="btn-ghost">Mwen voye minit</button>
            <button id="btnGoPayment" class="btn-ghost" disabled>Ale nan Peman</button>
          </div>

          <div id="sendMsg" class="msg hidden"></div>

          <div class="note" style="margin-top:10px">
            <strong>USSD egzak (eg):</strong><br/>
            Digicel: <code>*128*50947111123*100#</code> — Konfime: <code>*128*1#</code><br/>
            Natcom: <code>*123*88888888*32160708*100#</code>
          </div>
        </section>

        <!-- Payment (disabled until minit sent & verified) -->
        <section id="paymentPanel" class="panel hidden">
          <h2>Peman</h2>
          <div id="payNotice" class="note">Ou dwe voye minit epi mete kòd sistèm lan pou gen aksè peman. (Kòd voye pa sistèm sou WhatsApp/SMS apre ou klike "Mwen voye minit").</div>

          <label class="small">Chwazi metòd</label>
          <select id="payMethod">
            <option value="">-- Chwazi --</option>
            <option value="moncash">MonCash</option>
            <option value="natcash">NatCash</option>
            <option value="paryaj">Paryaj Lakay</option>
          </select>

          <div id="payForm"></div>
          <div id="payResult" class="msg hidden"></div>
        </section>

        <!-- Profile -->
        <section id="profilePanel" class="panel hidden">
          <h2>Profil Ou</h2>
          <div class="note">Ou ka modifye enfòmasyon sa yo.</div>
          <div class="profile-field"><strong>Non:</strong><input id="pf_first" placeholder="Non" /></div>
          <div class="profile-field"><strong>Prenon:</strong><input id="pf_last" placeholder="Prenon" /></div>
          <div class="profile-field"><strong>Telefòn:</strong><input id="pf_phone" placeholder="37123456 (san +509)" /></div>
          <div class="profile-field"><strong>Imel:</strong><input id="pf_email" disabled /></div>
          <div style="margin-top:10px" class="row">
            <button id="btnSaveProfile" class="btn">Sove</button>
            <button id="btnRefreshProfile" class="btn-ghost">Refresh</button>
          </div>
          <div id="profileMsg" class="msg hidden"></div>
        </section>

        <!-- Transactions -->
        <section id="txPanel" class="panel hidden">
          <h2>Tranzaksyon Ou</h2>
          <div id="txList" class="tx-list note">Chajman..</div>
        </section>

      </main>
    </div>

    <footer class="small">© Echanj Plus</footer>
  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      get,
      child,
      query,
      orderByChild,
      equalTo
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    /* ========== CONFIG - modify if needed ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyAjK6EPlokkARHnakMaDRjqRzN-yQqlayU",
      authDomain: "echanj-plus.firebaseapp.com",
      projectId: "echanj-plus",
      storageBucket: "echanj-plus.firebasestorage.app",
      messagingSenderId: "117332306453",
      appId: "1:117332306453:web:41d04226aa15ca5c3fbc1c",
      measurementId: "G-LPGLMCR7HP"
    };
    const BACKEND_URL = "http://192.168.43.118:3000"; // change if needed
    const SYSTEM_WHATSAPP = "50947111123"; // no plus

    /* ============================================ */

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI helpers
    const $ = id => document.getElementById(id);
    const panels = {
      auth: $('authPanel'),
      send: $('sendPanel'),
      payment: $('paymentPanel'),
      profile: $('profilePanel'),
      tx: $('txPanel')
    };
    const navButtons = {
      send: $('nav_send'),
      payment: $('nav_payment'),
      profile: $('nav_profile'),
      tx: $('nav_transactions')
    };

    // initial view: show auth
    function showPanel(panel){
      // enforce mandatory auth: if not logged in, always show authPanel
      if(!currentUser) { // will be updated via onAuthStateChanged
        panels.auth.classList.remove('hidden');
        panels.send.classList.add('hidden');
        panels.payment.classList.add('hidden');
        panels.profile.classList.add('hidden');
        panels.tx.classList.add('hidden');
        return;
      }
      // show requested panel
      panels.auth.classList.add('hidden');
      panels.send.classList.add('hidden');
      panels.payment.classList.add('hidden');
      panels.profile.classList.add('hidden');
      panels.tx.classList.add('hidden');
      panel.classList.remove('hidden');
      // update nav active
      Object.values(navButtons).forEach(b=>b.classList.remove('active'));
      if(panel === panels.send) navButtons.send.classList.add('active');
      if(panel === panels.payment) navButtons.payment.classList.add('active');
      if(panel === panels.profile) navButtons.profile.classList.add('active');
      if(panel === panels.tx) navButtons.tx.classList.add('active');
    }

    // nav listeners
    navButtons.send.addEventListener('click', ()=> showPanel(panels.send));
    navButtons.payment.addEventListener('click', async ()=>{
      // verify minit sent or verified? we simply show panel but also check later on actions
      showPanel(panels.payment);
    });
    navButtons.profile.addEventListener('click', ()=> showPanel(panels.profile));
    navButtons.tx.addEventListener('click', ()=> { loadTransactions(); showPanel(panels.tx); });

    // Auth UI
    $('showLogin').addEventListener('click', ()=> { $('signupView').classList.add('hidden'); $('loginView').classList.remove('hidden'); });
    $('showSignup').addEventListener('click', ()=> { $('loginView').classList.add('hidden'); $('signupView').classList.remove('hidden'); });

    // Signup
    $('btnSignup').addEventListener('click', async ()=>{
      setMsg('authMsg');
      const email = $('su_email').value.trim();
      const pass  = $('su_pass').value;
      if(!email || pass.length < 6){ setMsg('authMsg','Ranpli imèl ak modpas (min 6 chars).','err'); return; }
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        setMsg('authMsg','Kont kreye. Tanpri konekte.', 'ok');
        $('su_email').value=''; $('su_pass').value='';
        $('signupView').classList.add('hidden'); $('loginView').classList.remove('hidden');
      } catch(e){
        setMsg('authMsg', e.message, 'err');
      }
    });

    // Google sign-in
    $('btnGoogle').addEventListener('click', async ()=>{
      setMsg('authMsg');
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        // onAuthStateChanged will handle redirect
      } catch(e){
        setMsg('authMsg', e.message, 'err');
      }
    });

    // Login
    $('btnLogin').addEventListener('click', async ()=>{
      setMsg('loginMsg');
      const email = $('li_email').value.trim();
      const pass  = $('li_pass').value;
      if(!email || !pass){ setMsg('loginMsg','Ranpli imèl ak modpas','err'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged will redirect
      } catch(e){
        setMsg('loginMsg', e.message, 'err');
      }
    });

    // Reset password
    $('btnReset').addEventListener('click', async ()=>{
      const email = prompt('Antre imel ou pou resevwa lyen reinitializasyon:');
      if(!email) return;
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Lyenn reset te voye sou imel la.');
      } catch(e){
        alert('Erè: ' + e.message);
      }
    });

    // Logout
    $('btnLogout').addEventListener('click', async ()=> {
      await signOut(auth);
    });

    // small helper to show messages
    function setMsg(id, text='', kind=''){
      const el = $(id);
      if(!el) return;
      if(!text){ el.classList.add('hidden'); el.textContent=''; return; }
      el.textContent = text;
      el.classList.remove('hidden');
      el.classList.remove('err','ok');
      if(kind === 'err') el.classList.add('err');
      if(kind === 'ok') el.classList.add('ok');
    }

    // AUTH STATE
    let currentUser = null;
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if(user){
        $('userEmail').textContent = user.email || user.phoneNumber || 'Itilizatè';
        $('userEmail').classList.remove('hidden');
        $('btnLogout').classList.remove('hidden');
        // show dashboard (send)
        await loadProfile();
        await loadTransactions();
        showPanel(panels.send);
      } else {
        // show auth view
        $('userEmail').classList.add('hidden');
        $('btnLogout').classList.add('hidden');
        setMsg('authMsg'); setMsg('loginMsg');
        $('signupView').classList.remove('hidden'); $('loginView').classList.add('hidden');
        showPanel(panels.auth);
      }
    });

    /* =========================
       SEND MINIT (USSD) LOGIC
       ========================= */
    $('btnCompose').addEventListener('click', ()=>{
      setMsg('sendMsg');
      const op = $('operator').value;
      const amt = parseInt($('amount').value);
      if(!op){ setMsg('sendMsg','Chwazi operatè a.','err'); return; }
      if(!amt || amt < 100){ setMsg('sendMsg','Antre montan valab (min 100).','err'); return; }
      if(op === 'digicel' && (amt < 100 || amt > 1000)){ setMsg('sendMsg','Digicel: limit 100 - 1000 G','err'); return; }
      if(op === 'natcom' && (amt < 100 || amt > 500)){ setMsg('sendMsg','Natcom: limit 100 - 500 G','err'); return; }
      let ussd = op === 'digicel' ? `*128*50947111123*${amt}#` : `*123*88888888*32160708*${amt}#`;
      // open dialer
      window.location.href = 'tel:' + encodeURIComponent(ussd);
    });

    $('btnConfirmUSSD').addEventListener('click', ()=>{
      // digicel confirm code
      window.location.href = 'tel:' + encodeURIComponent('*128*1#');
    });

    // After user claims they sent minit
    $('btnIHaveSent').addEventListener('click', async ()=>{
      setMsg('sendMsg');
      if(!currentUser){ alert('Ou dwe konekte.'); return; }
      const op = $('operator').value;
      const amt = parseInt($('amount').value);
      if(!op || !amt){ setMsg('sendMsg','Ranpli operatè ak montan anvan.', 'err'); return; }
      // save transaction
      try {
        const txRef = push(ref(db, 'transactions'));
        const txObj = { uid: currentUser.uid, service: op, amount: amt, status: 'sent', date: Date.now() };
        await set(txRef, txObj);
        // mark user has sent minit
        await set(ref(db, 'users/' + currentUser.uid + '/minitSent'), true);
        // call backend to generate system code (optional) - only if BACKEND_URL configured
        if(BACKEND_URL){
          try {
            const profSnap = await get(child(ref(db), `users/${currentUser.uid}/profile`));
            const prof = profSnap.val() || {};
            const to = prof.phone ? (prof.phone.startsWith('509') ? '+'+prof.phone : '+509'+prof.phone) : null;
            const resp = await fetch(BACKEND_URL + '/generate-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid: currentUser.uid, to })});
            const j = await resp.json();
            if(j && j.ok) setMsg('sendMsg','Kòd sistèm lan voye sou WhatsApp/SMS. Antre li pou verifye epi jwenn aksè peman.','ok');
            else setMsg('sendMsg','Pa rive voye kòd la: ' + (j && j.error ? j.error : 'erè sèvè'),'err');
          } catch(e){
            setMsg('sendMsg','Erè kontakte backend: ' + e.message,'err');
          }
        } else {
          setMsg('sendMsg','Tranzaksyon an anrejistre. (BACKEND pa configuré pou kòd sistèm)','ok');
        }
        $('btnGoPayment').disabled = false;
      } catch(e){
        setMsg('sendMsg','Erè rekò: ' + e.message,'err');
      }
    });

    // go to payment (disable if user hasn't sent minit)
    $('btnGoPayment').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Ou dwe konekte.');
      const snap = await get(child(ref(db), `users/${currentUser.uid}/minitSent`));
      const sent = snap.exists() ? snap.val() : false;
      if(!sent) return alert('Al voye minit lan avan ou antre nan peman.');
      showPanel(panels.payment);
    });

    /* =========================
       PAYMENT FORM RENDER & SUBMIT
       ========================= */
    window.renderPayForm = function(){
      const m = $('payMethod').value;
      const holder = $('payForm');
      holder.innerHTML = '';
      if(m === 'moncash' || m === 'natcash'){
        holder.innerHTML = `
          <input id="p_name" placeholder="Non kont" />
          <input id="p_num" placeholder="Nimewo kont" />
          <input id="p_amount" type="number" placeholder="Montan (G)" />
          <button id="btnSubmitPay" class="btn">Soumèt Peman</button>
        `;
        document.getElementById('btnSubmitPay').addEventListener('click', ()=> submitPayment(m));
      } else if(m === 'paryaj'){
        holder.innerHTML = `
          <input id="p_num" placeholder="Nimewo kont" />
          <input id="p_amount" type="number" placeholder="Montan (G)" />
          <button id="btnSubmitPay" class="btn">Soumèt Pari Lakay</button>
        `;
        document.getElementById('btnSubmitPay').addEventListener('click', ()=> submitPayment('paryaj'));
      }
    };
    $('payMethod').addEventListener('change', renderPayForm);

    async function submitPayment(method){
      if(!currentUser) return alert('Ou dwe konekte.');
      // basic checks
      const pnum = (document.getElementById('p_num')||{}).value || '';
      const pamount = parseInt((document.getElementById('p_amount')||{}).value || 0);
      if(!pnum || !pamount) return alert('Ranpli tout chan peman yo.');
      try {
        const txRef = push(ref(db, 'transactions'));
        const payload = { uid: currentUser.uid, method, num: pnum, amount: pamount, date: Date.now(), status: 'pending' };
        await set(txRef, payload);
        // open whatsapp to system
        const msg = `EchanjPlus\nUid:${currentUser.uid}\nMetòd:${method}\nKont:${pnum}\nMontan:${pamount} G\nTx:${txRef.key}`;
        window.open(`https://wa.me/${SYSTEM_WHATSAPP}?text=${encodeURIComponent(msg)}`, '_blank');
        $('payResult').classList.remove('hidden'); $('payResult').textContent = 'Peman soumèt. Nou voye detay sou WhatsApp sistèm pou konfime.';
        loadTransactions();
      } catch(e){
        alert('Erè soumèt peman: ' + e.message);
      }
    }

    /* =========================
       PROFILE LOAD / SAVE
       ========================= */
    $('btnSaveProfile').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Ou dwe konekte.');
      const first = $('pf_first').value.trim();
      const last  = $('pf_last').value.trim();
      let phone = $('pf_phone').value.trim().replace(/\D/g,'');
      if(phone && !phone.startsWith('509')) phone = '509' + phone; // store without plus
      if(!first || !last) return setMsg('profileMsg','Ranpli non ak prenon','err');
      try {
        await set(ref(db, `users/${currentUser.uid}/profile`), { first, last, phone, email: currentUser.email || null, updated: Date.now() });
        setMsg('profileMsg','Profil an sove.','ok');
      } catch(e){
        setMsg('profileMsg','Erè sove: ' + e.message,'err');
      }
    });

    $('btnRefreshProfile').addEventListener('click', loadProfile);

    async function loadProfile(){
      if(!currentUser) return;
      try {
        const snap = await get(child(ref(db), `users/${currentUser.uid}/profile`));
        const p = snap.exists() ? snap.val() : {};
        $('pf_first').value = p.first || '';
        $('pf_last').value = p.last || '';
        $('pf_phone').value = p.phone ? (p.phone.startsWith('509') ? p.phone.slice(3) : p.phone) : '';
        $('pf_email').value = currentUser.email || '';
      } catch(e){
        console.error('loadProfile err', e);
      }
    }

    /* =========================
       TRANSACTIONS LOAD
       ========================= */
    async function loadTransactions(){
      if(!currentUser){ $('txList').innerHTML = 'Pa gen itilizatè'; return; }
      const q = query(ref(db, 'transactions'), orderByChild('uid'), equalTo(currentUser.uid));
      try {
        const snap = await get(q);
        const data = snap.exists() ? snap.val() : {};
        $('txList').innerHTML = '';
        const keys = Object.keys(data || {});
        if(keys.length === 0){ $('txList').innerHTML = '<div class="note">Pa gen tranzaksyon</div>'; return; }
        keys.reverse().forEach(k=>{
          const t = data[k];
          const div = document.createElement('div');
          div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
          const date = t.date ? new Date(t.date).toLocaleString() : '';
          div.innerHTML = `<strong>${t.service || t.method || 'Tx'}</strong> <div class="small">${date}</div><div>Montan: ${t.amount || t.amount || ''} G</div><div class="small">Statut: ${t.status||''}</div>`;
          $('txList').appendChild(div);
        });
      } catch(e){
        console.error('err tx', e);
        $('txList').innerHTML = '<div class="note">Erè chaje tranzaksyon</div>';
      }
    }

    // initial state
    showPanel(panels.auth);

    // expose firebase objects for debug (remove in production)
    window._auth = auth;
    window._db = db;

  </script>
</body>
</html>
