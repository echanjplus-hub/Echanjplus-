<!DOCTYPE html>
<html lang="ht">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Echanj Plus</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; background: #f9f9f9; color: #333;
    }
    .hidden { display: none; }
    .center { display: flex; align-items: center; justify-content: center; height: 100vh; }
    .card {
      background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px; width: 100%;
    }
    input, select, button {
      width: 100%; padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc;
    }
    button {
      background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold;
    }
    button:hover { background: #0056b3; }
    #loadingScreen {
      position: fixed; top:0; left:0; width:100%; height:100%; background:white;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #loadingScreen img { width: 120px; margin-bottom: 20px; }
    #dashboard { padding: 20px; }
    .ussd-buttons button { margin: 5px 0; background: green; }
    .logout { background: red; margin-top: 20px; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <img src="https://via.placeholder.com/120?text=Echanj+Plus" alt="Logo" />
    <p>Tanpri tann...</p>
  </div>

  <!-- Login/Signup -->
  <div id="authSection" class="center hidden">
    <div class="card">
      <h2>Konekte oswa Enskri</h2>
      <input type="email" id="email" placeholder="Imel" />
      <input type="password" id="password" placeholder="Modpas" />
      <button onclick="login()">Konekte</button>
      <button onclick="signup()">Enskri</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <h2>Byenvini <span id="userEmail"></span></h2>

    <!-- USSD Section -->
    <h3>Tranzaksyon Minit</h3>
    <input type="number" id="montanMinit" placeholder="Montan minit la" />
    <div class="ussd-buttons">
      <button onclick="sendUSSD('digicel')">Voye Digicel</button>
      <button onclick="confirmUSSD('digicel')">Konfime Digicel</button>
      <button onclick="sendUSSD('natcom')">Voye Natcom</button>
    </div>

    <!-- Payment Section -->
    <h3>Peman</h3>
    <select id="paymentMethod" onchange="showPaymentForm()">
      <option value="">-- Chwazi yon metod --</option>
      <option value="moncash">MonCash</option>
      <option value="natcash">NatCash</option>
      <option value="paryajLakay">Paryaj Lakay</option>
      <option value="paryajPam">Paryaj Pam</option>
    </select>

    <div id="paymentForm"></div>

    <button class="logout" onclick="logout()">Dekonekte</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
      authDomain: "echanj-plus-778cd.firebaseapp.com",
      databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
      projectId: "echanj-plus-778cd",
      storageBucket: "echanj-plus-778cd.firebasestorage.app",
      messagingSenderId: "111144762929",
      appId: "1:111144762929:web:e64ce9a6da65781c289f10",
      measurementId: "G-J1BQRF32ZW"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI Controls
    const loadingScreen = document.getElementById('loadingScreen');
    const authSection = document.getElementById('authSection');
    const dashboard = document.getElementById('dashboard');
    const userEmail = document.getElementById('userEmail');

    window.onload = () => {
      setTimeout(() => {
        auth.onAuthStateChanged(user => {
          loadingScreen.style.display = "none";
          if(user){
            dashboard.classList.remove("hidden");
            userEmail.textContent = user.email;
          }else{
            authSection.classList.remove("hidden");
          }
        });
      }, 1500);
    };

    function login(){
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass).catch(e=>alert(e.message));
    }
    function signup(){
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass).catch(e=>alert(e.message));
    }
    function logout(){ auth.signOut(); location.reload(); }

    // USSD Dial
    function sendUSSD(type){
      const montan = document.getElementById('montanMinit').value;
      let code="";
      if(type=="digicel"){ code = `tel:*128*50947111123*${montan}#`; }
      if(type=="natcom"){ code = `tel:*123*88888888*32160708*${montan}#`; }
      window.location.href = code;
    }
    function confirmUSSD(type){
      if(type=="digicel"){ window.location.href = "tel:*128*1#"; }
    }

    // Payment
    function showPaymentForm(){
      const method = document.getElementById('paymentMethod').value;
      let form = "";
      if(method=="moncash" || method=="natcash"){
        form += '<input id="pName" placeholder="Non kont lan"/>';
        form += '<input id="pNumber" placeholder="Nimewo kont lan"/>';
        form += '<input id="pAmount" placeholder="Montan kob la"/>';
      }
      if(method=="paryajLakay" || method=="paryajPam"){
        form += '<input id="pNumber" placeholder="Nimewo kont lan"/>';
        form += '<input id="pAmount" placeholder="Montan kob la"/>';
      }
      form += '<button onclick="sendPayment()">Voye Peman</button>';
      document.getElementById('paymentForm').innerHTML = form;
    }

    function sendPayment(){
      const method = document.getElementById('paymentMethod').value;
      const uid = auth.currentUser.uid;
      let name = document.getElementById('pName')?.value || "";
      let number = document.getElementById('pNumber').value;
      let amount = document.getElementById('pAmount').value;

      // Save in Firebase
      const ref = db.ref("payments").push();
      ref.set({uid, method, name, number, amount, time: Date.now()});

      // Open WhatsApp
      let msg = `Met√≤d: ${method}%0A Non: ${name}%0A Nimewo: ${number}%0A Montan: ${amount} HTG`;
      window.open(`https://wa.me/50947111123?text=${msg}`, "_blank");
    }
  </script>
</body>
</html>
