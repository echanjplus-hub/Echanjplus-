<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Echanj Plus ‚Äî v5.0.1</title>
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --accent:#0ea5e9; --muted:#64748b;
    --primary:#2563eb; --danger:#ef4444; --success:#10b981;
    --radius:12px;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f172a}
  /* fullscreen overlay for auth */
  .full-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#f8fafc,#eef2f7);z-index:9999}
  .auth-card{width:100%;max-width:420px;background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,0.08);padding:22px;border:1px solid rgba(2,6,23,0.06)}
  h1,h2{margin:0}
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);margin-top:10px;font-size:14px;background:transparent}
  button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(180deg,var(--primary),#1d4ed8);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
  .link{color:var(--primary);cursor:pointer;text-decoration:underline;font-size:13px}
  /* App layout */
  .app{display:flex;height:100vh;width:100vw;overflow:hidden}
  .sidebar{width:260px;background:linear-gradient(180deg,#0b1220,#071022);color:#e6eef8;padding:18px;flex-shrink:0;transition:transform .28s ease;box-shadow:2px 0 18px rgba(2,6,23,0.12)}
  .sidebar .brand{display:flex;align-items:center;gap:12px}
  .sidebar h2{color:var(--accent);font-size:18px}
  .sidebar .menu{margin-top:18px;display:flex;flex-direction:column;gap:8px}
  .menu button{background:transparent;border:0;color:inherit;text-align:left;padding:10px;border-radius:8px;cursor:pointer}
  .menu button.active{background:rgba(255,255,255,0.03)}
  .content{flex:1;padding:20px;overflow:auto}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(2,6,23,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.03)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .tx-list{max-height:420px;overflow:auto;margin-top:10px}
  .tx-item{padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(2,6,23,0.03);background:linear-gradient(180deg, rgba(2,6,23,0.01), transparent)}
  /* sidebar collapse (mobile) */
  .sidebar-collapsed{transform:translateX(-100%)}
  .sidebar-toggle{display:none}
  /* toast & spinner */
  .toast{position:fixed;right:18px;bottom:18px;background:#0b1220;color:#e6eef8;padding:12px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.2);z-index:2000;display:flex;flex-direction:column;gap:6px;min-width:220px}
  .toast.hide{display:none}
  .spinner{border:4px solid rgba(0,0,0,0.06);border-top:4px solid var(--primary);border-radius:50%;width:36px;height:36px;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* responsive */
  @media (max-width:980px){
    .grid{grid-template-columns:1fr}
    .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:10000}
    .sidebar-toggle{display:inline-block}
  }
  /* stars */
  .stars{display:flex;gap:6px;cursor:pointer}
  .star{font-size:20px;color:#cbd5e1}
  .star.selected{color:#f59e0b}
  /* badge */
  .pill{display:inline-block;padding:4px 8px;background:#0f172a;color:#cfe9ff;border-radius:999px;font-size:13px}
</style>
</head>
<body>

<!-- AUTH FULLSCREEN (login/signup/reset) -->
<div id="authOverlay" class="full-screen">
  <div class="auth-card" id="authCard">
    <h2 id="authTitle">Konekte / Enskri</h2>
    <div id="authBody">
      <!-- toggled content -->
      <div id="signupForm" style="display:block">
        <label class="small">Non konpl√®</label>
        <input id="su_name" placeholder="Non konpl√®"/>
        <label class="small">Telef√≤n (+509...)</label>
        <input id="su_phone" placeholder="+509XXXXXXXX" />
        <label class="small">S√®ks</label>
        <select id="su_gender"><option value="">Chwazi</option><option value="gason">Gason</option><option value="fi">Fi</option></select>
        <label class="small">Im√®l</label>
        <input id="su_email" placeholder="imel@egzanp.com" />
        <label class="small">Modpas (k√≤manse ak gwo l√®t)</label>
        <input id="su_pass" type="password" placeholder="Eg: Password123" />
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doSignUp" class="btn-primary" style="flex:1">Enskri</button>
          <button id="toLogin" class="btn-ghost" style="flex:1">Konekte</button>
        </div>
        <div class="muted" style="margin-top:8px">Si w deja gen kont, klike "Konekte".</div>
        <div id="authMsg" class="muted" style="margin-top:6px;color:salmon"></div>
      </div>

      <div id="loginForm" style="display:none">
        <label class="small">Im√®l</label>
        <input id="li_email" placeholder="imel@egzanp.com" />
        <label class="small">Modpas</label>
        <input id="li_pass" type="password" placeholder="Modpas" />
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doLogin" class="btn-primary" style="flex:1">Konekte</button>
          <button id="toSignup" class="btn-ghost" style="flex:1">Enskri</button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <span id="forgotLink" class="link">Bliye modpas?</span>
          <span id="guestBtn" class="link">Teste k√≤m Guest</span>
        </div>
        <div id="loginMsg" class="muted" style="margin-top:6px;color:salmon"></div>
      </div>

      <div id="resetForm" style="display:none">
        <label class="small">Antre im√®l ou pou reset</label>
        <input id="reset_email" placeholder="imel@egzanp.com"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doReset" class="btn-primary" style="flex:1">Voye</button>
          <button id="backLogin" class="btn-ghost" style="flex:1">Retounen</button>
        </div>
        <div id="resetMsg" class="muted" style="margin-top:6px;color:salmon"></div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appRoot" class="app" style="display:none">
  <aside id="sidebar" class="sidebar">
    <div class="brand">
      <div style="width:44px;height:44px;border-radius:10px;background:#071022;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800">EP</div>
      <div>
        <h2>Echanj Plus</h2>
        <div class="muted" id="userBadge">‚Äî</div>
      </div>
    </div>

    <div class="menu" style="margin-top:18px">
      <button class="menu-btn active" data-section="dashboard">üè† Dashboard</button>
      <button class="menu-btn" data-section="profile">üë§ Profile</button>
      <button class="menu-btn" data-section="dialer">üìû Voye Minit</button>
      <button class="menu-btn" data-section="feedback">‚≠ê Feedback</button>
      <button class="menu-btn" data-section="payments">üíµ Peman</button>
      <button class="menu-btn" data-section="transactions">üìÇ Tranzaksyon</button>
      <button class="menu-btn" data-section="help">‚ùì Kontakte</button>
    </div>

    <div style="margin-top:18px;display:flex;flex-direction:column;gap:8px">
      <button id="logout" class="btn-ghost">Dekonekte</button>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="toggleSidebar" class="btn-ghost" style="flex:1">Toggle</button>
      </div>
    </div>
  </aside>

  <main class="content">
    <div class="topbar" style="margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <button id="sidebarCollapse" class="sidebar-toggle btn-ghost">‚ò∞</button>
        <h1 style="font-size:20px;margin:0">Echanj Plus ‚Äî Dashboard</h1>
        <span class="pill" id="langBadge">KREYOL</span>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="statusDot" class="pill">Offline</div>
      </div>
    </div>

    <section id="dashboardSection" class="card">
      <h2>Dashboard</h2>
      <div class="muted">Resans tranzaksyon ou ak k√≤mant√® ap par√®t anba.</div>
      <div style="margin-top:12px">
        <div class="card" style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <div class="small">D√®nye tranzaksyon</div>
            <div id="latestTx" class="muted">Pa gen</div>
          </div>
          <div style="width:120px;text-align:right">
            <div class="small">Total tx</div>
            <div id="txCount" style="font-weight:700">0</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>K√≤mant√® piblik</h3>
        <div id="publicComments" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="profileSection" class="card" style="margin-top:18px;display:none">
      <h2>Profile</h2>
      <label class="small">Non konpl√®</label>
      <input id="profile_name" placeholder="Non konpl√®"/>
      <label class="small">Telef√≤n</label>
      <input id="profile_phone" placeholder="+509XXXXXXXX"/>
      <label class="small">S√®ks</label>
      <select id="profile_gender"><option value="">Chwazi</option><option value="gason">Gason</option><option value="fi">Fi</option></select>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveProfile" class="btn-primary">Anrejistre</button>
        <button id="editProfileCancel" class="btn-ghost">Anile</button>
      </div>
      <div id="profileMsg" class="muted" style="margin-top:8px"></div>
    </section>

    <section id="dialerSection" class="card" style="margin-top:18px;display:none">
      <h2>Voye Minit (Dialer)</h2>
      <div class="muted">Nimewo sist√®m: Digicel <strong>+50947111123</strong> ‚Ä¢ Natcom <strong>32160708</strong></div>

      <label class="small">Telef√≤n ou (ranpli si vle pou referans)</label>
      <input id="senderPhone" placeholder="+509XXXXXXXX" />

      <div style="display:flex;gap:8px;margin-top:10px">
        <select id="dialOperator" style="flex:1">
          <option value="">Chwazi operat√®</option>
          <option value="digicel">Digicel</option>
          <option value="natcom">Natcom</option>
        </select>
        <input id="dialMinutes" type="number" placeholder="100" style="width:120px"/>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="dialBtn" class="btn-primary">Dial & Voye</button>
        <button id="previewUssd" class="btn-ghost">Preview</button>
        <button id="calcFee" class="btn-ghost">Kalkile Fr√®</button>
      </div>

      <div style="margin-top:12px" class="small">
        Fr√® sist√®m (17.5%): <strong id="feeShow">‚Äî</strong> ‚Ä¢ Moun ap resevwa: <strong id="receiveShow">‚Äî</strong>
      </div>

      <div id="gateMsg" class="small muted" style="margin-top:10px;display:none">
        <span class="pill">Ap tann verifikasyon minit yo‚Ä¶</span>
      </div>
    </section>

    <section id="feedbackSection" class="card" style="margin-top:18px;display:none">
      <h2>Evalye konfyans sist√®m nan</h2>
      <div class="muted">Nan ki nivo ou f√® konfyans sist√®m lan?</div>
      <div class="stars" style="margin-top:8px" id="stars">
        <span class="star" data-star="1">‚òÖ</span>
        <span class="star" data-star="2">‚òÖ</span>
        <span class="star" data-star="3">‚òÖ</span>
        <span class="star" data-star="4">‚òÖ</span>
        <span class="star" data-star="5">‚òÖ</span>
      </div>
      <textarea id="fb_comment" placeholder="K√≤mant√® ou‚Ä¶" style="margin-top:8px"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="publishFeedback" class="btn-primary">Pibliye</button>
      </div>
    </section>

    <section id="paymentsSection" class="card" style="margin-top:18px;display:none">
      <h2>Peman</h2>
      <label class="small">Chwazi met√≤d</label>
      <select id="payMethod">
        <option value="">-- Chwazi --</option>
        <option value="moncash">MonCash</option>
        <option value="natcash">NatCash</option>
        <option value="paryaj_lakay">Paryaj Lakay</option>
        <option value="paryaj_pam">Paryaj Pam</option>
      </select>

      <div id="payFields" style="margin-top:10px"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="sendPayment" class="btn-primary">Peye (WhatsApp)</button>
      </div>
    </section>

    <section id="transactionsSection" class="card" style="margin-top:18px;display:none">
      <h2>Tranzaksyon Ou</h2>
      <div id="txList" class="tx-list"></div>
    </section>

    <section id="helpSection" class="card" style="margin-top:18px;display:none">
      <h2>Kontakte nou</h2>
      <p>WhatsApp Sist√®m: <strong>+50947111123</strong></p>
      <p>Im√®l: <strong>echanjplus@gmail.com</strong></p>
    </section>

  </main>
</div>

<!-- toast & spinner -->
<div id="toast" class="toast hide"><div id="toastTitle" style="font-weight:700"></div><div id="toastBody" class="muted"></div></div>

<!-- Firebase v10 modular -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, set, push, get, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // --- YOUR FIREBASE CONFIG (you already provided this) ---
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.firebasestorage.app",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // --- constants ---
  const SYSTEM_DIGICEL = '+50947111123';
  const SYSTEM_NATCOM  = '32160708';
  const FEE_RATE = 0.175; // 17.5%

  // --- elements ---
  const authOverlay = document.getElementById('authOverlay');
  const authMsg = document.getElementById('authMsg');

  const signupForm = document.getElementById('signupForm');
  const loginForm = document.getElementById('loginForm');
  const resetForm = document.getElementById('resetForm');
  const doSignUp = document.getElementById('doSignUp');
  const doLogin = document.getElementById('doLogin');
  const doReset = document.getElementById('doReset');
  const toLogin = document.getElementById('toLogin');
  const toSignup = document.getElementById('toSignup');
  const forgotLink = document.getElementById('forgotLink');
  const backLogin = document.getElementById('backLogin');
  const guestBtn = document.getElementById('guestBtn');

  const appRoot = document.getElementById('appRoot');
  const userBadge = document.getElementById('userBadge');
  const statusDot = document.getElementById('statusDot');

  const menuBtns = Array.from(document.querySelectorAll('.menu-btn'));
  const sectionsMap = {
    dashboard: document.getElementById('dashboardSection'),
    profile: document.getElementById('profileSection'),
    dialer: document.getElementById('dialerSection'),
    feedback: document.getElementById('feedbackSection'),
    payments: document.getElementById('paymentsSection'),
    transactions: document.getElementById('transactionsSection'),
    help: document.getElementById('helpSection')
  };

  const profileName = document.getElementById('profile_name');
  const profilePhone = document.getElementById('profile_phone');
  const profileGender = document.getElementById('profile_gender');
  const saveProfileBtn = document.getElementById('saveProfile');
  const profileMsg = document.getElementById('profileMsg');

  const senderPhone = document.getElementById('senderPhone');
  const dialOperator = document.getElementById('dialOperator');
  const dialMinutes = document.getElementById('dialMinutes');
  const dialBtn = document.getElementById('dialBtn');
  const previewUssd = document.getElementById('previewUssd');
  const calcFeeBtn = document.getElementById('calcFee');
  const feeShow = document.getElementById('feeShow');
  const receiveShow = document.getElementById('receiveShow');
  const gateMsg = document.getElementById('gateMsg');

  const starsEl = document.getElementById('stars');
  const fbComment = document.getElementById('fb_comment');
  const publishFeedback = document.getElementById('publishFeedback');

  const payMethod = document.getElementById('payMethod');
  const payFields = document.getElementById('payFields');
  const sendPayment = document.getElementById('sendPayment');

  const txListEl = document.getElementById('txList');
  const latestTx = document.getElementById('latestTx');
  const txCount = document.getElementById('txCount');
  const publicComments = document.getElementById('publicComments');

  const logoutBtn = document.getElementById('logout');

  const toast = document.getElementById('toast');
  const toastTitle = document.getElementById('toastTitle');
  const toastBody = document.getElementById('toastBody');

  // --- helpers ---
  function showToast(title, body='', ms=4200){
    toastTitle.textContent = title;
    toastBody.textContent = body;
    toast.classList.remove('hide');
    setTimeout(()=> toast.classList.add('hide'), ms);
  }
  function showSpinnerIn(el){ el.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><div class="spinner"></div><div class="muted">Processing...</div></div>'; }
  function calcFee(v){ return Math.round(Number(v) * FEE_RATE); }
  function uid(n=6){ return Date.now().toString(36).slice(-6) + Math.random().toString(36).slice(2,2+n); }

  // --- auth form toggles ---
  toLogin.addEventListener('click',()=>{ signupForm.style.display='none'; loginForm.style.display='block'; resetForm.style.display='none'; authMsg.textContent=''; });
  toSignup.addEventListener('click',()=>{ signupForm.style.display='block'; loginForm.style.display='none'; resetForm.style.display='none'; authMsg.textContent=''; });
  forgotLink.addEventListener('click',()=>{ signupForm.style.display='none'; loginForm.style.display='none'; resetForm.style.display='block'; authMsg.textContent='';});
  backLogin.addEventListener('click',()=>{ signupForm.style.display='none'; loginForm.style.display='block'; resetForm.style.display='none'; authMsg.textContent='';});
  guestBtn.addEventListener('click',()=>{ // limited guest (local)
    currentUser = { uid: 'guest-'+uid(4), isGuest:true, email:'guest@example.com' };
    afterLoginUI();
    showToast('Guest mode', 'Ou antre k√≤m Guest. Gen limit sou DB write.');
  });

  // --- SIGNUP ---
  doSignUp.addEventListener('click', async ()=>{
    authMsg.textContent='';
    const name = document.getElementById('su_name').value.trim();
    const phone = document.getElementById('su_phone').value.trim();
    const gender = document.getElementById('su_gender').value;
    const email = document.getElementById('su_email').value.trim();
    const pass = document.getElementById('su_pass').value;

    if(!name || !phone || !email || !pass || !gender){ authMsg.textContent='Ranpli tout chan yo.'; return; }
    if(!/^[A-Z]/.test(pass)){ authMsg.textContent='Modpas dwe k√≤manse ak yon gwo l√®t.'; return; }

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      // save p
