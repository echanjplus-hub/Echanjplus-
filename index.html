<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Echanj Plus — Tout an 1</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --page:#f7f9fb; --accent:#0ea5ff; --muted:#6b7280;
    --primary:#0b84ff; --danger:#ef4444; --radius:12px; font-family:Inter,system-ui,Arial,sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:var(--page);color:#0f172a}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;box-shadow:0 2px 8px rgba(2,6,23,0.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .brand h1{margin:0;color:var(--primary);font-size:18px}
  .main{max-width:1100px;margin:22px auto;padding:10px;display:grid;grid-template-columns:1fr 380px;gap:16px}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);border:1px solid rgba(2,6,23,0.04)}
  h2{margin:0 0 8px 0;color:var(--primary)}
  label{display:block;color:var(--muted);font-size:13px;margin-top:8px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);background:transparent;color:inherit;margin-top:8px}
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:8px}
  .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(180deg,var(--primary),#0669d9);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);color:var(--muted)}
  .small{font-size:13px;color:var(--muted);margin-top:8px}
  .tx-list{max-height:320px;overflow:auto;margin-top:10px}
  .tx-item{padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.03);margin-bottom:8px;background:linear-gradient(180deg, rgba(2,6,23,0.01), transparent)}
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.85);display:flex;align-items:center;justify-content:center;z-index:9999}
  .auth-card{width:420px;background:#fff;padding:22px;border-radius:12px;border:1px solid rgba(2,6,23,0.06)}
  .muted{color:var(--muted)}
  .full-screen { width:100%; height:100vh; display:flex; justify-content:center; align-items:center; }
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(2,6,23,0.04);font-size:13px;color:#0f172a}
  .hide{display:none!important}
  .toast{position:fixed;right:18px;bottom:18px;background:#0b1220;color:#fff;padding:12px 14px;border-radius:10px;z-index:100000}
  .profile-badge{display:flex;gap:8px;align-items:center}
  .profile-badge .name{font-weight:700}
  @media (max-width:980px){ .main{grid-template-columns:1fr;padding:12px} .auth-card{width:92%} }
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="" alt="logo" id="logo" style="width:40px;height:40px;border-radius:8px;background:#fff;display:none"/>
    <h1>Echanj Plus</h1>
  </div>
  <div style="display:flex;gap:12px;align-items:center">
    <div id="userBadge" class="profile-badge" style="display:none;cursor:pointer">
      <div class="pill name" id="badgeName">Itilizatè</div>
      <div class="pill" id="badgePhone"></div>
    </div>
    <button id="openAuthBtn" class="btn btn-ghost">Konekte / Enskri</button>
    <button id="logoutBtn" class="btn btn-ghost hide">Dekonekte</button>
  </div>
</header>

<main class="main">
  <!-- LEFT: Dialer + Comments -->
  <section>
    <section class="card" id="dialCard">
      <h2>Etap 1 — Voye Minit (Dialer)</h2>
      <div class="small">Nimewo sistèm: Digicel <strong>+50947111123</strong> • Natcom <strong>32160708</strong></div>

      <label>Telefòn ou (ou ka kite blan si w anvi)</label>
      <input id="sender" placeholder="+509XXXXXXXX"/>

      <div class="row" style="margin-top:10px">
        <select id="operator" style="flex:1">
          <option value="">-- Chwazi --</option>
          <option value="digicel">Digicel</option>
          <option value="natcom">Natcom</option>
        </select>
        <input id="amount" type="number" placeholder="100" style="width:140px" min="1"/>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="ussdBtn1" class="btn btn-primary">Dial Konpoze 1</button>
        <button id="ussdBtn2" class="btn btn-primary" style="display:none">Dial Konpoze 2</button>
        <button id="ussdBtn3" class="btn btn-primary" style="display:none">Dial Konfime</button>
        <button id="previewDial" class="btn btn-ghost">Preview</button>
      </div>

      <div class="small" style="margin-top:10px">Frè sistèm (17.5%): <strong id="feeMin">—</strong> • Montan ou resevwa: <strong id="netMin">—</strong></div>
      <div id="dialStatus" class="small muted" style="margin-top:8px">Estati: <span id="dialStatusText">—</span></div>
    </section>

    <section class="card" style="margin-top:16px" id="commentCard">
      <h2>Etap 2 — Evalye & Kòmantè</h2>
      <label>Nan ki nivo ou fè sistèm lan konfyans?</label>
      <div id="stars" style="display:flex;gap:6px;margin-top:8px">
        <span class="star" data-n="1" style="font-size:22px;cursor:pointer">⭐</span>
        <span class="star" data-n="2" style="font-size:22px;cursor:pointer">⭐</span>
        <span class="star" data-n="3" style="font-size:22px;cursor:pointer">⭐</span>
        <span class="star" data-n="4" style="font-size:22px;cursor:pointer">⭐</span>
        <span class="star" data-n="5" style="font-size:22px;cursor:pointer">⭐</span>
      </div>

      <label style="margin-top:10px">Kòmantè</label>
      <textarea id="commentText" placeholder="Ekri kòmantè ou…"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="submitComment" class="btn btn-primary">Anrejistre & Pwochen</button>
        <button id="clearComment" class="btn btn-ghost">Efase</button>
      </div>
    </section>
  </section>

  <!-- RIGHT: Payment & Tx -->
  <aside class="card" id="paymentCard">
    <h2>Etap 3 — Peman</h2>
    <div class="small">Chwazi metòd peman — tout chan yo ap ekri ak otomatik montan kliyan ap resevwa.</div>

    <label>Metòd peman</label>
    <select id="payMethod">
      <option value="">-- Chwazi --</option>
      <option value="moncash">MonCash</option>
      <option value="natcash">NatCash</option>
      <option value="paryaj_lakay">Paryaj Lakay</option>
      <option value="paryaj_pam">Paryaj Pam</option>
    </select>

    <div id="payFields" style="margin-top:10px"></div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="sendPay" class="btn btn-primary" style="flex:1">Soumèt & WhatsApp</button>
      <button id="previewPay" class="btn btn-ghost">Preview</button>
    </div>

    <hr style="margin:12px 0;border-color:rgba(2,6,23,0.06)">

    <h3 style="margin:0 0 8px 0;color:var(--primary);font-size:15px">Tranzaksyon Ou</h3>
    <div id="txList" class="tx-list"><div class="small">Pa gen tranzaksyon chaje.</div></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="exportCsv" class="btn btn-ghost" style="flex:1">Export CSV</button>
      <button id="clearUi" class="btn btn-ghost">Clear UI</button>
    </div>
  </aside>
</main>

<!-- Auth overlay (full-screen, mandatory) -->
<div id="authOverlay" class="overlay">
  <div class="auth-card">
    <h2 style="margin:0 0 6px 0;color:var(--primary)">Obligatwa — Konekte / Enskri</h2>
    <div class="small muted">Ou dwe konekte pou itilize Echanj Plus. Si ou pa gen kont, enskri kounye a.</div>

    <label style="margin-top:12px">Mode</label>
    <select id="authMode"><option value="login">Konekte</option><option value="register">Enskri</option></select>

    <div id="registerFields" style="margin-top:8px;display:none">
      <label>Non konplè</label><input id="authName" placeholder="Non konplè"/>
      <label>Telefòn (+509...)</label><input id="authPhone" placeholder="+509XXXXXXXX"/>
      <label>Sèks</label>
      <select id="authGender"><option value="">Chwazi</option><option value="fi">Fi</option><option value="gason">Gason</option></select>
    </div>

    <label style="margin-top:8px">Imèl</label><input id="authEmail" type="email" placeholder="imel@egzanp.com"/>
    <label>Modpas</label><input id="authPass" type="password" placeholder="Modpas (Min 6, kòmanse ak Majiskil)"/>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="authAction" class="btn btn-primary">Konekte</button>
      <button id="guestBtn" class="btn btn-ghost">Teste kòm Guest</button>
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <a href="#" id="showForgot" style="color:var(--primary);font-size:13px">Reset Modpas</a>
      <a href="#" id="toggleAuth" style="color:var(--primary);font-size:13px">Anrejistre</a>
    </div>
    <div id="authMsg" class="small" style="margin-top:8px;color:var(--danger)"></div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<!-- Firebase compat (pi fasil) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
/* ==========================
   RANPLASE SA AK KONFIG OU
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
  authDomain: "echanj-plus-778cd.firebaseapp.com",
  databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
  projectId: "echanj-plus-778cd",
  storageBucket: "echanj-plus-778cd.firebasestorage.app",
  messagingSenderId: "111144762929",
  appId: "1:111144762929:web:e64ce9a6da65781c289f10",
  measurementId: "G-J1BQRF32ZW"
};
/* VAPID KEY pou FCM Web push (ranplase ak pwòp VAPID PUBLIC key ou) */
const VAPID_KEY = "METE_PUBLIC_VAPID_KEY_LA";

/* ==========================
   INIT FIREBASE
   ========================== */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const messaging = firebase.messaging();

/* ==========================
   CONSTANTS
   ========================== */
const SYSTEM_DIGICEL = '+50947111123';
const SYSTEM_NATCOM = '32160708';
const FEE_RATE = 0.175; // 17.5%

/* ==========================
   UI ELEM
   ========================== */
const authOverlay = document.getElementById('authOverlay');
const authMode = document.getElementById('authMode');
const registerFields = document.getElementById('registerFields');
const authAction = document.getElementById('authAction');
const toggleAuth = document.getElementById('toggleAuth');
const authMsg = document.getElementById('authMsg');
const guestBtn = document.getElementById('guestBtn');
const showForgot = document.getElementById('showForgot');

const openAuthBtn = document.getElementById('openAuthBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userBadge = document.getElementById('userBadge');
const badgeName = document.getElementById('badgeName');
const badgePhone = document.getElementById('badgePhone');

const amountInput = document.getElementById('amount');
const operatorSelect = document.getElementById('operator');
const feeMin = document.getElementById('feeMin');
const netMin = document.getElementById('netMin');
const ussdBtn1 = document.getElementById('ussdBtn1');
const ussdBtn2 = document.getElementById('ussdBtn2');
const ussdBtn3 = document.getElementById('ussdBtn3');
const previewDial = document.getElementById('previewDial');
const dialStatusText = document.getElementById('dialStatusText');

const stars = Array.from(document.querySelectorAll('.star'));
const commentText = document.getElementById('commentText');
const submitComment = document.getElementById('submitComment');
const clearComment = document.getElementById('clearComment');

const payMethod = document.getElementById('payMethod');
const payFields = document.getElementById('payFields');
const sendPay = document.getElementById('sendPay');
const previewPay = document.getElementById('previewPay');

const txList = document.getElementById('txList');

const toastEl = document.getElementById('toast');

/* ==========================
   HELPERS
   ========================== */
function toast(msg, t=4000){ toastEl.textContent = msg; toastEl.classList.remove('hide'); setTimeout(()=>toastEl.classList.add('hide'), t); }
function uid(n=6){ return Date.now().toString(36).slice(-6) + Math.random().toString(36).slice(2,2+n); }
function calcFee(v){ return Math.round(Number(v) * FEE_RATE); }
function sanitizeNum(n){ return String(n).replace(/\D/g,''); }

/* ==========================
   AUTH FLOW
   ========================== */
let currentUser = null;
function showAuthOverlay(){ authOverlay.style.display='flex'; authMsg.textContent=''; }
function hideAuthOverlay(){ authOverlay.style.display='none'; }

openAuthBtn.addEventListener('click', showAuthOverlay);
logoutBtn.addEventListener('click', async ()=>{ await auth.signOut(); toast('Ou dekonekte'); });

authMode.addEventListener('change', ()=> {
  const m = authMode.value;
  registerFields.style.display = m === 'register' ? 'block' : 'none';
  authAction.textContent = m === 'register' ? 'Enskri' : 'Konekte';
  toggleAuth.textContent = m === 'register' ? 'Konekte' : 'Anrejistre';
});

toggleAuth.addEventListener('click', ()=>{
  authMode.value = authMode.value === 'login' ? 'register' : 'login';
  authMode.dispatchEvent(new Event('change'));
});

showForgot.addEventListener('click', async (e)=>{
  e.preventDefault();
  const email = prompt('Antre imel pou reset modpas:');
  if(email){ try{ await auth.sendPasswordResetEmail(email); alert('Imel reset voye.'); }catch(err){ alert(err.message); } }
});

authAction.addEventListener('click', async ()=>{
  authMsg.textContent = ''; authMsg.style.color = 'red';
  const mode = authMode.value;
  const email = document.getElementById('authEmail').value.trim();
  const pass = document.getElementById('authPass').value;
  if(!email || !pass){ authMsg.textContent = 'Ranpli imel ak modpas'; return; }
  if(pass.length < 6){ authMsg.textContent = 'Modpas dwe gen omwen 6 karaktè'; return; }
  if(!pass.match(/^[A-Z]/)){ authMsg.textContent = 'Modpas dwe kòmanse ak yon lèt majiskil'; return; }
  try{
    if(mode === 'register'){
      const name = document.getElementById('authName').value.trim();
      const phone = document.getElementById('authPhone').value.trim();
      const gender = document.getElementById('authGender').value;
      if(!name || !phone || !gender){ authMsg.textContent='Ranpli non, telefòn, ak sèks'; return; }
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      currentUser = cred.user;
      // save profile
      await db.ref(`users/${currentUser.uid}`).set({ name, phone, gender, email, createdAt: Date.now() });
      hideAuthOverlay();
      toast('Enskripsyon fini — Byenveni!');
    } else {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      currentUser = cred.user;
      hideAuthOverlay();
      toast('Konekte avèk siksè');
    }
  }catch(err){ authMsg.textContent = err.message; }
});

guestBtn.addEventListener('click', ()=>{
  currentUser = { uid: 'guest-'+uid(4), email: 'guest@guest.com', guest: true };
  hideAuthOverlay();
  badgeName.textContent = 'Guest';
  badgePhone.textContent = '';
  userBadge.style.display='flex';
  logoutBtn.classList.remove('hide');
  toast('W ap teste kòm Guest — kèk opsyon limite.');
  renderTx([]);
});

/* listen auth state */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser = user;
    logoutBtn.classList.remove('hide');
    openAuthBtn.style.display='none';
    // load profile
    try{
      const s = await db.ref(`users/${user.uid}`).get();
      const profile = s.exists()? s.val() : {};
      badgeName.textContent = profile.name || user.displayName || 'Itilizatè';
      badgePhone.textContent = profile.phone || '';
      userBadge.style.display='flex';
    }catch(e){ console.warn('load profile err', e); }

    hideAuthOverlay();
    await loadTx();
    await liveComments();
    await trySetupFCM();
  } else {
    currentUser = null;
    userBadge.style.display='none';
    openAuthBtn.style.display='inline-block';
    logoutBtn.classList.add('hide');
    showAuthOverlay();
    renderTx([]);
  }
});

/* click badge to edit profile */
userBadge.addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid.startsWith('guest')){ toast('Guest pa ka modifye profile'); return; }
  // fetch profile
  const s = await db.ref(`users/${currentUser.uid}`).get();
  const u = s.exists()? s.val() : {};
  const newName = prompt('Non konplè:', u.name || '');
  if(newName === null) return;
  const newPhone = prompt('Telefòn (+509...):', u.phone || '');
  if(newPhone === null) return;
  await db.ref(`users/${currentUser.uid}`).update({ name: newName, phone: newPhone });
  badgeName.textContent = newName;
  badgePhone.textContent = newPhone;
  toast('Profile mete ajou');
});

/* ==========================
   DIALER LOGIC
   ========================== */
function updateFeePreview(){
  const v = Number(amountInput.value || 0);
  if(!v){ feeMin.textContent='—'; netMin.textContent='—'; return; }
  const fee = calcFee(v);
  feeMin.textContent = fee + ' HTG';
  netMin.textContent = (v - fee) + ' HTG';
}
amountInput.addEventListener('input', updateFeePreview);
operatorSelect.addEventListener('change', ()=>{
  const op = operatorSelect.value;
  if(op === 'digicel'){
    ussdBtn2.style.display='inline-block';
    ussdBtn3.style.display='inline-block';
  } else {
    ussdBtn2.style.display='none';
    ussdBtn3.style.display='none';
  }
});

previewDial.addEventListener('click', ()=>{
  const op = operatorSelect.value; const amt = amountInput.value;
  if(!op || !amt) return alert('Chwazi operatè ak montan');
  const code = buildUSSD(op, amt, 1);
  alert('USSD preview: ' + code);
});

function buildUSSD(op, amt, step){
  // step 1 = primary code; for digicel step2 uses amount, step3 confirm
  if(op === 'natcom'){
    // *123*88888888*32160708*AMT#
    return `*123*88888888*${SYSTEM_NATCOM}*${amt}#`;
  } else if(op === 'digicel'){
    if(step === 1) return `*128*509${SYSTEM_DIGICEL.replace('+','')}*${amt}#`;
    if(step === 2) return `*128*509${SYSTEM_DIGICEL.replace('+','')}*${amt}#`; // same as step1 for this example
    if(step === 3) return `*128*1#`; // confirmation
  }
  return '';
}

/* when user clicks a dial button */
async function savePendingTx(op, amt){
  if(!currentUser) return;
  const tx = { id:null, uid: currentUser.uid, type:'send_minutes', operator: op, from: document.getElementById('sender').value.trim()||'', to: op==='digicel'?SYSTEM_DIGICEL:SYSTEM_NATCOM, minutes: Number(amt), fee: calcFee(amt), net: Number(amt)-calcFee(amt), ts: Date.now(), status: 'pending' };
  const refTx = db.ref(`transactions/${currentUser.uid}`).push();
  tx.id = refTx.key;
  await refTx.set(tx);
  await loadTx();
  return tx;
}

ussdBtn1.addEventListener('click', async ()=>{
  if(!currentUser){ toast('Ou dwe konekte'); return; }
  const op = operatorSelect.value; const amt = amountInput.value;
  if(!op || !amt) return alert('Chwazi operatè ak montan.');
  const tx = await savePendingTx(op, amt);
  const code = buildUSSD(op, amt, 1);
  // open dialer (mobile) - will only work on mobile devices
  window.location.href = 'tel:' + encodeURIComponent(code);
  dialStatusText.textContent = 'Dialer louvri. Siveyans tx pou verifye status...';
  toast('Dialer ap ouvri sou mobil (si telefòn sipòte).');
  // listen for status change on this tx
  db.ref(`transactions/${currentUser.uid}/${tx.id}/status`).on('value', snap=>{
    const s = snap.val();
    if(s === 'success'){ dialStatusText.textContent = 'Transfè verifye — ou ka kontinye.'; toast('Transfè verifye!'); }
  });
});

ussdBtn2.a
