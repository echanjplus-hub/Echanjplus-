<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Echanj Plus — Dashboard</title>

  <!-- Modern, clean CSS (pro 2025 style) -->
  <style>
    :root{
      --bg1: #071827;
      --bg2: #021826;
      --card: rgba(255,255,255,0.03);
      --muted: #9fb3c8;
      --accent: linear-gradient(135deg,#06b6d4,#7c3aed);
      --glass: rgba(255,255,255,0.02);
      --accent-txt: #041b1f;
      --success: #10b981;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
      font-synthesis: none;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#e8f3fb}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:28px auto;padding:20px;display:grid;grid-template-columns:360px 1fr;gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
    /* Left column (auth / user) */
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{
      width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#7c3aed);
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:white;box-shadow:0 8px 24px rgba(7,24,39,0.6)
    }
    h1{margin:0;font-size:20px}
    .lead{color:var(--muted);margin:4px 0 12px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      background:transparent;color:inherit;margin-bottom:10px;outline:none;font-size:14px;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:0;font-weight:700;cursor:pointer;
      background:linear-gradient(90deg,#06b6d4,#7c3aed);color:var(--accent-txt);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    /* Dashboard (right) */
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:10px;background:var(--glass);cursor:pointer;color:var(--muted);font-weight:600}
    .tab.active{background:linear-gradient(90deg,#042f34,#0b2f52);color:#e8f3fb;box-shadow:inset 0 -4px 18px rgba(0,0,0,0.2)}
    .balance-box{display:flex;flex-direction:column;align-items:flex-end}
    .balance{font-size:28px;font-weight:800}
    .content{padding-top:8px}
    .profile-row{display:flex;gap:12px;align-items:center}
    .avatar{width:80px;height:80px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:30px;color:white;font-weight:800}
    .box{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px}
    .ussd-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .ussd-btn{display:inline-flex;align-items:center;justify-content:center;padding:14px;border-radius:12px;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,0.04)}
    .ussd-digicel{background:linear-gradient(90deg,#0ea5a4,#0891b2);color:#042027}
    .ussd-natcom{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#041827}
    .recent-item{padding:10px;border-radius:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .muted{color:var(--muted)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Auth / User -->
    <div>
      <div class="card">
        <div class="brand">
          <div class="logo">EP</div>
          <div>
            <h1>Echanj Plus</h1>
            <div class="lead">Sekirize · Senp · Rapid</div>
          </div>
        </div>

        <!-- AUTH (visible when not logged) -->
        <div id="authSection">
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <button id="tabLogin" class="tab active" style="padding:8px 10px">Login</button>
            <button id="tabRegister" class="tab" style="padding:8px 10px">Register</button>
          </div>

          <div id="formLogin">
            <label>Imèl</label>
            <input id="loginEmail" type="email" placeholder="ou@example.com" />
            <label>Modpas</label>
            <input id="loginPassword" type="password" placeholder="••••••••" />
            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="btnLogin" class="btn">Login</button>
              <button id="btnGoogle" class="btn ghost">Google</button>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="btnForgot" class="btn ghost">Mwen bliye modpas</button>
            </div>
            <p class="small" style="margin-top:10px">Ou dwe konekte pou gen aksè. Pa gen lòt pati ki disponib san koneksyon.</p>
          </div>

          <div id="formRegister" class="hidden">
            <label>Imèl</label>
            <input id="regEmail" type="email" placeholder="ou@example.com" />
            <label>Modpas (min 6 karaktè)</label>
            <input id="regPassword" type="password" />
            <label>Konfime modpas</label>
            <input id="regPassword2" type="password" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnRegister" class="btn">Kreye kont</button>
              <button id="btnToLogin" class="btn ghost">Ann tounen</button>
            </div>
            <p class="small" style="margin-top:10px">Apre enskripsyon, konekte pou kontinye.</p>
          </div>
        </div>

        <!-- USER SUMMARY (visible when logged) -->
        <div id="userSummary" class="hidden" style="margin-top:8px">
          <div style="display:flex;gap:12px;align-items:center">
            <div id="miniAvatar" class="avatar">U</div>
            <div>
              <div id="miniName" style="font-weight:800">User</div>
              <div id="miniEmail" class="muted">email@example.com</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btnLogout" class="btn ghost">Logout</button>
            <button id="gotoProfile" class="btn">Profile</button>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:16px 0">

        <div class="small muted">
          Asire w aktive <strong>Email/Password</strong> ak <strong>Google</strong> nan Firebase Console → Authentication → Sign-in method.
        </div>
      </div>

      <div style="margin-top:14px" class="card">
        <h3 style="margin:0 0 8px 0">Not pou admin</h3>
        <div class="small muted">Pou pi bon pèfòmans, konsidere mete tranzaksyon tou anba <code>users/{uid}/transactions</code> (kòd sa a fè sa otomatikman).</div>
      </div>
    </div>

    <!-- RIGHT: Dashboard -->
    <div>
      <div class="header">
        <div>
          <div class="small muted">Dashboard</div>
          <div id="welcome" style="font-weight:800">Byenveni</div>
        </div>

        <div class="balance-box">
          <div class="small muted">Minit sou kont</div>
          <div id="balance" class="balance">0</div>
          <div id="accountUid" class="small muted">UID: -</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="tabs" id="dashTabs">
            <div class="tab active" data-tab="profile">Profile</div>
            <div class="tab" data-tab="about">About</div>
            <div class="tab" data-tab="ussd">USSD Transactions</div>
          </div>
          <div class="small muted">Sekirize — sèlman itilizatè otantifye ka wè sa</div>
        </div>

        <div class="content">
          <!-- PROFILE TAB -->
          <div id="tab-profile">
            <div class="profile-row">
              <div id="bigAvatar" class="avatar">U</div>
              <div style="flex:1">
                <label>Non konplè</label>
                <input id="p_name" placeholder="Ex.: Aristor" />
                <label>Nimewo telefòn (+509...)</label>
                <input id="p_phone" placeholder="+50947111123" />
                <label>Sèks</label>
                <select id="p_gender">
                  <option value="">Chwazi</option>
                  <option value="Gason">Gason</option>
                  <option value="Fanm">Fanm</option>
                </select>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button id="saveProfile" class="btn">Sove Profil</button>
                </div>
                <div class="small muted" style="margin-top:8px">Apre sove, done yo disponib nan baz done pou rapò.</div>
              </div>
            </div>
          </div>

          <!-- ABOUT TAB -->
          <div id="tab-about" class="hidden">
            <div class="box">
              <h3>Sou Echanj Plus</h3>
              <p class="muted">Echanj Plus pèmèt itilizatè achte / voye minit epi swiv balans yo fasil. Tout tranzaksyon anrejistre ak done ki nesesè pou audit. Sit la mande otantifikasyon avan aksè.</p>
            </div>
          </div>

          <!-- USSD TAB -->
          <div id="tab-ussd" class="hidden">
            <div class="box">
              <h4>Otomatik USSD</h4>
              <div class="ussd-grid" style="margin-bottom:12px">
                <!-- Use tel: links and encode # as %23 -->
                <a id="digicelLaunch" class="ussd-btn ussd-digicel" href="tel:*128*50947111123*100%23">Digicel — *128*50947111123*100#</a>
                <a id="digicelConfirm" class="ussd-btn ussd-digicel" href="tel:*128*1%23">Konfime Digicel — *128*1#</a>
                <a id="natcomLaunch" class="ussd-btn ussd-natcom" href="tel:*123*88888888*32160708*100%23">Natcom — *123*88888888*32160708*100#</a>
                <button id="copyCodes" class="ussd-btn" style="background:transparent;border:1px dashed rgba(255,255,255,0.06);color:var(--muted)">Kopye kòd</button>
              </div>

              <h4>Anrejistre yon tranzaksyon</h4>
              <label>Kod (eg. ARS)</label>
              <input id="t_kod" placeholder="ARS" />
              <label>Frais</label>
              <input id="t_frais" placeholder="15" />
              <label>Montan (minit)</label>
              <input id="t_montan" placeholder="100" />
              <label>Non</label>
              <input id="t_non" placeholder="Ex.: Aristor" />
              <label>Telephone</label>
              <input id="t_phone" placeholder="+50947111123" />
              <label>Statut</label>
              <select id="t_statut">
                <option>Ankour</option>
                <option>Fini</option>
                <option>Echwe</option>
              </select>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="btnRecord" class="btn">Anrejistre Tranzaksyon</button>
                <button id="btnClear" class="btn ghost">Efase fòm</button>
              </div>
              <div class="small muted" style="margin-top:8px">Apre anrejistreman, total minit itilizatè a ap ajou otomatikman.</div>
            </div>

            <div style="margin-top:12px" class="box">
              <h4>Resan tranzaksyon</h4>
              <div id="recentList" class="muted small">Pa gen tranzaksyon ankò.</div>
            </div>
          </div>
        </div>
      </div>

      <footer>© Echanj Plus — Tout dwa rezève</footer>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /***** FIREBASE CONFIG *****
     Replace values if yours are different. You told me you already provided config — kept it here.
    *****************************/
    const firebaseConfig = {
      apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
      authDomain: "echanj-plus-778cd.firebaseapp.com",
      databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
      projectId: "echanj-plus-778cd",
      storageBucket: "echanj-plus-778cd.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Helpers
    const $ = id => document.getElementById(id);
    const show = (id, yes=true) => { const el = $(id); if(!el) return; el.classList.toggle('hidden', !yes); }
    const setText = (id, txt) => { const e = $(id); if(e) e.textContent = txt; };

    // AUTH UI controls
    const authSection = $('authSection');
    const userSummary = $('userSummary');

    // Tab switching auth
    $('tabLogin').addEventListener('click', ()=>{ $('tabLogin').classList.add('active'); $('tabRegister').classList.remove('active'); show('formLogin', true); show('formRegister', false); });
    $('tabRegister').addEventListener('click', ()=>{ $('tabRegister').classList.add('active'); $('tabLogin').classList.remove('active'); show('formRegister', true); show('formLogin', false); });
    $('btnToLogin').addEventListener('click', ()=>{ $('tabLogin').click(); });

    // Dashboard tabs
    document.querySelectorAll('#dashTabs .tab').forEach(t=>{
      t.addEventListener('click', ()=> {
        document.querySelectorAll('#dashTabs .tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        ['profile','about','ussd'].forEach(name=> show('tab-'+name, name===tab));
      });
    });

    /******** AUTH ACTIONS ********/
    $('btnRegister').addEventListener('click', async ()=>{
      const email = $('regEmail').value.trim();
      const pw = $('regPassword').value;
      const pw2 = $('regPassword2').value;
      if(!email || !pw) return alert('Mete imèl ak modpas.');
      if(pw.length < 6) return alert('Modpas dwe gen omwen 6 karaktè.');
      if(pw !== pw2) return alert('Modpas yo pa menm.');
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pw);
        // create minimal profile
        await db.ref('users/' + cred.user.uid).set({
          email,
          createdAt: Date.now(),
          minutes: 0
        });
        alert('Kont kreye. Konekte kounye a.');
        $('tabLogin').click();
      }catch(err){
        alert('Erè: ' + err.message);
      }
    });

    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      const pw = $('loginPassword').value;
      if(!email || !pw) return alert('Mete imèl ak modpas.');
      try{
        await auth.signInWithEmailAndPassword(email, pw);
      }catch(err){
        alert('Erè login: ' + err.message);
      }
    });

    $('btnGoogle').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const result = await auth.signInWithPopup(provider);
        const u = result.user;
        // ensure DB record
        const ref = db.ref('users/' + u.uid);
        const snap = await ref.once('value');
        if(!snap.exists()){
          await ref.set({ email: u.email, name: u.displayName || '', createdAt: Date.now(), minutes: 0 });
        }
      }catch(err){
        alert('Google login erè: ' + err.message);
      }
    });

    $('btnForgot').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      if(!email) return alert('Mete imèl anwo a pou rekiperasyon.');
      try{
        await auth.sendPasswordResetEmail(email);
        alert('Imèl rekiperasyon voye.');
      }catch(err){
        alert('Erè: ' + err.message);
      }
    });

    $('btnLogout').addEventListener('click', ()=> auth.signOut());
    $('gotoProfile').addEventListener('click', ()=> { document.querySelector('[data-tab="profile"]').click(); });

    /******** AUTH STATE ********/
    let currentUid = null;
    let transactionsRef = null;
    let userRef = null;

    auth.onAuthStateChanged(async user=>{
      if(user){
        currentUid = user.uid;
        // UI swap
        show('authSection', false);
        show('userSummary', true);
        $('miniAvatar').textContent = (user.displayName ? user.displayName[0].toUpperCase() : user.email[0].toUpperCase());
        $('miniName').textContent = (user.displayName || user.email.split('@')[0]);
        $('miniEmail').textContent = user.email;
        setText('welcome', 'Byenveni, ' + (user.displayName || user.email.split('@')[0]));
        setText('accountUid', 'UID: ' + user.uid);

        // load profile & subscribe
        loadUserProfile(user.uid);
        subscribeUserData(user.uid);
      } else {
        currentUid = null;
        show('authSection', true);
        show('userSummary', false);
        // reset dashboard
        setText('balance','0');
        setText('welcome','Otantifikasyon oblije');
        setText('accountUid','UID: -');
        $('recentList').textContent = 'Pa gen tranzaksyon ankò.';
        // detach listeners
        if(transactionsRef) transactionsRef.off();
        if(userRef) userRef.off();
      }
    });

    /******** PROFILE ********/
    $('saveProfile').addEventListener('click', async ()=>{
      if(!currentUid) return alert('Ou dwe konekte.');
      const name = $('p_name').value.trim();
      const phone = $('p_phone').value.trim();
      const gender = $('p_gender').value;
      if(!name || !phone) return alert('Non ak telefòn obligatwa.');
      try{
        await db.ref('users/' + currentUid).update({ name, phone, gender });
        // update auth displayName
        const u = auth.currentUser;
        if(u) await u.updateProfile({ displayName: name }).catch(()=>{});
        $('miniName').textContent = name;
        $('miniAvatar').textContent = name[0].toUpperCase();
        $('bigAvatar').textContent = name[0].toUpperCase();
        alert('Profil sove.');
      }catch(err){
        alert('Erè sove profil: ' + err.message);
      }
    });

    async function loadUserProfile(uid){
      const snap = await db.ref('users/' + uid).once('value');
      const data = snap.val() || {};
      $('p_name').value = data.name || '';
      $('p_phone').value = data.phone || '';
      $('p_gender').value = data.gender || '';
      $('balance').textContent = (data.minutes || 0);
    }

    /******** TRANSACTIONS ********/
    function genTxtId(){
      const d = new Date();
      const Y = d.getFullYear().toString();
      const M = String(d.getMonth()+1).padStart(2,'0');
      const D = String(d.getDate()).padStart(2,'0');
      const t = String(d.getTime()).slice(-7);
      return `TX-${Y}${M}${D}-${t}`;
    }

    $('btnRecord').addEventListener('click', async ()=>{
      if(!currentUid) return alert('Ou dwe konekte.');
      const kod = $('t_kod').value.trim() || 'ARS';
      const fraisRaw = $('t_frais').value.trim();
      const montanRaw = $('t_montan').value.trim();
      const non = $('t_non').value.trim() || '';
      const phone = $('t_phone').value.trim() || '';
      const statut = $('t_statut').value || 'Ankour';

      const frais = Number(fraisRaw || 0);
      const montan = Number(montanRaw || 0);
      if(Number.isNaN(frais) || Number.isNaN(montan)) return alert('Frais ak montan dwe chif.');

      const txtid = genTxtId();
      const date = Date.now();
      const payload = { txtid, kod, date, frais, montan, non, statut, telephone: phone, uid: currentUid };

      try{
        // Write global transactions and user's transaction (double-write for easier queries)
        const updates = {};
        updates['/transactions/' + txtid] = payload;
        updates['/users/' + currentUid + '/transactions/' + txtid] = payload;
        await db.ref().update(updates);

        // Atomically update user's minutes total
        const minutesRef = db.ref('users/' + currentUid + '/minutes');
        await minutesRef.transaction(current => {
          current = current || 0;
          return current + montan;
        });

        alert('Tranzaksyon anrejistre: ' + txtid);
        // clear fields
        $('t_kod').value=''; $('t_frais').value=''; $('t_montan').value=''; $('t_non').value=''; $('t_phone').value='';
      }catch(err){
        alert('Erè anrejistre: ' + err.message);
      }
    });

    $('btnClear').addEventListener('click', ()=>{
      ['t_kod','t_frais','t_montan','t_non','t_phone'].forEach(id=>$(id).value='');
    });

    // Subscribe to user's minutes and recent transactions
    function subscribeUserData(uid){
      // detach if existed
      if(userRef) userRef.off();
      if(transactionsRef) transactionsRef.off();

      userRef = db.ref('users/' + uid);
      userRef.on('value', snap=>{
        const data = snap.val() || {};
        $('balance').textContent = (data.minutes || 0);
      });

      // listen recent under /users/{uid}/transactions
      transactionsRef = db.ref('users/' + uid + '/transactions');
      transactionsRef.on('value', snap=>{
        const all = snap.val() || {};
        const arr = Object.values(all).sort((a,b)=>b.date - a.date).slice(0,10);
        if(arr.length === 0){
          $('recentList').textContent = 'Pa gen tranzaksyon ankò.';
        } else {
          $('recentList').innerHTML = arr.map(t=>{
            const d = new Date(t.date);
            return `<div class="recent-item">
              <div style="font-weight:700">${t.txtid} — ${t.kod} — ${t.montan} min</div>
              <div class="muted small">${d.toLocaleString()} • ${t.non || '—'} • ${t.telephone || '—'} • ${t.statut || '—'}</div>
            </div>`;
          }).join('');
        }
      });
    }

    /******** USSD helpers (copy fallback) ********/
    $('copyCodes').addEventListener('click', ()=>{
      const codes = [
        'Digicel: *128*50947111123*100#',
        'Konfime Digicel: *128*1#',
        'Natcom: *123*88888888*32160708*100#'
      ].join('\\n');
      navigator.clipboard?.writeText(codes).then(()=> alert('Kòd yo kopie nan clipboard')).catch(()=> alert('Kopi echwe — soumèt manyèlman: \\n' + codes));
    });

    // UX: clicking tel on desktop may not work; we also handle click to copy if tel can't open
    ['digicelLaunch','digicelConfirm','natcomLaunch'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', (ev)=>{
        // mobile will try to open dialer; on desktop fallback to copying code
        // allow default anchor behaviour, but also try to copy textual code as fallback after short delay
        const href = el.getAttribute('href') || '';
        const textual = el.textContent || href;
        setTimeout(()=> {
          // if navigator.platform indicates desktop, copy textual
          const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
          if(!isMobile){
            navigator.clipboard?.writeText(textual).then(()=> alert('Kòd kopie: ' + textual));
          }
        }, 300);
      });
    });

    /******** NOTES ON SECURITY (pou Firebase Realtime Database rules) ********
     Pi bon pratik:
     - Mete tranzaksyon anba users/{uid}/transactions pou fasil règleman.
     - Egzanp règle senp (modifye selon bezwen):
     {
       "rules": {
         "users": {
           "$uid": {
             ".read": "auth != null && auth.uid === $uid",
             ".write": "auth != null && auth.uid === $uid"
           }
         },
         "transactions": {
           ".read": "auth != null",
           ".write": "auth != null"
         }
       }
     }
     Pou plis sekirite, limite ekriti pou verifye newData.child('uid').val() === auth.uid.
    ************************************/
  </script>
</body>
  </html>
