<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Echanj Plus ‚Äî v5.0.1</title>
<style>
  :root{
    --bg:#ffffff; --panel:#0b1220; --card:#ffffff; --accent:#0066ff;
    --muted:#6b7280; --success:#16a34a; --danger:#ef4444; --radius:12px;
    font-family:Inter,system-ui,Arial,sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:linear-gradient(180deg,#f7f9fc,var(--bg));color:#0b1220}
  /* Fullscreen auth overlay */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.80);display:flex;align-items:center;justify-content:center;z-index:9999}
  .auth-card{width:420px;max-width:96%;background:#fff;padding:20px;border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,0.35)}
  h1,h2{margin:0}
  h1{color:var(--accent);font-size:20px;margin-bottom:8px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;margin-top:8px;font-size:14px}
  button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--muted)}
  .small{font-size:13px;color:var(--muted);margin-top:8px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(11,18,32,0.03);font-size:13px}
  /* Layout after auth */
  .topbar{height:60px;background:var(--accent);color:#fff;display:flex;align-items:center;padding:0 16px;position:fixed;left:0;right:0;top:0;z-index:50}
  .menu-btn{font-size:22px;cursor:pointer;margin-right:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .container{display:flex;margin-top:60px;height:calc(100vh - 60px)}
  .sidebar{width:260px;background:#071022;color:#e6eef8;padding:18px;border-right:1px solid rgba(255,255,255,0.03);overflow:auto}
  .sidebar .item{padding:10px;border-radius:8px;cursor:pointer;margin-bottom:8px}
  .sidebar .item:hover{background:rgba(255,255,255,0.04)}
  .main{flex:1;padding:20px;overflow:auto}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.04);border:1px solid rgba(2,6,23,0.03);color:#0b1220}
  .row{display:flex;gap:8px}
  .tx-list{max-height:320px;overflow:auto;margin-top:10px}
  .tx-item{padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.04);margin-bottom:8px;background:#fbfdff}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 6px 24px rgba(2,6,23,0.3);display:none;z-index:99999}
  .stars{display:flex;gap:6px;align-items:center}
  .star{font-size:22px;cursor:pointer;color:lightgray}
  .star.active{color:gold}
  .muted{color:var(--muted)}
  .hide{display:none !important}
  /* Responsive */
  @media (max-width:880px){ .container{flex-direction:column} .sidebar{width:100%;height:auto;order:2} .main{order:1} }
</style>
</head>
<body>

<!-- AUTH overlay (full screen) -->
<div id="authOverlay" class="overlay" aria-hidden="false">
  <div class="auth-card" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Echanj Plus</h1>
      <div class="pill">v5.0.1</div>
    </div>

    <!-- mode tabs -->
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="tabLogin" class="btn-ghost" style="flex:1">Konekte</button>
      <button id="tabSignup" class="btn-ghost" style="flex:1">Enskri</button>
    </div>

    <!-- login form -->
    <div id="loginForm" style="margin-top:12px">
      <label>Im√®l</label><input id="loginEmail" type="email" placeholder="imel@egzanp.com"/>
      <label>Modpas</label><input id="loginPass" type="password" placeholder="Modpas"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnLogin" class="btn-primary" style="flex:1">Konekte</button>
        <button id="btnGuest" class="btn-ghost">Teste</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <a id="forgotLink" href="#" class="small">Mwen bliye modpas</a>
        <div id="loginMsg" class="small muted"></div>
      </div>
    </div>

    <!-- signup form -->
    <div id="signupForm" class="hide" style="margin-top:12px">
      <label>Non konpl√®</label><input id="signupName" type="text" placeholder="Non ou"/>
      <label>Telef√≤n (+509...)</label><input id="signupPhone" type="tel" placeholder="+509XXXXXXXX"/>
      <label>Chwazi s√®ks</label>
      <select id="signupGender"><option value="">--Chwazi--</option><option value="gason">Gason</option><option value="fi">Fi</option></select>
      <label>Im√®l</label><input id="signupEmail" type="email" placeholder="imel@egzanp.com"/>
      <label>Modpas (Deben k√≤manse ak yon gwo l√®t)</label><input id="signupPass" type="password" placeholder="Modpas"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnSignup" class="btn-primary" style="flex:1">Enskri</button>
        <button id="btnCancelSignup" class="btn-ghost" style="flex:1">Anile</button>
      </div>
      <div id="signupMsg" class="small muted" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Topbar + app -->
<div class="topbar hide" id="topbar">
  <div class="menu-btn" id="menuBtn">‚ò∞</div>
  <div class="brand"><strong>Echanj Plus</strong></div>
  <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
    <div id="userBadge" class="pill muted">‚Äî</div>
    <button id="logoutBtn" class="btn-ghost">Dekonekte</button>
  </div>
</div>

<div class="container hide" id="app">
  <!-- sidebar -->
  <nav class="sidebar" id="sidebar">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="width:44px;height:44px;border-radius:8px;background:#081226"></div>
      <div>
        <div id="sidebarName" style="font-weight:700">Itilizat√®</div>
        <div id="sidebarPhone" class="muted" style="font-size:13px">‚Äî</div>
      </div>
    </div>

    <div class="item" data-section="dashboard">üè† Dashboard</div>
    <div class="item" data-section="profile">üë§ Profile</div>
    <div class="item" data-section="dialer">üìû Voye Minit</div>
    <div class="item" data-section="feedback">‚≠ê Evalyasyon</div>
    <div class="item" data-section="payment">üí≥ Peman</div>
    <div style="border-top:1px solid rgba(255,255,255,0.03);margin-top:12px;padding-top:12px">
      <div class="item" id="openWhats">üì© Kontakte ‚Äî WhatsApp</div>
      <div class="item" id="openTx">üìÇ Tranzaksyon</div>
      <div class="item" id="appSettings">‚öôÔ∏è Param√®t</div>
    </div>
  </nav>

  <!-- main -->
  <main class="main" id="main">
    <!-- Dashboard -->
    <section id="section-dashboard" class="card">
      <h2>Dashboard</h2>
      <p class="muted">Tout tranzaksyon ak k√≤mant√® ou ap par√®t anba la.</p>
      <div style="margin-top:12px" id="publicComments"></div>
    </section>

    <!-- Profile -->
    <section id="section-profile" class="card hide" style="margin-top:16px">
      <h2>Profile</h2>
      <label>Non konpl√®</label><input id="profileName" />
      <label>Telef√≤n</label><input id="profilePhoneInput" />
      <label>S√®ks</label>
      <select id="profileGender"><option value="">--Chwazi--</option><option value="gason">Gason</option><option value="fi">Fi</option></select>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveProfileBtn" class="btn-primary">Anrejistre</button>
        <button id="cancelProfileBtn" class="btn-ghost">Anile</button>
      </div>
      <div id="profileMsg" class="small muted" style="margin-top:8px"></div>
    </section>

    <!-- Dialer -->
    <section id="section-dialer" class="card hide" style="margin-top:16px">
      <h2>Voye Minit (USSD)</h2>
      <label>Telef√≤n ou (from)</label><input id="dialerFrom" placeholder="+509XXXXXXXX"/>
      <div class="row" style="margin-top:8px">
        <select id="dialOperator" style="flex:1">
          <option value="digicel">Digicel</option>
          <option value="natcom">Natcom</option>
        </select>
        <input id="dialAmount" type="number" placeholder="100" style="width:120px"/>
      </div>
      <div class="small" style="margin-top:10px">Fr√® sist√®m (17.5%): <strong id="dialFee">‚Äî</strong> ‚Ä¢ Ou resevwa: <strong id="dialReceive">‚Äî</strong></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="dialBtn" class="btn-primary">Ouvri Dialer ak Konpoze</button>
        <button id="previewBtn" class="btn-ghost">Preview</button>
      </div>

      <div id="dialGateMsg" class="small muted" style="margin-top:10px">Sist√®m ap tann verifikasyon transf√®.</div>
    </section>

    <!-- Feedback -->
    <section id="section-feedback" class="card hide" style="margin-top:16px">
      <h2>Evalye konfyans ou</h2>
      <div class="stars" id="starContainer" style="margin-top:8px">
        <span class="star" data-val="1">‚òÖ</span>
        <span class="star" data-val="2">‚òÖ</span>
        <span class="star" data-val="3">‚òÖ</span>
        <span class="star" data-val="4">‚òÖ</span>
        <span class="star" data-val="5">‚òÖ</span>
      </div>
      <label style="margin-top:10px">K√≤mant√®</label>
      <textarea id="feedbackText" placeholder="Ekri k√≤mant√® ou..."></textarea>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="publishFeedback" class="btn-primary">Pibliye</button>
        <button id="clearFeedback" class="btn-ghost">Efase</button>
      </div>
    </section>

    <!-- Payment -->
    <section id="section-payment" class="card hide" style="margin-top:16px">
      <h2>Peman</h2>
      <label>Chwazi met√≤d</label>
      <select id="paymentMethod">
        <option value="">--Chwazi--</option>
        <option value="moncash">MonCash</option>
        <option value="natcash">NatCash</option>
        <option value="parayaj_lakay">Paryaj Lakay</option>
        <option value="parayaj_pam">Paryaj Pam</option>
      </select>

      <div id="paymentFields" style="margin-top:10px"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="sendPaymentBtn" class="btn-primary">Voye sou WhatsApp & Sove</button>
      </div>
    </section>

    <!-- Transactions -->
    <section id="section-transactions" class="card hide" style="margin-top:16px">
      <h2>Tranzaksyon Ou</h2>
      <div id="txList" class="tx-list"></div>
    </section>

  </main>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, set, push, get, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

  // -------------- CONFIG (w ap itilize firebaseConfig ou te bay la) --------------
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.firebasestorage.app",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // constants
  const SYSTEM_DIGICEL = '+50947111123';
  const SYSTEM_NATCOM = '32160708';
  const FEE_RATE = 0.175; // 17.5%
  const WA_NUMBER = '50947111123'; // sistem whatsapp (no plus sign)

  // UI references
  const authOverlay = document.getElementById('authOverlay');
  const tabLogin = document.getElementById('tabLogin');
  const tabSignup = document.getElementById('tabSignup');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const btnGuest = document.getElementById('btnGuest');
  const btnCancelSignup = document.getElementById('btnCancelSignup');
  const loginMsg = document.getElementById('loginMsg');
  const signupMsg = document.getElementById('signupMsg');

  const topbar = document.getElementById('topbar');
  const appEl = document.getElementById('app');
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menuBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userBadge = document.getElementById('userBadge');
  const sidebarName = document.getElementById('sidebarName');
  const sidebarPhone = document.getElementById('sidebarPhone');

  // sections
  const sections = {
    dashboard: document.getElementById('section-dashboard'),
    profile: document.getElementById('section-profile'),
    dialer: document.getElementById('section-dialer'),
    feedback: document.getElementById('section-feedback'),
    payment: document.getElementById('section-payment'),
    transactions: document.getElementById('section-transactions')
  };

  // auth controls
  tabLogin.addEventListener('click', ()=> { loginForm.classList.remove('hide'); signupForm.classList.add('hide'); });
  tabSignup.addEventListener('click', ()=> { signupForm.classList.remove('hide'); loginForm.classList.add('hide'); });
  btnCancelSignup.addEventListener('click', ()=> { signupForm.classList.add('hide'); loginForm.classList.remove('hide'); });

  // helper UI
  function toast(msg, ms=3500){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
  function showAppForUser(user){
    authOverlay.style.display='none';
    topbar.classList.remove('hide'); appEl.classList.remove('hide');
    // load profile badge & lists
    loadUserProfile(user.uid);
    loadTransactions(user.uid);
    loadPublicComments();
  }
  function hideApp(){ authOverlay.style.display='flex'; topbar.classList.add('hide'); appEl.classList.add('hide'); }

  // Signup
  btnSignup.addEventListener('click', async ()=>{
    const name = document.getElementById('signupName').value.trim();
    const phone = document.getElementById('signupPhone').value.trim();
    const gender = document.getElementById('signupGender').value;
    const email = document.getElementById('signupEmail').value.trim();
    const pass = document.getElementById('signupPass').value;
    signupMsg.textContent = '';
    if(!name || !phone || !gender || !email || !pass){ signupMsg.textContent='Ranpli tout chan yo.'; signupMsg.style.color='salmon'; return; }
    if(!/^[A-Z]/.test(pass)){ signupMsg.textContent='Modpas dwe k√≤manse ak yon l√®t majiskil.'; signupMsg.style.color='salmon'; return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      // save profile
      await set(ref(db, `users/${cred.user.uid}`), { name, phone, gender, email, created: Date.now() });
      signupMsg.textContent = 'Enskripsyon reyisi!'; signupMsg.style.color='green';
      toast('Kont kreye. W ap konekte...');
      // update displayName
      await updateProfile(cred.user, { displayName: name }).catch(()=>null);
    }catch(e){ signupMsg.textContent = e.message; signupMsg.style.color='salmon'; console.error(e); }
  });

  // Login
  btnLogin.addEventListener('click', async ()=>{
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    loginMsg.textContent = '';
    if(!email || !pass){ loginMsg.textContent='Ranpli imel ak modpas.'; loginMsg.style.color='salmon'; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      loginMsg.textContent='Konekte...'; loginMsg.style.color='green';
      toast('Ou konekte av√®k siks√®');
    }catch(e){ loginMsg.textContent = e.message; loginMsg.style.color='salmon'; console.error(e); }
  });

  // Guest (test)
  btnGuest.addEventListener('click', ()=> {
    // create a temporary pseudo-user locally (no firebase auth)
    // NOTE: guest can't persist to firebase unless you implement anonymous auth
    toast('Guest mode: limitasyon aplike');
    // hide overlay and show app with guest label
    authOverlay.style.display='none'; topbar.classList.remove('hide'); appEl.classList.remove('hide');
    userBadge.textContent = 'Guest';
    sidebarName.textContent = 'Guest';
    sidebarPhone.textContent = '‚Äî';
  });

  // Reset password
  document.getElementById('forgotLink').addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = prompt('Antre imel ou pou resevwa yon lyen reset:');
    if(!email) return;
    try{ await sendPasswordResetEmail(auth, email); alert('Tcheke im√®l ou; lyen reset voye.'); }catch(e){ alert(e.message); }
  });

  // Logout
  logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); hideApp(); toast('Dekonekte'); });

  // onAuth
  onAuthStateChanged(auth, user => {
    if(user){
      // show app
      showAppForUser(user);
      // set badge
      userBadge.textContent = user.email || user.displayName || 'Itilizat√®';
    } else {
      hideApp();
    }
  });

  // Sidebar navigation
  document.querySelectorAll('.sidebar .item').forEach(el=>{
    el.addEventListener('click', ()=> {
      const sec = el.dataset.section;
      // hide all
      Object.values(sections).forEach(s=>s.classList.add('hide'));
      // show selection
      if(sec && sections[sec]) sections[sec].classList.remove('hide');
      // small visual
      document.querySelectorAll('.sidebar .item').forEach(i=>i.style.background='transparent');
      el.style.background='rgba(255,255,255,0.03)';
    });
  });
  // ensure dashboard visible by default after login
  // menu toggle for small screens
  menuBtn.addEventListener('click', ()=> sidebar.classList.toggle('hide'));

  // ------------------ PROFILE ------------------
  async function loadUserProfile(uid){
    try{
      const snap = await get(ref(db, `users/${uid}`));
      const data = snap.exists() ? snap.val() : {};
      sidebarName.textContent = data.name || (auth.currentUser && auth.currentUser.displayName) || 'Itilizat√®';
      sidebarPhone.textContent = data.phone || '‚Äî';
      // prefill profile form
      document.getElementById('profileName').value = data.name || '';
      document.getElementById('profilePhoneInput').value = data.phone || '';
      document.getElementById('profileGender').value = data.gender || '';
    }catch(e){ console.error('loadProfile', e); }
  }
  document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
    const name = document.getElementById('profileName').value.trim();
    const phone = document.getElementById('profilePhoneInput').value.trim();
    const gender = document.getElementById('profileGender').value;
    if(!name || !phone || !gender){ document.getElementById('profileMsg').textContent='Ranpli tout chan yo'; return; }
    try{
      const uid = auth.currentUser.uid;
      await set(ref(db, `users/${uid}`), { name, phone, gender, email: auth.currentUser.email, updated: Date.now() });
      document.getElementById('profileMsg').textContent='Profile sove ‚úì'; document.getElementById('profileMsg').style.color='green';
      sidebarName.textContent = name; sidebarPhone.textContent = phone;
      await updateProfile(auth.currentUser, { displayName: name }).catch(()=>null);
    }catch(e){ document.getElementById('profileMsg').textContent = e.message; }
  });

  /
